import { Component, ViewChild } from '@angular/core';
import { Router } from '@angular/router';
import { PoI18nPipe, PoLanguageService } from '@po-ui/ng-components';
import { isExternalLink } from '../../utils/util';
import { PoModalPasswordRecoveryBaseComponent } from './po-modal-password-recovery-base.component';
import { PoModalPasswordRecoveryModalContent } from './enums/po-modal-password-recovery-modal-content.enum';
import { PoModalPasswordRecoveryService } from './po-modal-password-recovery.service';
import { PoModalPasswordRecoveryType } from './enums/po-modal-password-recovery-type.enum';
/**
 * @docsExtends PoModalPasswordRecoveryBaseComponent
 *
 * @example
 *
 * <example name="po-modal-password-recovery-basic" title="PO Modal Password Recovery Basic">
 *  <file name="sample-po-modal-password-recovery-basic/sample-po-modal-password-recovery-basic.component.html"> </file>
 *  <file name="sample-po-modal-password-recovery-basic/sample-po-modal-password-recovery-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-modal-password-recovery-labs" title="PO Modal Password Recovery Labs">
 *  <file name="sample-po-modal-password-recovery-labs/sample-po-modal-password-recovery-labs.component.html"> </file>
 *  <file name="sample-po-modal-password-recovery-labs/sample-po-modal-password-recovery-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-modal-password-recovery-request" title="PO Modal Password Recovery Request">
 *  <file name="sample-po-modal-password-recovery-request/sample-po-modal-password-recovery-request.component.html"> </file>
 *  <file name="sample-po-modal-password-recovery-request/sample-po-modal-password-recovery-request.component.ts"> </file>
 * </example>
 */
export class PoModalPasswordRecoveryComponent extends PoModalPasswordRecoveryBaseComponent {
    constructor(router, poI18nPipe, poModalPasswordRecoveryService, poLanguageService) {
        super(poLanguageService);
        this.router = router;
        this.poI18nPipe = poI18nPipe;
        this.poModalPasswordRecoveryService = poModalPasswordRecoveryService;
        this.chosenTypeFormOption = PoModalPasswordRecoveryType.Email;
        this.codeMask = '9 9 9 9 9 9';
        this.emailModal = true;
        this.emailModalPhrases = { firstPhrase: null, secondPhrase: null };
        this.endpoint = '.';
        this.invalidCode = false;
        this.invalidEmail = false;
        this.modalType = PoModalPasswordRecoveryModalContent.Email;
        this.submittedCodeValue = {};
        this.submittedContactValue = {};
        this.primaryAction = { label: undefined, action: () => { } };
        this.secondaryAction = { label: undefined, action: () => { } };
        this.typeFormOptions = [
            { label: 'e-mail', value: PoModalPasswordRecoveryType.Email },
            { label: 'SMS', value: PoModalPasswordRecoveryType.SMS }
        ];
    }
    ngOnDestroy() {
        if (this.passwordRecoverySubscription) {
            this.passwordRecoverySubscription.unsubscribe();
        }
        if (this.smsCodeSubscription) {
            this.smsCodeSubscription.unsubscribe();
        }
    }
    completed() {
        this.cancelAction();
    }
    formModelChangesCheck(form) {
        const invalidForm = form.invalid;
        this.invalidEmail = invalidForm && form.dirty;
        this.primaryAction.disabled = invalidForm;
        if (this.modalType === PoModalPasswordRecoveryModalContent.SMSCode) {
            const codeError = this.codeError !== undefined && this.codeError !== '';
            this.showCustomCodeError = codeError && form.pristine;
        }
    }
    getInputType(type) {
        this.type = type;
        this.pipeModalPhrases();
        setTimeout(() => {
            this.control = this.emailForm.controls[type];
            this.formModelChangesCheck(this.emailForm);
            this.resetFormFields(this.control);
        });
    }
    open() {
        const control = this.checkFormType(this.type);
        this.control = this.emailForm.controls[control];
        this.setEmailModalPhrasesAndActions();
        this.formModelChangesCheck(this.emailForm);
        this.recoveryModalElement.open();
    }
    openConfirmation() {
        this.modalTitle = this.literals.emailSentTitle;
        this.modalType = PoModalPasswordRecoveryModalContent.Confirmation;
        this.setActions(this.cancelAction, this.literals.closeButton, this.submitAction, this.literals.resendEmailButton, false);
    }
    openSmsCode() {
        this.modalTitle = this.literals.typeCodeTitle;
        this.modalType = PoModalPasswordRecoveryModalContent.SMSCode;
        this.setActions(this.submitSmsCodeAction, this.literals.continueButton, this.cancelAction, this.literals.cancelButton, true);
        setTimeout(() => {
            this.control = this.smsCodeForm.controls['sms'];
            this.formModelChangesCheck(this.smsCodeForm);
        });
    }
    resendSmsCode() {
        this.incrementRetryAttempts();
        if (this.urlRecovery) {
            this.submitActionRequest(this.submittedContactValue, this.type);
        }
        else {
            this.submit.emit(this.submittedContactValue);
        }
    }
    assignSmsResponse(responseObj) {
        this.smsBodyResponse = Object.assign({}, { hash: responseObj.hash });
        if (responseObj.urlValidationCode) {
            this.smsBodyResponse = Object.assign(this.smsBodyResponse, { urlValidationCode: responseObj.urlValidationCode });
        }
    }
    cancelAction() {
        this.resetFormFields(this.control);
        this.submittedContactValue = {};
        this.chosenTypeFormOption = PoModalPasswordRecoveryType.Email;
        this.modalType = PoModalPasswordRecoveryModalContent.Email;
        this.type = this.modalPasswordRecoveryTypeAll ? PoModalPasswordRecoveryType.All : this.type;
        this.recoveryModalElement.close();
    }
    checkFormType(type) {
        return type !== PoModalPasswordRecoveryType.All ? type : PoModalPasswordRecoveryType.Email;
    }
    formReset(control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    }
    getEmitValue(type) {
        return type === PoModalPasswordRecoveryType.SMS ? this.phone : this.email;
    }
    incrementRetryAttempts() {
        this.submittedContactValue.retry = this.submittedContactValue.retry + 1 || 1;
    }
    openExternalLink(url, queryParam) {
        window.open(`${url}?token=${queryParam}`, '_self');
    }
    openInternalLink(url, endpoint, queryParam) {
        this.router.navigate([`${url}/${endpoint}`], { queryParams: { token: queryParam } });
    }
    pipeModalPhrases() {
        if (this.type === PoModalPasswordRecoveryType.SMS) {
            this.emailModalPhrases.firstPhrase = this.setPipeArguments(this.literals.recoveryPasswordPhrase, this.literals.sms);
            this.emailModalPhrases.secondPhrase = this.setPipeArguments(this.literals.supportContact, this.literals.telephone);
        }
        else {
            this.emailModalPhrases.firstPhrase = this.setPipeArguments(this.literals.recoveryPasswordPhrase, this.literals.email);
            this.emailModalPhrases.secondPhrase = this.setPipeArguments(this.literals.supportContact, this.literals.email);
        }
    }
    redirectToChangePassword(recoveryToken) {
        const urlChangePassword = recoveryToken.urlChangePassword;
        if (urlChangePassword) {
            isExternalLink(urlChangePassword)
                ? this.openExternalLink(urlChangePassword, recoveryToken.token)
                : this.openInternalLink(this.urlRecovery, urlChangePassword, recoveryToken.token);
        }
        else {
            const changePasswordEndpoint = 'changePassword';
            this.openInternalLink(this.urlRecovery, changePasswordEndpoint, recoveryToken.token);
        }
    }
    resetFormFields(control) {
        this.formReset(control);
        this.email = undefined;
        this.phone = undefined;
        this.smsCode = undefined;
    }
    setActions(primaryAction, primarylabel, secondaryAction, secondaryLabel, disabled) {
        this.primaryAction.action = () => primaryAction.call(this);
        this.primaryAction.label = primarylabel;
        this.secondaryAction.action = () => secondaryAction.call(this);
        this.secondaryAction.label = secondaryLabel;
        this.primaryAction.disabled = disabled;
    }
    setEmailModalPhrasesAndActions() {
        this.modalTitle = this.literals.forgotPasswordTitle;
        this.pipeModalPhrases();
        this.modalPasswordRecoveryTypeAll = this.type === PoModalPasswordRecoveryType.All;
        this.setActions(this.submitAction, this.literals.sendButton, this.cancelAction, this.literals.cancelButton, true);
    }
    setRequestEndpoint(urlValidationCode) {
        const endpoint = urlValidationCode || 'validation';
        return `${this.urlRecovery}/${endpoint}`;
    }
    setPipeArguments(literalAttr, arg) {
        return this.poI18nPipe.transform(literalAttr, arg);
    }
    submitAction() {
        this.modalType === PoModalPasswordRecoveryModalContent.Confirmation
            ? this.incrementRetryAttempts()
            : this.formReset(this.control);
        this.submittedContactValue[this.checkFormType(this.type)] = this.getEmitValue(this.type);
        if (this.urlRecovery) {
            this.submitActionRequest(this.submittedContactValue, this.type);
        }
        else {
            this.submit.emit(this.submittedContactValue);
        }
    }
    submitActionRequest(data, modalType) {
        const params = modalType === PoModalPasswordRecoveryType.SMS ? { type: 'sms' } : undefined;
        this.passwordRecoverySubscription = this.poModalPasswordRecoveryService
            .post(this.urlRecovery, data, params)
            .subscribe(response => {
            if ((modalType === PoModalPasswordRecoveryType.Email || modalType === PoModalPasswordRecoveryType.All) &&
                response.status === 204) {
                this.openConfirmation();
            }
            else if (modalType === PoModalPasswordRecoveryType.SMS && response.status === 200) {
                this.assignSmsResponse(response.body);
                this.openSmsCode();
            }
        });
    }
    submitSmsCodeAction() {
        this.submittedCodeValue.code = this.smsCode;
        if (this.urlRecovery) {
            this.submittedCodeValue = Object.assign(this.submittedCodeValue, { hash: this.smsBodyResponse.hash });
            this.submitSmsCodeRequest(this.submittedCodeValue);
        }
        else {
            this.codeSubmit.emit(this.submittedCodeValue);
        }
        this.resetFormFields(this.control);
    }
    submitSmsCodeRequest(data) {
        this.smsCodeSubscription = this.poModalPasswordRecoveryService
            .post(this.setRequestEndpoint(this.smsBodyResponse.urlValidationCode), data)
            .subscribe(response => {
            const successStatus = response.status === 200;
            if (successStatus) {
                this.completed();
                this.redirectToChangePassword(response.body);
            }
        }, error => {
            this.codeError = error.error.message;
            this.openSmsCode();
        });
    }
}
PoModalPasswordRecoveryComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-modal-password-recovery',
                template: "<po-modal\n  #recoveryModal\n  p-hide-close\n  p-size=\"auto\"\n  [ngSwitch]=\"modalType\"\n  [p-primary-action]=\"primaryAction\"\n  [p-secondary-action]=\"secondaryAction\"\n  [p-title]=\"modalTitle\"\n>\n  <div class=\"po-modal-password-recovery-wrapper\">\n    <div *ngSwitchCase=\"'email'\" class=\"po-modal-password-recovery-content po-row\">\n      <div class=\"po-modal-password-recovery-text po-md-12 po-mb-1\">\n        {{ emailModalPhrases.firstPhrase }}\n      </div>\n      <div class=\"po-mb-2 po-md-12\">\n        <form #emailForm=\"ngForm\">\n          <div *ngIf=\"modalPasswordRecoveryTypeAll\">\n            <po-radio-group\n              name=\"type\"\n              [(ngModel)]=\"chosenTypeFormOption\"\n              [p-options]=\"typeFormOptions\"\n              (p-change)=\"getInputType($event)\"\n            >\n            </po-radio-group>\n          </div>\n\n          <div class=\"po-mt-1\">\n            <po-email\n              *ngIf=\"type === 'email' || type === 'all'\"\n              name=\"email\"\n              [(ngModel)]=\"email\"\n              p-required\n              [p-label]=\"literals.insertEmail\"\n              (p-change-model)=\"formModelChangesCheck(emailForm)\"\n            >\n            </po-email>\n\n            <po-input\n              *ngIf=\"type === 'sms'\"\n              name=\"sms\"\n              [(ngModel)]=\"phone\"\n              p-icon=\"po-icon-telephone\"\n              p-required\n              [p-label]=\"literals.insertPhone\"\n              [p-mask]=\"phoneMask\"\n              [p-maxlength]=\"maxLength\"\n              [p-minlength]=\"minLength\"\n              (p-change-model)=\"formModelChangesCheck(emailForm)\"\n            >\n            </po-input>\n          </div>\n\n          <div class=\"po-field-container-bottom po-field-container-error-container\">\n            <po-modal-password-recovery-error-message\n              *ngIf=\"invalidEmail && control.dirty\"\n              [p-text]=\"type === 'sms' ? literals.phoneErrorMessagePhrase : literals.emailErrorMessagePhrase\"\n            >\n            </po-modal-password-recovery-error-message>\n          </div>\n        </form>\n      </div>\n      <div class=\"po-modal-password-recovery-text po-md-12\">\n        {{ emailModalPhrases.secondPhrase }}\n        <span *ngIf=\"contactEmail\">\n          {{ literals.prepositionIn }}\n          <a class=\"po-modal-password-recovery-link\" href=\"mailto:{{ contactEmail }}\" target=\"_self\">\n            {{ contactEmail }}\n          </a>\n        </span>\n        {{ endpoint }}\n      </div>\n    </div>\n\n    <div #smsCodeModal *ngSwitchCase=\"'smsCode'\" class=\"po-modal-password-recovery-content po-row\">\n      <div class=\"po-modal-password-recovery-text po-md-12 po-mb-1\">{{ literals.sentSmsCodePhrase }}</div>\n      <div class=\"po-mb-2 po-md-12\">\n        <form #smsCodeForm=\"ngForm\">\n          <po-input\n            name=\"sms\"\n            [(ngModel)]=\"smsCode\"\n            p-maxlength=\"11\"\n            p-minlength=\"11\"\n            p-required\n            [p-label]=\"literals.insertCode\"\n            [p-mask]=\"codeMask\"\n            (p-change-model)=\"formModelChangesCheck(smsCodeForm)\"\n          >\n          </po-input>\n          <div class=\"po-field-container-bottom po-field-container-error-container\">\n            <po-modal-password-recovery-error-message\n              *ngIf=\"invalidEmail\"\n              [p-text]=\"smsCodeErrorMessage || this.literals.smsCodeErrorMessagePhrase\"\n            >\n            </po-modal-password-recovery-error-message>\n            <po-modal-password-recovery-error-message *ngIf=\"showCustomCodeError\" [p-text]=\"codeError\">\n            </po-modal-password-recovery-error-message>\n          </div>\n        </form>\n      </div>\n      <div class=\"po-modal-password-recovery-text po-md-12\">\n        {{ literals.sendAgainPhrase }}\n        <span class=\"po-modal-password-recovery-link\" (click)=\"resendSmsCode()\">{{ literals.sendAgain }}</span>\n      </div>\n    </div>\n\n    <div #confirmationModal *ngSwitchCase=\"'confirmation'\" class=\"po-modal-password-recovery-content po-row\">\n      <img class=\"po-modal-password-recovery-user-image po-mb-2\" src=\"./assets/images/email-sent.svg\" />\n      <div class=\"po-modal-password-recovery-text\">\n        {{ literals.emailSentConfirmationPhrase }}\n      </div>\n    </div>\n  </div>\n</po-modal>\n"
            },] }
];
PoModalPasswordRecoveryComponent.ctorParameters = () => [
    { type: Router },
    { type: PoI18nPipe },
    { type: PoModalPasswordRecoveryService },
    { type: PoLanguageService }
];
PoModalPasswordRecoveryComponent.propDecorators = {
    emailForm: [{ type: ViewChild, args: ['emailForm',] }],
    recoveryModalElement: [{ type: ViewChild, args: ['recoveryModal', { static: true },] }],
    smsCodeForm: [{ type: ViewChild, args: ['smsCodeForm',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdGVtcGxhdGVzL3NyYy9saWIvY29tcG9uZW50cy9wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS9wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBR3pDLE9BQU8sRUFDTCxVQUFVLEVBQ1YsaUJBQWlCLEVBSWxCLE1BQU0sc0JBQXNCLENBQUM7QUFFOUIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBR2xELE9BQU8sRUFBRSxvQ0FBb0MsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBQ25HLE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxNQUFNLHVEQUF1RCxDQUFDO0FBQzVHLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3RGLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBRTNGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHO0FBTUgsTUFBTSxPQUFPLGdDQUFpQyxTQUFRLG9DQUFvQztJQW1DeEYsWUFDVSxNQUFjLEVBQ2QsVUFBc0IsRUFDdEIsOEJBQThELEVBQ3RFLGlCQUFvQztRQUVwQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUxqQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixtQ0FBOEIsR0FBOUIsOEJBQThCLENBQWdDO1FBL0J4RSx5QkFBb0IsR0FBVywyQkFBMkIsQ0FBQyxLQUFLLENBQUM7UUFDakUsYUFBUSxHQUFX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QUFHLFFBQVEsQ0FBQyxNQUFNLEtBQUssR0FBRyxDQUFDO1lBQzlDLElBQUksYUFBYSxFQUFFO2dCQUNqQixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ2pCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDOUM7UUFDSCxDQUFDLEVBQ0QsS0FBSyxDQUFDLEVBQUU7WUFDTixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQixDQUFDLENBQ0YsQ0FBQztJQUNOLENBQUM7OztZQXJTRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLDRCQUE0QjtnQkFDdEMsZzNJQUEwRDthQUMzRDs7O1lBM0NRLE1BQU07WUFJYixVQUFVO1lBWUgsOEJBQThCO1lBWHJDLGlCQUFpQjs7O3dCQXdDaEIsU0FBUyxTQUFDLFdBQVc7bUNBRXJCLFNBQVMsU0FBQyxlQUFlLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzBCQUUzQyxTQUFTLFNBQUMsYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25EZXN0cm95LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICBQb0kxOG5QaXBlLFxuICBQb0xhbmd1YWdlU2VydmljZSxcbiAgUG9Nb2RhbEFjdGlvbixcbiAgUG9Nb2RhbENvbXBvbmVudCxcbiAgUG9SYWRpb0dyb3VwT3B0aW9uXG59IGZyb20gJ0Bwby11aS9uZy1jb21wb25lbnRzJztcblxuaW1wb3J0IHsgaXNFeHRlcm5hbExpbmsgfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcblxuaW1wb3J0IHsgUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnkgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5QmFzZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlNb2RhbENvbnRlbnQgfSBmcm9tICcuL2VudW1zL3BvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LW1vZGFsLWNvbnRlbnQuZW51bSc7XG5pbXBvcnQgeyBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVNlcnZpY2UgfSBmcm9tICcuL3BvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlUeXBlIH0gZnJvbSAnLi9lbnVtcy9wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS10eXBlLmVudW0nO1xuXG4vKipcbiAqIEBkb2NzRXh0ZW5kcyBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeUJhc2VDb21wb25lbnRcbiAqXG4gKiBAZXhhbXBsZVxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS1iYXNpY1wiIHRpdGxlPVwiUE8gTW9kYWwgUGFzc3dvcmQgUmVjb3ZlcnkgQmFzaWNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LWJhc2ljL3NhbXBsZS1wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS1iYXNpYy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS1iYXNpYy9zYW1wbGUtcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktYmFzaWMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktbGFic1wiIHRpdGxlPVwiUE8gTW9kYWwgUGFzc3dvcmQgUmVjb3ZlcnkgTGFic1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktbGFicy9zYW1wbGUtcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktbGFicy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS1sYWJzL3NhbXBsZS1wby1tb2RhbC1wYXNzd29yZC1yZWNvdmVyeS1sYWJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LXJlcXVlc3RcIiB0aXRsZT1cIlBPIE1vZGFsIFBhc3N3b3JkIFJlY292ZXJ5IFJlcXVlc3RcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LXJlcXVlc3Qvc2FtcGxlLXBvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LXJlcXVlc3QuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktcmVxdWVzdC9zYW1wbGUtcG8tbW9kYWwtcGFzc3dvcmQtcmVjb3ZlcnktcmVxdWVzdC5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLW1vZGFsLXBhc3N3b3JkLXJlY292ZXJ5LmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeUNvbXBvbmVudCBleHRlbmRzIFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5QmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIEBWaWV3Q2hpbGQoJ2VtYWlsRm9ybScpIGVtYWlsRm9ybTogTmdGb3JtO1xuXG4gIEBWaWV3Q2hpbGQoJ3JlY292ZXJ5TW9kYWwnLCB7IHN0YXRpYzogdHJ1ZSB9KSByZWNvdmVyeU1vZGFsRWxlbWVudDogUG9Nb2RhbENvbXBvbmVudDtcblxuICBAVmlld0NoaWxkKCdzbXNDb2RlRm9ybScpIHNtc0NvZGVGb3JtOiBOZ0Zvcm07XG5cbiAgY2hvc2VuVHlwZUZvcm1PcHRpb246IHN0cmluZyA9IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZS5FbWFpbDtcbiAgY29kZU1hc2s6IHN0cmluZyA9ICc5IDkgOSA5IDkgOSc7XG4gIGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbDtcbiAgZW1haWxNb2RhbDogYm9vbGVhbiA9IHRydWU7XG4gIGVtYWlsTW9kYWxQaHJhc2VzID0geyBmaXJzdFBocmFzZTogbnVsbCBhcyBzdHJpbmcsIHNlY29uZFBocmFzZTogbnVsbCBhcyBzdHJpbmcgfTtcbiAgZW5kcG9pbnQ6IHN0cmluZyA9ICcuJztcbiAgaW52YWxpZENvZGU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgaW52YWxpZEVtYWlsOiBib29sZWFuID0gZmFsc2U7XG4gIG1vZGFsVGl0bGU6IHN0cmluZztcbiAgbW9kYWxUeXBlOiBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeU1vZGFsQ29udGVudCA9IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5TW9kYWxDb250ZW50LkVtYWlsO1xuICBzaG93Q3VzdG9tQ29kZUVycm9yOiBib29sZWFuO1xuICBzbXNDb2RlRXJyb3JNZXNzYWdlUGhyYXNlOiBzdHJpbmc7XG4gIHN1Ym1pdHRlZENvZGVWYWx1ZSA9IHt9IGFzIFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5O1xuICBzdWJtaXR0ZWRDb250YWN0VmFsdWUgPSB7fSBhcyBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeTtcblxuICBwcmltYXJ5QWN0aW9uOiBQb01vZGFsQWN0aW9uID0geyBsYWJlbDogdW5kZWZpbmVkLCBhY3Rpb246ICgpID0+IHt9IH07XG5cbiAgc2Vjb25kYXJ5QWN0aW9uOiBQb01vZGFsQWN0aW9uID0geyBsYWJlbDogdW5kZWZpbmVkLCBhY3Rpb246ICgpID0+IHt9IH07XG5cbiAgdHlwZUZvcm1PcHRpb25zOiBBcnJheTxQb1JhZGlvR3JvdXBPcHRpb24+ID0gW1xuICAgIHsgbGFiZWw6ICdlLW1haWwnLCB2YWx1ZTogUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlUeXBlLkVtYWlsIH0sXG4gICAgeyBsYWJlbDogJ1NNUycsIHZhbHVlOiBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVR5cGUuU01TIH1cbiAgXTtcblxuICBwcml2YXRlIHBhc3N3b3JkUmVjb3ZlcnlTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBzbXNCb2R5UmVzcG9uc2U7XG4gIHByaXZhdGUgc21zQ29kZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBwb0kxOG5QaXBlOiBQb0kxOG5QaXBlLFxuICAgIHByaXZhdGUgcG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlTZXJ2aWNlOiBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVNlcnZpY2UsXG4gICAgcG9MYW5ndWFnZVNlcnZpY2U6IFBvTGFuZ3VhZ2VTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKHBvTGFuZ3VhZ2VTZXJ2aWNlKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnBhc3N3b3JkUmVjb3ZlcnlTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMucGFzc3dvcmRSZWNvdmVyeVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNtc0NvZGVTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuc21zQ29kZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBsZXRlZCgpIHtcbiAgICB0aGlzLmNhbmNlbEFjdGlvbigpO1xuICB9XG5cbiAgZm9ybU1vZGVsQ2hhbmdlc0NoZWNrKGZvcm06IE5nRm9ybSkge1xuICAgIGNvbnN0IGludmFsaWRGb3JtID0gZm9ybS5pbnZhbGlkO1xuICAgIHRoaXMuaW52YWxpZEVtYWlsID0gaW52YWxpZEZvcm0gJiYgZm9ybS5kaXJ0eTtcbiAgICB0aGlzLnByaW1hcnlBY3Rpb24uZGlzYWJsZWQgPSBpbnZhbGlkRm9ybTtcblxuICAgIGlmICh0aGlzLm1vZGFsVHlwZSA9PT0gUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlNb2RhbENvbnRlbnQuU01TQ29kZSkge1xuICAgICAgY29uc3QgY29kZUVycm9yOiBib29sZWFuID0gdGhpcy5jb2RlRXJyb3IgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmNvZGVFcnJvciAhPT0gJyc7XG4gICAgICB0aGlzLnNob3dDdXN0b21Db2RlRXJyb3IgPSBjb2RlRXJyb3IgJiYgZm9ybS5wcmlzdGluZTtcbiAgICB9XG4gIH1cblxuICBnZXRJbnB1dFR5cGUodHlwZSkge1xuICAgIHRoaXMudHlwZSA9IHR5cGU7XG4gICAgdGhpcy5waXBlTW9kYWxQaHJhc2VzKCk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmNvbnRyb2wgPSB0aGlzLmVtYWlsRm9ybS5jb250cm9sc1t0eXBlXTtcbiAgICAgIHRoaXMuZm9ybU1vZGVsQ2hhbmdlc0NoZWNrKHRoaXMuZW1haWxGb3JtKTtcbiAgICAgIHRoaXMucmVzZXRGb3JtRmllbGRzKHRoaXMuY29udHJvbCk7XG4gICAgfSk7XG4gIH1cblxuICBvcGVuKCkge1xuICAgIGNvbnN0IGNvbnRyb2wgPSB0aGlzLmNoZWNrRm9ybVR5cGUodGhpcy50eXBlKTtcbiAgICB0aGlzLmNvbnRyb2wgPSB0aGlzLmVtYWlsRm9ybS5jb250cm9sc1tjb250cm9sXTtcbiAgICB0aGlzLnNldEVtYWlsTW9kYWxQaHJhc2VzQW5kQWN0aW9ucygpO1xuICAgIHRoaXMuZm9ybU1vZGVsQ2hhbmdlc0NoZWNrKHRoaXMuZW1haWxGb3JtKTtcbiAgICB0aGlzLnJlY292ZXJ5TW9kYWxFbGVtZW50Lm9wZW4oKTtcbiAgfVxuXG4gIG9wZW5Db25maXJtYXRpb24oKSB7XG4gICAgdGhpcy5tb2RhbFRpdGxlID0gdGhpcy5saXRlcmFscy5lbWFpbFNlbnRUaXRsZTtcbiAgICB0aGlzLm1vZGFsVHlwZSA9IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5TW9kYWxDb250ZW50LkNvbmZpcm1hdGlvbjtcbiAgICB0aGlzLnNldEFjdGlvbnMoXG4gICAgICB0aGlzLmNhbmNlbEFjdGlvbixcbiAgICAgIHRoaXMubGl0ZXJhbHMuY2xvc2VCdXR0b24sXG4gICAgICB0aGlzLnN1Ym1pdEFjdGlvbixcbiAgICAgIHRoaXMubGl0ZXJhbHMucmVzZW5kRW1haWxCdXR0b24sXG4gICAgICBmYWxzZVxuICAgICk7XG4gIH1cblxuICBvcGVuU21zQ29kZSgpIHtcbiAgICB0aGlzLm1vZGFsVGl0bGUgPSB0aGlzLmxpdGVyYWxzLnR5cGVDb2RlVGl0bGU7XG4gICAgdGhpcy5tb2RhbFR5cGUgPSBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeU1vZGFsQ29udGVudC5TTVNDb2RlO1xuICAgIHRoaXMuc2V0QWN0aW9ucyhcbiAgICAgIHRoaXMuc3VibWl0U21zQ29kZUFjdGlvbixcbiAgICAgIHRoaXMubGl0ZXJhbHMuY29udGludWVCdXR0b24sXG4gICAgICB0aGlzLmNhbmNlbEFjdGlvbixcbiAgICAgIHRoaXMubGl0ZXJhbHMuY2FuY2VsQnV0dG9uLFxuICAgICAgdHJ1ZVxuICAgICk7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuY29udHJvbCA9IHRoaXMuc21zQ29kZUZvcm0uY29udHJvbHNbJ3NtcyddO1xuICAgICAgdGhpcy5mb3JtTW9kZWxDaGFuZ2VzQ2hlY2sodGhpcy5zbXNDb2RlRm9ybSk7XG4gICAgfSk7XG4gIH1cblxuICByZXNlbmRTbXNDb2RlKCkge1xuICAgIHRoaXMuaW5jcmVtZW50UmV0cnlBdHRlbXB0cygpO1xuICAgIGlmICh0aGlzLnVybFJlY292ZXJ5KSB7XG4gICAgICB0aGlzLnN1Ym1pdEFjdGlvblJlcXVlc3QodGhpcy5zdWJtaXR0ZWRDb250YWN0VmFsdWUsIHRoaXMudHlwZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3VibWl0LmVtaXQodGhpcy5zdWJtaXR0ZWRDb250YWN0VmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXNzaWduU21zUmVzcG9uc2UocmVzcG9uc2VPYmopIHtcbiAgICB0aGlzLnNtc0JvZHlSZXNwb25zZSA9IE9iamVjdC5hc3NpZ24oe30sIHsgaGFzaDogcmVzcG9uc2VPYmouaGFzaCB9KTtcbiAgICBpZiAocmVzcG9uc2VPYmoudXJsVmFsaWRhdGlvbkNvZGUpIHtcbiAgICAgIHRoaXMuc21zQm9keVJlc3BvbnNlID0gT2JqZWN0LmFzc2lnbih0aGlzLnNtc0JvZHlSZXNwb25zZSwgeyB1cmxWYWxpZGF0aW9uQ29kZTogcmVzcG9uc2VPYmoudXJsVmFsaWRhdGlvbkNvZGUgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjYW5jZWxBY3Rpb24oKSB7XG4gICAgdGhpcy5yZXNldEZvcm1GaWVsZHModGhpcy5jb250cm9sKTtcbiAgICB0aGlzLnN1Ym1pdHRlZENvbnRhY3RWYWx1ZSA9IHt9O1xuXG4gICAgdGhpcy5jaG9zZW5UeXBlRm9ybU9wdGlvbiA9IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZS5FbWFpbDtcbiAgICB0aGlzLm1vZGFsVHlwZSA9IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5TW9kYWxDb250ZW50LkVtYWlsO1xuICAgIHRoaXMudHlwZSA9IHRoaXMubW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZUFsbCA/IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZS5BbGwgOiB0aGlzLnR5cGU7XG4gICAgdGhpcy5yZWNvdmVyeU1vZGFsRWxlbWVudC5jbG9zZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0Zvcm1UeXBlKHR5cGU6IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZSkge1xuICAgIHJldHVybiB0eXBlICE9PSBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVR5cGUuQWxsID8gdHlwZSA6IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZS5FbWFpbDtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybVJlc2V0KGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCkge1xuICAgIGNvbnRyb2wubWFya0FzUHJpc3RpbmUoKTtcbiAgICBjb250cm9sLm1hcmtBc1VudG91Y2hlZCgpO1xuICAgIGNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRFbWl0VmFsdWUodHlwZTogUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlUeXBlKSB7XG4gICAgcmV0dXJuIHR5cGUgPT09IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZS5TTVMgPyB0aGlzLnBob25lIDogdGhpcy5lbWFpbDtcbiAgfVxuXG4gIHByaXZhdGUgaW5jcmVtZW50UmV0cnlBdHRlbXB0cygpIHtcbiAgICB0aGlzLnN1Ym1pdHRlZENvbnRhY3RWYWx1ZS5yZXRyeSA9IHRoaXMuc3VibWl0dGVkQ29udGFjdFZhbHVlLnJldHJ5ICsgMSB8fCAxO1xuICB9XG5cbiAgcHJpdmF0ZSBvcGVuRXh0ZXJuYWxMaW5rKHVybCwgcXVlcnlQYXJhbSkge1xuICAgIHdpbmRvdy5vcGVuKGAke3VybH0/dG9rZW49JHtxdWVyeVBhcmFtfWAsICdfc2VsZicpO1xuICB9XG5cbiAgcHJpdmF0ZSBvcGVuSW50ZXJuYWxMaW5rKHVybCwgZW5kcG9pbnQsIHF1ZXJ5UGFyYW0pIHtcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbYCR7dXJsfS8ke2VuZHBvaW50fWBdLCB7IHF1ZXJ5UGFyYW1zOiB7IHRva2VuOiBxdWVyeVBhcmFtIH0gfSk7XG4gIH1cblxuICBwcml2YXRlIHBpcGVNb2RhbFBocmFzZXMoKSB7XG4gICAgaWYgKHRoaXMudHlwZSA9PT0gUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlUeXBlLlNNUykge1xuICAgICAgdGhpcy5lbWFpbE1vZGFsUGhyYXNlcy5maXJzdFBocmFzZSA9IHRoaXMuc2V0UGlwZUFyZ3VtZW50cyhcbiAgICAgICAgdGhpcy5saXRlcmFscy5yZWNvdmVyeVBhc3N3b3JkUGhyYXNlLFxuICAgICAgICB0aGlzLmxpdGVyYWxzLnNtc1xuICAgICAgKTtcbiAgICAgIHRoaXMuZW1haWxNb2RhbFBocmFzZXMuc2Vjb25kUGhyYXNlID0gdGhpcy5zZXRQaXBlQXJndW1lbnRzKFxuICAgICAgICB0aGlzLmxpdGVyYWxzLnN1cHBvcnRDb250YWN0LFxuICAgICAgICB0aGlzLmxpdGVyYWxzLnRlbGVwaG9uZVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5lbWFpbE1vZGFsUGhyYXNlcy5maXJzdFBocmFzZSA9IHRoaXMuc2V0UGlwZUFyZ3VtZW50cyhcbiAgICAgICAgdGhpcy5saXRlcmFscy5yZWNvdmVyeVBhc3N3b3JkUGhyYXNlLFxuICAgICAgICB0aGlzLmxpdGVyYWxzLmVtYWlsXG4gICAgICApO1xuICAgICAgdGhpcy5lbWFpbE1vZGFsUGhyYXNlcy5zZWNvbmRQaHJhc2UgPSB0aGlzLnNldFBpcGVBcmd1bWVudHModGhpcy5saXRlcmFscy5zdXBwb3J0Q29udGFjdCwgdGhpcy5saXRlcmFscy5lbWFpbCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZWRpcmVjdFRvQ2hhbmdlUGFzc3dvcmQocmVjb3ZlcnlUb2tlbjogUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnkpIHtcbiAgICBjb25zdCB1cmxDaGFuZ2VQYXNzd29yZCA9IHJlY292ZXJ5VG9rZW4udXJsQ2hhbmdlUGFzc3dvcmQ7XG4gICAgaWYgKHVybENoYW5nZVBhc3N3b3JkKSB7XG4gICAgICBpc0V4dGVybmFsTGluayh1cmxDaGFuZ2VQYXNzd29yZClcbiAgICAgICAgPyB0aGlzLm9wZW5FeHRlcm5hbExpbmsodXJsQ2hhbmdlUGFzc3dvcmQsIHJlY292ZXJ5VG9rZW4udG9rZW4pXG4gICAgICAgIDogdGhpcy5vcGVuSW50ZXJuYWxMaW5rKHRoaXMudXJsUmVjb3ZlcnksIHVybENoYW5nZVBhc3N3b3JkLCByZWNvdmVyeVRva2VuLnRva2VuKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY2hhbmdlUGFzc3dvcmRFbmRwb2ludCA9ICdjaGFuZ2VQYXNzd29yZCc7XG4gICAgICB0aGlzLm9wZW5JbnRlcm5hbExpbmsodGhpcy51cmxSZWNvdmVyeSwgY2hhbmdlUGFzc3dvcmRFbmRwb2ludCwgcmVjb3ZlcnlUb2tlbi50b2tlbik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXNldEZvcm1GaWVsZHMoY29udHJvbCkge1xuICAgIHRoaXMuZm9ybVJlc2V0KGNvbnRyb2wpO1xuICAgIHRoaXMuZW1haWwgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5waG9uZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnNtc0NvZGUgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIHNldEFjdGlvbnMocHJpbWFyeUFjdGlvbiwgcHJpbWFyeWxhYmVsLCBzZWNvbmRhcnlBY3Rpb24sIHNlY29uZGFyeUxhYmVsLCBkaXNhYmxlZCkge1xuICAgIHRoaXMucHJpbWFyeUFjdGlvbi5hY3Rpb24gPSAoKSA9PiBwcmltYXJ5QWN0aW9uLmNhbGwodGhpcyk7XG4gICAgdGhpcy5wcmltYXJ5QWN0aW9uLmxhYmVsID0gcHJpbWFyeWxhYmVsO1xuICAgIHRoaXMuc2Vjb25kYXJ5QWN0aW9uLmFjdGlvbiA9ICgpID0+IHNlY29uZGFyeUFjdGlvbi5jYWxsKHRoaXMpO1xuICAgIHRoaXMuc2Vjb25kYXJ5QWN0aW9uLmxhYmVsID0gc2Vjb25kYXJ5TGFiZWw7XG4gICAgdGhpcy5wcmltYXJ5QWN0aW9uLmRpc2FibGVkID0gZGlzYWJsZWQ7XG4gIH1cblxuICBwcml2YXRlIHNldEVtYWlsTW9kYWxQaHJhc2VzQW5kQWN0aW9ucygpIHtcbiAgICB0aGlzLm1vZGFsVGl0bGUgPSB0aGlzLmxpdGVyYWxzLmZvcmdvdFBhc3N3b3JkVGl0bGU7XG4gICAgdGhpcy5waXBlTW9kYWxQaHJhc2VzKCk7XG4gICAgdGhpcy5tb2RhbFBhc3N3b3JkUmVjb3ZlcnlUeXBlQWxsID0gdGhpcy50eXBlID09PSBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVR5cGUuQWxsO1xuICAgIHRoaXMuc2V0QWN0aW9ucyh0aGlzLnN1Ym1pdEFjdGlvbiwgdGhpcy5saXRlcmFscy5zZW5kQnV0dG9uLCB0aGlzLmNhbmNlbEFjdGlvbiwgdGhpcy5saXRlcmFscy5jYW5jZWxCdXR0b24sIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRSZXF1ZXN0RW5kcG9pbnQodXJsVmFsaWRhdGlvbkNvZGU/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBlbmRwb2ludCA9IHVybFZhbGlkYXRpb25Db2RlIHx8ICd2YWxpZGF0aW9uJztcblxuICAgIHJldHVybiBgJHt0aGlzLnVybFJlY292ZXJ5fS8ke2VuZHBvaW50fWA7XG4gIH1cblxuICBwcml2YXRlIHNldFBpcGVBcmd1bWVudHMobGl0ZXJhbEF0dHI6IHN0cmluZywgYXJnOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5wb0kxOG5QaXBlLnRyYW5zZm9ybShsaXRlcmFsQXR0ciwgYXJnKTtcbiAgfVxuXG4gIHByaXZhdGUgc3VibWl0QWN0aW9uKCkge1xuICAgIHRoaXMubW9kYWxUeXBlID09PSBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeU1vZGFsQ29udGVudC5Db25maXJtYXRpb25cbiAgICAgID8gdGhpcy5pbmNyZW1lbnRSZXRyeUF0dGVtcHRzKClcbiAgICAgIDogdGhpcy5mb3JtUmVzZXQodGhpcy5jb250cm9sKTtcbiAgICB0aGlzLnN1Ym1pdHRlZENvbnRhY3RWYWx1ZVt0aGlzLmNoZWNrRm9ybVR5cGUodGhpcy50eXBlKV0gPSB0aGlzLmdldEVtaXRWYWx1ZSh0aGlzLnR5cGUpO1xuICAgIGlmICh0aGlzLnVybFJlY292ZXJ5KSB7XG4gICAgICB0aGlzLnN1Ym1pdEFjdGlvblJlcXVlc3QodGhpcy5zdWJtaXR0ZWRDb250YWN0VmFsdWUsIHRoaXMudHlwZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3VibWl0LmVtaXQodGhpcy5zdWJtaXR0ZWRDb250YWN0VmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3VibWl0QWN0aW9uUmVxdWVzdChkYXRhOiBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeSwgbW9kYWxUeXBlOiBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVR5cGUpIHtcbiAgICBjb25zdCBwYXJhbXMgPSBtb2RhbFR5cGUgPT09IFBvTW9kYWxQYXNzd29yZFJlY292ZXJ5VHlwZS5TTVMgPyB7IHR5cGU6ICdzbXMnIH0gOiB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLnBhc3N3b3JkUmVjb3ZlcnlTdWJzY3JpcHRpb24gPSB0aGlzLnBvTW9kYWxQYXNzd29yZFJlY292ZXJ5U2VydmljZVxuICAgICAgLnBvc3QodGhpcy51cmxSZWNvdmVyeSwgZGF0YSwgcGFyYW1zKVxuICAgICAgLnN1YnNjcmliZShyZXNwb25zZSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAobW9kYWxUeXBlID09PSBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVR5cGUuRW1haWwgfHwgbW9kYWxUeXBlID09PSBQb01vZGFsUGFzc3dvcmRSZWNvdmVyeVR5cGUuQWxsKSAmJlxuICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9PT0gMjA0XG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMub3BlbkNvbmZpcm1hdGlvbigpO1xuICAgICAgICB9IGVsc2UgaWYgKG1vZGFsVHlwZSA9PT0gUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnlUeXBlLlNNUyAmJiByZXNwb25zZS5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgIHRoaXMuYXNzaWduU21zUmVzcG9uc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgdGhpcy5vcGVuU21zQ29kZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc3VibWl0U21zQ29kZUFjdGlvbigpIHtcbiAgICB0aGlzLnN1Ym1pdHRlZENvZGVWYWx1ZS5jb2RlID0gdGhpcy5zbXNDb2RlO1xuXG4gICAgaWYgKHRoaXMudXJsUmVjb3ZlcnkpIHtcbiAgICAgIHRoaXMuc3VibWl0dGVkQ29kZVZhbHVlID0gT2JqZWN0LmFzc2lnbih0aGlzLnN1Ym1pdHRlZENvZGVWYWx1ZSwgeyBoYXNoOiB0aGlzLnNtc0JvZHlSZXNwb25zZS5oYXNoIH0pO1xuICAgICAgdGhpcy5zdWJtaXRTbXNDb2RlUmVxdWVzdCh0aGlzLnN1Ym1pdHRlZENvZGVWYWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29kZVN1Ym1pdC5lbWl0KHRoaXMuc3VibWl0dGVkQ29kZVZhbHVlKTtcbiAgICB9XG4gICAgdGhpcy5yZXNldEZvcm1GaWVsZHModGhpcy5jb250cm9sKTtcbiAgfVxuXG4gIHByaXZhdGUgc3VibWl0U21zQ29kZVJlcXVlc3QoZGF0YTogUG9Nb2RhbFBhc3N3b3JkUmVjb3ZlcnkpIHtcbiAgICB0aGlzLnNtc0NvZGVTdWJzY3JpcHRpb24gPSB0aGlzLnBvTW9kYWxQYXNzd29yZFJlY292ZXJ5U2VydmljZVxuICAgICAgLnBvc3QodGhpcy5zZXRSZXF1ZXN0RW5kcG9pbnQodGhpcy5zbXNCb2R5UmVzcG9uc2UudXJsVmFsaWRhdGlvbkNvZGUpLCBkYXRhKVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgIGNvbnN0IHN1Y2Nlc3NTdGF0dXMgPSByZXNwb25zZS5zdGF0dXMgPT09IDIwMDtcbiAgICAgICAgICBpZiAoc3VjY2Vzc1N0YXR1cykge1xuICAgICAgICAgICAgdGhpcy5jb21wbGV0ZWQoKTtcbiAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0NoYW5nZVBhc3N3b3JkKHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIHRoaXMuY29kZUVycm9yID0gZXJyb3IuZXJyb3IubWVzc2FnZTtcbiAgICAgICAgICB0aGlzLm9wZW5TbXNDb2RlKCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cbn1cbiJdfQ==