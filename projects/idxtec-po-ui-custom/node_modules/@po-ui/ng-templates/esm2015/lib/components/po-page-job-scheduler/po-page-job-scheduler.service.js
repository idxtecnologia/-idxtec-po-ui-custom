import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
export class PoPageJobSchedulerService {
    constructor(http) {
        this.http = http;
        this.headers = new HttpHeaders({
            'X-PO-SCREEN-LOCK': 'true'
        });
        this.endpoint = '/';
    }
    configServiceApi(config = {}) {
        this.endpoint = config.endpoint;
    }
    // Cria um recurso
    createResource(resource) {
        const newResouce = this.convertToJobScheduler(resource);
        return this.http.post(`${this.endpoint}`, newResouce, { headers: this.headers });
    }
    getHeadProcesses() {
        const headers = { 'X-PO-No-Error': 'true' };
        return this.http.head(`${this.endpoint}/processes`, { headers });
    }
    // Busca parametros pelo processo id
    getParametersByProcess(processId) {
        return this.http
            .get(`${this.endpoint}/processes/${processId}/parameters`, { headers: this.headers })
            .pipe(map((resource) => resource.items));
    }
    // Busca um único recurso
    getProcess(id) {
        return this.http.get(`${this.endpoint}/processes/${id}`, { headers: this.headers });
    }
    // Busca uma lista de processos
    getProcesses(params = {}) {
        return this.http.get(`${this.endpoint}/processes`, { params });
    }
    // Busca um único recurso
    getResource(id) {
        return this.http
            .get(`${this.endpoint}/${id}`, { headers: this.headers })
            .pipe(map(resource => this.convertToJobSchedulerInternal(resource)));
    }
    // Atualiza um recurso
    updateResource(id, resource) {
        const newResouce = this.convertToJobScheduler(resource);
        return this.http.put(`${this.endpoint}/${id}`, newResouce, { headers: this.headers });
    }
    convertToJobScheduler(jobSchedulerInternal) {
        const jobScheduler = Object.assign({}, jobSchedulerInternal);
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution = this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (jobSchedulerInternal.frequency && jobSchedulerInternal.frequency.type) {
            jobScheduler.rangeExecutions = {
                frequency: Object.assign({}, jobSchedulerInternal.frequency)
            };
            if (jobSchedulerInternal.rangeLimitHour) {
                const splitRangeLimitHour = jobSchedulerInternal.rangeLimitHour.split(':');
                jobScheduler.rangeExecutions.rangeLimit = {
                    hour: parseInt(splitRangeLimitHour[0], 10),
                    minute: parseInt(splitRangeLimitHour[1], 10)
                };
            }
            if (jobSchedulerInternal.rangeLimitDay) {
                jobScheduler.rangeExecutions.rangeLimit = Object.assign(Object.assign({}, jobScheduler.rangeExecutions.rangeLimit), { day: jobSchedulerInternal.rangeLimitDay });
            }
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    }
    convertToJobSchedulerInternal(jobScheduler = {}) {
        const jobSchedulerInternal = Object.assign({}, jobScheduler);
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        if (jobScheduler.rangeExecutions) {
            jobSchedulerInternal.rangeLimitHour = `${jobScheduler.rangeExecutions.rangeLimit.hour < 10
                ? '0' + jobScheduler.rangeExecutions.rangeLimit.hour
                : jobScheduler.rangeExecutions.rangeLimit.hour}:${jobScheduler.rangeExecutions.rangeLimit.minute < 10
                ? '0' + jobScheduler.rangeExecutions.rangeLimit.minute
                : jobScheduler.rangeExecutions.rangeLimit.minute}`;
            jobSchedulerInternal.rangeLimitDay = jobScheduler.rangeExecutions.rangeLimit.day;
            jobSchedulerInternal.frequency = {
                type: jobScheduler.rangeExecutions.frequency.type,
                value: jobScheduler.rangeExecutions.frequency.value
            };
        }
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    }
    convertToPeriodicity(value) {
        const newValue = {};
        const valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    }
    convertToPeriodicityInternal(value = {}) {
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: `${addZero(value.monthly.hour)}:${addZero(value.monthly.minute)}`,
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: `${addZero(value.daily.hour)}:${addZero(value.daily.minute)}`
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: `${addZero(value.weekly.hour)}:${addZero(value.weekly.minute)}`,
                daysOfWeek: [...value.weekly.daysOfWeek]
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    }
    getCurrentHour(date) {
        const hours = addZero(date.getHours());
        const minutes = addZero(date.getMinutes());
        return `${hours}:${minutes}`;
    }
    getHourFirstExecution(firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    }
    removeInvalidKeys(value, keys) {
        const invalidKeys = keys || [
            'periodicity',
            'hour',
            'minute',
            'day',
            'daysOfWeek',
            'dayOfMonth',
            'firstExecutionHour',
            'frequency',
            'rangeLimitHour',
            'rangeLimitDay'
        ];
        Object.keys(value).forEach(key => {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
            else if (key === 'rangeExecutions' && value['periodicity'] === 'single') {
                delete value[key];
            }
        });
    }
    replaceHourFirstExecution(date, time) {
        const firstExecutionDate = new Date(date);
        const timeSplited = time.split(':');
        const hours = parseInt(timeSplited[0], 10);
        const minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    }
    returnValidExecutionParameter(parameter) {
        const newParameter = Object.assign({}, parameter);
        for (const key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    }
}
PoPageJobSchedulerService.decorators = [
    { type: Injectable }
];
PoPageJobSchedulerService.ctorParameters = () => [
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90ZW1wbGF0ZXMvc3JjL2xpYi9jb21wb25lbnRzL3BvLXBhZ2Utam9iLXNjaGVkdWxlci9wby1wYWdlLWpvYi1zY2hlZHVsZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQU9yRSxNQUFNLE9BQU8seUJBQXlCO0lBT3BDLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFOM0IsWUFBTyxHQUFnQixJQUFJLFdBQVcsQ0FBQztZQUM5QyxrQkFBa0IsRUFBRSxNQUFNO1NBQzNCLENBQUMsQ0FBQztRQUVLLGFBQVEsR0FBRyxHQUFHLENBQUM7SUFFZ0IsQ0FBQztJQUV4QyxnQkFBZ0IsQ0FBQyxTQUFnQyxFQUFFO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNsQyxDQUFDO0lBRUQsa0JBQWtCO0lBQ2xCLGNBQWMsQ0FBQyxRQUFRO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV4RCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFVBQVUsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUNuRixDQUFDO0lB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QUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxFQUFFO2dCQUN2RSxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQjtTQUNGO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQzs7O1lBcFBGLFVBQVU7OztZQVpGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBhZGRaZXJvLCBjb252ZXJ0RGF0ZVRvSVNPRXh0ZW5kZWQgfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZCB9IGZyb20gJ0Bwby11aS9uZy1jb21wb25lbnRzJztcblxuaW1wb3J0IHsgUG9Kb2JTY2hlZHVsZXIgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tam9iLXNjaGVkdWxlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9Kb2JTY2hlZHVsZXJJbnRlcm5hbCB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1qb2Itc2NoZWR1bGVyLWludGVybmFsLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQb1BhZ2VKb2JTY2hlZHVsZXJTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgaGVhZGVyczogSHR0cEhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICdYLVBPLVNDUkVFTi1MT0NLJzogJ3RydWUnXG4gIH0pO1xuXG4gIHByaXZhdGUgZW5kcG9pbnQgPSAnLyc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7fVxuXG4gIGNvbmZpZ1NlcnZpY2VBcGkoY29uZmlnOiB7IGVuZHBvaW50Pzogc3RyaW5nIH0gPSB7fSkge1xuICAgIHRoaXMuZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQ7XG4gIH1cblxuICAvLyBDcmlhIHVtIHJlY3Vyc29cbiAgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2UpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IG5ld1Jlc291Y2UgPSB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlcihyZXNvdXJjZSk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QoYCR7dGhpcy5lbmRwb2ludH1gLCBuZXdSZXNvdWNlLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcbiAgfVxuXG4gIGdldEhlYWRQcm9jZXNzZXMoKSB7XG4gICAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tTm8tRXJyb3InOiAndHJ1ZScgfTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAuaGVhZChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXNgLCB7IGhlYWRlcnMgfSk7XG4gIH1cblxuICAvLyBCdXNjYSBwYXJhbWV0cm9zIHBlbG8gcHJvY2Vzc28gaWRcbiAgZ2V0UGFyYW1ldGVyc0J5UHJvY2Vzcyhwcm9jZXNzSWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXMvJHtwcm9jZXNzSWR9L3BhcmFtZXRlcnNgLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KVxuICAgICAgLnBpcGUobWFwKChyZXNvdXJjZTogeyBpdGVtczogQXJyYXk8UG9EeW5hbWljRm9ybUZpZWxkPiB9KSA9PiByZXNvdXJjZS5pdGVtcykpO1xuICB9XG5cbiAgLy8gQnVzY2EgdW0gw7puaWNvIHJlY3Vyc29cbiAgZ2V0UHJvY2VzcyhpZDogc3RyaW5nIHwgbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXMvJHtpZH1gLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHVtYSBsaXN0YSBkZSBwcm9jZXNzb3NcbiAgZ2V0UHJvY2Vzc2VzKHBhcmFtczoge30gPSB7fSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzYCwgeyBwYXJhbXMgfSk7XG4gIH1cblxuICAvLyBCdXNjYSB1bSDDum5pY28gcmVjdXJzb1xuICBnZXRSZXNvdXJjZShpZDogc3RyaW5nIHwgbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9LyR7aWR9YCwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSlcbiAgICAgIC5waXBlKG1hcChyZXNvdXJjZSA9PiB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlckludGVybmFsKHJlc291cmNlKSkpO1xuICB9XG5cbiAgLy8gQXR1YWxpemEgdW0gcmVjdXJzb1xuICB1cGRhdGVSZXNvdXJjZShpZCwgcmVzb3VyY2UpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IG5ld1Jlc291Y2UgPSB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlcihyZXNvdXJjZSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCBuZXdSZXNvdWNlLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcbiAgfVxuXG4gIGNvbnZlcnRUb0pvYlNjaGVkdWxlcihqb2JTY2hlZHVsZXJJbnRlcm5hbCk6IFBvSm9iU2NoZWR1bGVyIHtcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB7IC4uLmpvYlNjaGVkdWxlckludGVybmFsIH07XG5cbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucGVyaW9kaWNpdHkpIHtcbiAgICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5wZXJpb2RpY2l0eSA9PT0gJ3NpbmdsZScpIHtcbiAgICAgICAgam9iU2NoZWR1bGVyLnJlY3VycmVudCA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihqb2JTY2hlZHVsZXIsIHRoaXMuY29udmVydFRvUGVyaW9kaWNpdHkoam9iU2NoZWR1bGVySW50ZXJuYWwpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyKSB7XG4gICAgICBqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24gPSB0aGlzLnJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oXG4gICAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uLFxuICAgICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbkhvdXJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLmZyZXF1ZW5jeSAmJiBqb2JTY2hlZHVsZXJJbnRlcm5hbC5mcmVxdWVuY3kudHlwZSkge1xuICAgICAgam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucyA9IHtcbiAgICAgICAgZnJlcXVlbmN5OiB7IC4uLmpvYlNjaGVkdWxlckludGVybmFsLmZyZXF1ZW5jeSB9XG4gICAgICB9O1xuXG4gICAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucmFuZ2VMaW1pdEhvdXIpIHtcbiAgICAgICAgY29uc3Qgc3BsaXRSYW5nZUxpbWl0SG91ciA9IGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXRIb3VyLnNwbGl0KCc6Jyk7XG5cbiAgICAgICAgam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0ID0ge1xuICAgICAgICAgIGhvdXI6IHBhcnNlSW50KHNwbGl0UmFuZ2VMaW1pdEhvdXJbMF0sIDEwKSxcbiAgICAgICAgICBtaW51dGU6IHBhcnNlSW50KHNwbGl0UmFuZ2VMaW1pdEhvdXJbMV0sIDEwKVxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucmFuZ2VMaW1pdERheSkge1xuICAgICAgICBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQgPSB7XG4gICAgICAgICAgLi4uam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0LFxuICAgICAgICAgIGRheTogam9iU2NoZWR1bGVySW50ZXJuYWwucmFuZ2VMaW1pdERheVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghT2JqZWN0LmtleXModGhpcy5yZXR1cm5WYWxpZEV4ZWN1dGlvblBhcmFtZXRlcihqb2JTY2hlZHVsZXIuZXhlY3V0aW9uUGFyYW1ldGVyKSkubGVuZ3RoKSB7XG4gICAgICBkZWxldGUgam9iU2NoZWR1bGVyLmV4ZWN1dGlvblBhcmFtZXRlcjtcbiAgICB9XG5cbiAgICB0aGlzLnJlbW92ZUludmFsaWRLZXlzKGpvYlNjaGVkdWxlcik7XG5cbiAgICByZXR1cm4gam9iU2NoZWR1bGVyO1xuICB9XG5cbiAgY29udmVydFRvSm9iU2NoZWR1bGVySW50ZXJuYWwoam9iU2NoZWR1bGVyID0gPGFueT57fSk6IFBvSm9iU2NoZWR1bGVySW50ZXJuYWwge1xuICAgIGNvbnN0IGpvYlNjaGVkdWxlckludGVybmFsID0geyAuLi5qb2JTY2hlZHVsZXIgfTtcblxuICAgIGlmIChqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24pIHtcbiAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91ciA9IHRoaXMuZ2V0SG91ckZpcnN0RXhlY3V0aW9uKGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbik7XG4gICAgfVxuXG4gICAgT2JqZWN0LmFzc2lnbihqb2JTY2hlZHVsZXJJbnRlcm5hbCwgdGhpcy5jb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKGpvYlNjaGVkdWxlcikpO1xuXG4gICAgaWYgKGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMpIHtcbiAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXRIb3VyID0gYCR7XG4gICAgICAgIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5ob3VyIDwgMTBcbiAgICAgICAgICA/ICcwJyArIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5ob3VyXG4gICAgICAgICAgOiBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQuaG91clxuICAgICAgfToke1xuICAgICAgICBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQubWludXRlIDwgMTBcbiAgICAgICAgICA/ICcwJyArIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5taW51dGVcbiAgICAgICAgICA6IGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5taW51dGVcbiAgICAgIH1gO1xuICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwucmFuZ2VMaW1pdERheSA9IGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5kYXk7XG4gICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5mcmVxdWVuY3kgPSB7XG4gICAgICAgIHR5cGU6IGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMuZnJlcXVlbmN5LnR5cGUsXG4gICAgICAgIHZhbHVlOiBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLmZyZXF1ZW5jeS52YWx1ZVxuICAgICAgfTtcbiAgICB9XG5cbiAgICB0aGlzLnJlbW92ZUludmFsaWRLZXlzKGpvYlNjaGVkdWxlckludGVybmFsLCBbJ3dlZWtseScsICdtb250aGx5JywgJ2RhaWx5J10pO1xuXG4gICAgcmV0dXJuIGpvYlNjaGVkdWxlckludGVybmFsO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eSh2YWx1ZToge1xuICAgIHBlcmlvZGljaXR5OiBzdHJpbmc7XG4gICAgZGF5T2ZNb250aD86IHN0cmluZztcbiAgICBkYXlzT2ZXZWVrPzogbnVtYmVyO1xuICAgIGhvdXI/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICBjb25zdCBuZXdWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHZhbHVlUGVyaW9kaWNpdHkgPSB2YWx1ZS5wZXJpb2RpY2l0eTtcblxuICAgIGlmICh2YWx1ZVBlcmlvZGljaXR5KSB7XG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XSA9IHt9O1xuXG4gICAgICBpZiAodmFsdWVQZXJpb2RpY2l0eSA9PT0gJ21vbnRobHknKSB7XG4gICAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmRheSA9IHZhbHVlLmRheU9mTW9udGggPyBwYXJzZUludCh2YWx1ZS5kYXlPZk1vbnRoLCAxMCkgOiAwO1xuICAgICAgfSBlbHNlIGlmICh2YWx1ZVBlcmlvZGljaXR5ID09PSAnd2Vla2x5Jykge1xuICAgICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5kYXlzT2ZXZWVrID0gdmFsdWUuZGF5c09mV2VlaztcbiAgICAgIH1cblxuICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uaG91ciA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMF0sIDEwKSA6IDA7XG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5taW51dGUgPSB2YWx1ZS5ob3VyID8gcGFyc2VJbnQodmFsdWUuaG91ci5zcGxpdCgnOicpWzFdLCAxMCkgOiAwO1xuICAgIH1cblxuICAgIHJldHVybiBuZXdWYWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydFRvUGVyaW9kaWNpdHlJbnRlcm5hbCh2YWx1ZSA9IDxhbnk+e30pIHtcbiAgICBpZiAodmFsdWUubW9udGhseSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdtb250aGx5JyxcbiAgICAgICAgaG91cjogYCR7YWRkWmVybyh2YWx1ZS5tb250aGx5LmhvdXIpfToke2FkZFplcm8odmFsdWUubW9udGhseS5taW51dGUpfWAsXG4gICAgICAgIGRheU9mTW9udGg6IHZhbHVlLm1vbnRobHkuZGF5XG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodmFsdWUuZGFpbHkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBlcmlvZGljaXR5OiAnZGFpbHknLFxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLmRhaWx5LmhvdXIpfToke2FkZFplcm8odmFsdWUuZGFpbHkubWludXRlKX1gXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodmFsdWUud2Vla2x5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ3dlZWtseScsXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUud2Vla2x5LmhvdXIpfToke2FkZFplcm8odmFsdWUud2Vla2x5Lm1pbnV0ZSl9YCxcbiAgICAgICAgZGF5c09mV2VlazogWy4uLnZhbHVlLndlZWtseS5kYXlzT2ZXZWVrXVxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdzaW5nbGUnXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q3VycmVudEhvdXIoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgY29uc3QgaG91cnMgPSBhZGRaZXJvKGRhdGUuZ2V0SG91cnMoKSk7XG4gICAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpO1xuXG4gICAgcmV0dXJuIGAke2hvdXJzfToke21pbnV0ZXN9YDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SG91ckZpcnN0RXhlY3V0aW9uKGZpcnN0RXhlY3V0aW9uRGF0ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50SG91cihuZXcgRGF0ZShmaXJzdEV4ZWN1dGlvbkRhdGUpKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlSW52YWxpZEtleXModmFsdWU6IG9iamVjdCwga2V5cz86IEFycmF5PHN0cmluZz4pIHtcbiAgICBjb25zdCBpbnZhbGlkS2V5cyA9IGtleXMgfHwgW1xuICAgICAgJ3BlcmlvZGljaXR5JyxcbiAgICAgICdob3VyJyxcbiAgICAgICdtaW51dGUnLFxuICAgICAgJ2RheScsXG4gICAgICAnZGF5c09mV2VlaycsXG4gICAgICAnZGF5T2ZNb250aCcsXG4gICAgICAnZmlyc3RFeGVjdXRpb25Ib3VyJyxcbiAgICAgICdmcmVxdWVuY3knLFxuICAgICAgJ3JhbmdlTGltaXRIb3VyJyxcbiAgICAgICdyYW5nZUxpbWl0RGF5J1xuICAgIF07XG5cbiAgICBPYmplY3Qua2V5cyh2YWx1ZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKGludmFsaWRLZXlzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgZGVsZXRlIHZhbHVlW2tleV07XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ3JhbmdlRXhlY3V0aW9ucycgJiYgdmFsdWVbJ3BlcmlvZGljaXR5J10gPT09ICdzaW5nbGUnKSB7XG4gICAgICAgIGRlbGV0ZSB2YWx1ZVtrZXldO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZXBsYWNlSG91ckZpcnN0RXhlY3V0aW9uKGRhdGU6IHN0cmluZywgdGltZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBmaXJzdEV4ZWN1dGlvbkRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcblxuICAgIGNvbnN0IHRpbWVTcGxpdGVkID0gdGltZS5zcGxpdCgnOicpO1xuXG4gICAgY29uc3QgaG91cnMgPSBwYXJzZUludCh0aW1lU3BsaXRlZFswXSwgMTApO1xuICAgIGNvbnN0IG1pbnV0ZXMgPSBwYXJzZUludCh0aW1lU3BsaXRlZFsxXSwgMTApO1xuXG4gICAgZmlyc3RFeGVjdXRpb25EYXRlLnNldEhvdXJzKGhvdXJzLCBtaW51dGVzKTtcblxuICAgIHJldHVybiBjb252ZXJ0RGF0ZVRvSVNPRXh0ZW5kZWQoZmlyc3RFeGVjdXRpb25EYXRlKTtcbiAgfVxuXG4gIHByaXZhdGUgcmV0dXJuVmFsaWRFeGVjdXRpb25QYXJhbWV0ZXIocGFyYW1ldGVyOiBvYmplY3QpIHtcbiAgICBjb25zdCBuZXdQYXJhbWV0ZXIgPSB7IC4uLnBhcmFtZXRlciB9O1xuXG4gICAgZm9yIChjb25zdCBrZXkgaW4gbmV3UGFyYW1ldGVyKSB7XG4gICAgICBpZiAobmV3UGFyYW1ldGVyLmhhc093blByb3BlcnR5KGtleSkgJiYgbmV3UGFyYW1ldGVyW2tleV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBkZWxldGUgbmV3UGFyYW1ldGVyW2tleV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1BhcmFtZXRlcjtcbiAgfVxufVxuIl19