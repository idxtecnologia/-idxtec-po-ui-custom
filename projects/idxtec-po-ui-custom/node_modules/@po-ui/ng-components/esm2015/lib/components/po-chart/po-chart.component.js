import { ChangeDetectorRef, Component, ComponentFactoryResolver, ElementRef, HostListener, ViewChild, ViewContainerRef, Renderer2 } from '@angular/core';
import { Subject, Subscription } from 'rxjs';
import { PoChartAxisXLabelArea, PoChartPadding } from './helpers/po-chart-default-values.constant';
import { PoDefaultColors } from '../../services/po-color/po-colors.constant';
import { PoChartBaseComponent } from './po-chart-base.component';
import { PoChartSvgContainerService } from './services/po-chart-svg-container.service';
import { PoChartGaugeComponent } from './po-chart-types/po-chart-gauge/po-chart-gauge.component';
import { PoChartType } from './enums/po-chart-type.enum';
import { PoColorService } from '../../services/po-color/po-color.service';
import { PoChartMathsService } from './services/po-chart-maths.service';
/**
 * @docsExtends PoChartBaseComponent
 *
 * @example
 *
 * <example name="po-chart-basic" title="PO Chart Basic">
 *  <file name="sample-po-chart-basic/sample-po-chart-basic.component.html"> </file>
 *  <file name="sample-po-chart-basic/sample-po-chart-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-chart-labs" title="PO Chart Labs">
 *  <file name="sample-po-chart-labs/sample-po-chart-labs.component.html"> </file>
 *  <file name="sample-po-chart-labs/sample-po-chart-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-chart-coffee-ranking" title="PO Chart - Coffee Ranking">
 *  <file name="sample-po-chart-coffee-ranking/sample-po-chart-coffee-ranking.component.html"> </file>
 *  <file name="sample-po-chart-coffee-ranking/sample-po-chart-coffee-ranking.component.ts"> </file>
 * </example>
 */
export class PoChartComponent extends PoChartBaseComponent {
    constructor(colorService, changeDetector, containerService, componentFactoryResolver, elementRef, mathsService, renderer) {
        super(colorService);
        this.colorService = colorService;
        this.changeDetector = changeDetector;
        this.containerService = containerService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.elementRef = elementRef;
        this.mathsService = mathsService;
        this.renderer = renderer;
        this.calculatedComponentRefElement = false;
        this.calculatedSvgContainerElement = false;
        this.initialized = false;
        this.windowResizeListener = new Subject();
        this.subscription = new Subscription();
        this.mappings = {
            [PoChartType.Gauge]: PoChartGaugeComponent
        };
        this.onResize = () => {
            this.getSvgContainerSize();
            this.windowResizeListener.next();
        };
    }
    get isChartGaugeType() {
        return this.type === PoChartType.Gauge;
    }
    ngAfterViewInit() {
        this.initialized = true;
        this.getSvgContainerSize();
    }
    ngDoCheck() {
        const charWrapperWidth = this.chartWrapper.nativeElement.offsetWidth;
        const isDynamicChart = this.getComponentType(this.type);
        // Permite que o chart seja calculado na primeira vez que o componente torna-se visível,
        // evitando com isso, problemas com Tabs ou Divs que iniciem escondidas.
        // Quando modificada a estrutura dos gráficos do tipo circular isto será melhorado.
        if (charWrapperWidth && this.initialized) {
            if (!isDynamicChart && !this.calculatedSvgContainerElement) {
                this.getSvgContainerSize();
                this.calculatedSvgContainerElement = true;
            }
            else if (isDynamicChart && !this.calculatedComponentRefElement) {
                this.dynamicComponentSetting();
                this.calculatedComponentRefElement = true;
            }
        }
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
        this.removeWindowResizeListener();
    }
    resizeAction() {
        this.getSvgContainerSize();
        this.windowResizeListener.next();
        this.changeDetector.detectChanges();
    }
    ngOnInit() {
        this.getSvgContainerSize();
    }
    rebuildComponentRef() {
        if (this.componentRef) {
            this.componentRef.destroy();
            if (this.isChartGaugeType) {
                this.dynamicComponentSetting();
            }
        }
    }
    calculateAxisXLabelArea() {
        const axisXLabels = this.chartType === PoChartType.Bar ? this.categories : this.chartSeries;
        return this.getAxisXLabelArea(this.mathsService.getLongestDataValue(axisXLabels, this.chartType, this.options));
    }
    getSvgContainerSize() {
        let axisXLabelWidth;
        const { chartHeaderHeight, chartLegendHeight, chartWrapperWidth } = this.getChartMeasurements();
        if (!this.isTypeCircular) {
            axisXLabelWidth = this.calculateAxisXLabelArea();
        }
        this.svgContainerSize = Object.assign(Object.assign({}, this.containerService.calculateSVGContainerMeasurements(this.height, chartWrapperWidth, chartHeaderHeight, chartLegendHeight)), { axisXLabelWidth });
    }
    chartLegendHeight(chartLegend) {
        return chartLegend ? chartLegend.nativeElement.offsetHeight : 0;
    }
    createComponent() {
        const componentType = this.getComponentType(this.type);
        const factory = this.componentFactoryResolver.resolveComponentFactory(componentType);
        this.componentRef = this.chartContainer.createComponent(factory);
        const instance = this.componentRef.instance;
        this.setComponentRefProperties(instance);
        return instance;
    }
    dynamicComponentSetting() {
        const instance = this.createComponent();
        this.setResizeListenerSubscribe(instance);
        this.changeDetector.detectChanges();
        this.setClickSubscribe(instance);
        this.setHoverSubscribe(instance);
    }
    getAxisXLabelArea(axisXLabel) {
        const labelPoChartPadding = PoChartPadding / 3;
        const spanElement = this.renderer.createElement('span');
        this.renderer.addClass(spanElement, 'po-chart-axis-x-label');
        spanElement.innerHTML = axisXLabel;
        this.renderer.appendChild(this.elementRef.nativeElement, spanElement);
        const axisXLabelWidth = Math.ceil(spanElement.offsetWidth) + labelPoChartPadding;
        this.renderer.removeChild(this.elementRef.nativeElement, spanElement);
        return axisXLabelWidth > PoChartAxisXLabelArea ? axisXLabelWidth : PoChartAxisXLabelArea;
    }
    getComponentType(typeName) {
        return this.mappings[typeName];
    }
    getChartMeasurements() {
        const chartWrapperWidth = this.chartWrapper.nativeElement.offsetWidth;
        const chartHeaderHeight = this.chartHeader.nativeElement.offsetHeight;
        const chartLegendHeight = this.chartLegendHeight(this.chartLegend);
        return { chartWrapperWidth, chartHeaderHeight, chartLegendHeight };
    }
    removeWindowResizeListener() {
        if (this.onResize) {
            this.onResize = () => { };
        }
    }
    setComponentRefProperties(instance) {
        const { chartHeaderHeight, chartLegendHeight, chartWrapperWidth } = this.getChartMeasurements();
        instance.chartHeader = chartHeaderHeight;
        instance.chartLegend = chartLegendHeight;
        instance.chartWrapper = chartWrapperWidth;
        instance.colors = PoDefaultColors[0];
        instance.height = this.height;
        instance.type = this.type;
        instance.series = this.chartSeries || [];
    }
    setClickSubscribe(instance) {
        this.subscription.add(instance.onSerieClick.subscribe(event => {
            this.onSeriesClick(event);
        }));
    }
    setHoverSubscribe(instance) {
        this.subscription.add(instance.onSerieHover.subscribe(event => {
            this.onSeriesHover(event);
        }));
    }
    setResizeListenerSubscribe(instance) {
        this.subscription.add(this.windowResizeListener.subscribe(() => {
            const measuresForComponentRef = this.getChartMeasurements();
            instance.chartWrapper = measuresForComponentRef.chartWrapperWidth;
            instance.chartHeader = measuresForComponentRef.chartHeaderHeight;
            instance.chartLegend = measuresForComponentRef.chartLegendHeight;
        }));
    }
}
PoChartComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-chart',
                template: "<div #chartWrapper class=\"po-chart-wrapper\" (p-resize-observer)=\"resizeAction()\">\n  <div #chartHeader class=\"po-chart-header\">\n    <div class=\"po-chart-title\">{{ title }}</div>\n  </div>\n\n  <po-chart-container\n    *ngIf=\"!isChartGaugeType\"\n    [p-options]=\"options\"\n    [p-type]=\"chartType\"\n    [p-series]=\"chartSeries\"\n    [p-categories]=\"categories\"\n    [p-container-size]=\"svgContainerSize\"\n    (p-serie-click)=\"onSeriesClick($event)\"\n    (p-serie-hover)=\"onSeriesHover($event)\"\n  ></po-chart-container>\n\n  <!-- Inje\u00E7\u00E3o de gr\u00E1ficos do tipo gauge. Remover na deprecia\u00E7\u00E3o.  -->\n  <ng-template #chartContainer></ng-template>\n\n  <div *ngIf=\"!isChartGaugeType && options?.legend !== false\">\n    <ng-container *ngTemplateOutlet=\"chartLegendGroup\"></ng-container>\n  </div>\n</div>\n\n<ng-template #chartLegendGroup>\n  <po-chart-legend #chartLegend [p-series]=\"chartSeries\" [p-type]=\"type\"> </po-chart-legend>\n</ng-template>\n"
            },] }
];
PoChartComponent.ctorParameters = () => [
    { type: PoColorService },
    { type: ChangeDetectorRef },
    { type: PoChartSvgContainerService },
    { type: ComponentFactoryResolver },
    { type: ElementRef },
    { type: PoChartMathsService },
    { type: Renderer2 }
];
PoChartComponent.propDecorators = {
    chartContainer: [{ type: ViewChild, args: ['chartContainer', { read: ViewContainerRef, static: true },] }],
    chartHeader: [{ type: ViewChild, args: ['chartHeader', { static: true },] }],
    chartLegend: [{ type: ViewChild, args: ['chartLegend', { read: ElementRef },] }],
    chartWrapper: [{ type: ViewChild, args: ['chartWrapper', { static: true },] }],
    onResize: [{ type: HostListener, args: ['window:resize',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWNoYXJ0L3BvLWNoYXJ0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCx3QkFBd0IsRUFHeEIsVUFBVSxFQUNWLFlBQVksRUFFWixTQUFTLEVBQ1QsZ0JBQWdCLEVBRWhCLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUU3QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsY0FBYyxFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDbkcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBRTdFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBRXZGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV6RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDMUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFeEU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FtQkc7QUFLSCxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsb0JBQW9CO0lBb0J4RCxZQUNZLFlBQTRCLEVBQzlCLGNBQWlDLEVBQ2pDLGdCQUE0QyxFQUM1Qyx3QkFBa0QsRUFDbEQsVUFBc0IsRUFDdEIsWUFBaUMsRUFDakMsUUFBbUI7UUFFM0IsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FB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YSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTswQkFFekMsU0FBUyxTQUFDLGFBQWEsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUU7MkJBRTdDLFNBQVMsU0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3VCQTZCMUMsWUFBWSxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgRG9DaGVjayxcbiAgRWxlbWVudFJlZixcbiAgSG9zdExpc3RlbmVyLFxuICBPbkRlc3Ryb3ksXG4gIFZpZXdDaGlsZCxcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgT25Jbml0LFxuICBSZW5kZXJlcjJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBQb0NoYXJ0QXhpc1hMYWJlbEFyZWEsIFBvQ2hhcnRQYWRkaW5nIH0gZnJvbSAnLi9oZWxwZXJzL3BvLWNoYXJ0LWRlZmF1bHQtdmFsdWVzLmNvbnN0YW50JztcbmltcG9ydCB7IFBvRGVmYXVsdENvbG9ycyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbG9yL3BvLWNvbG9ycy5jb25zdGFudCc7XG5cbmltcG9ydCB7IFBvQ2hhcnRCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1jaGFydC1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0NoYXJ0U3ZnQ29udGFpbmVyU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvcG8tY2hhcnQtc3ZnLWNvbnRhaW5lci5zZXJ2aWNlJztcbmltcG9ydCB7IFBvQ2hhcnREeW5hbWljVHlwZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tY2hhcnQtdHlwZXMvcG8tY2hhcnQtZHluYW1pYy10eXBlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0NoYXJ0R2F1Z2VDb21wb25lbnQgfSBmcm9tICcuL3BvLWNoYXJ0LXR5cGVzL3BvLWNoYXJ0LWdhdWdlL3BvLWNoYXJ0LWdhdWdlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0NoYXJ0VHlwZSB9IGZyb20gJy4vZW51bXMvcG8tY2hhcnQtdHlwZS5lbnVtJztcbmltcG9ydCB7IFBvQ2hhcnRDb250YWluZXJTaXplIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LWNvbnRhaW5lci1zaXplLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0NvbG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbG9yL3BvLWNvbG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9DaGFydE1hdGhzU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvcG8tY2hhcnQtbWF0aHMuc2VydmljZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvQ2hhcnRCYXNlQ29tcG9uZW50XG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tY2hhcnQtYmFzaWNcIiB0aXRsZT1cIlBPIENoYXJ0IEJhc2ljXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1jaGFydC1iYXNpYy9zYW1wbGUtcG8tY2hhcnQtYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tY2hhcnQtYmFzaWMvc2FtcGxlLXBvLWNoYXJ0LWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLWNoYXJ0LWxhYnNcIiB0aXRsZT1cIlBPIENoYXJ0IExhYnNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWNoYXJ0LWxhYnMvc2FtcGxlLXBvLWNoYXJ0LWxhYnMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tY2hhcnQtbGFicy9zYW1wbGUtcG8tY2hhcnQtbGFicy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1jaGFydC1jb2ZmZWUtcmFua2luZ1wiIHRpdGxlPVwiUE8gQ2hhcnQgLSBDb2ZmZWUgUmFua2luZ1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tY2hhcnQtY29mZmVlLXJhbmtpbmcvc2FtcGxlLXBvLWNoYXJ0LWNvZmZlZS1yYW5raW5nLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWNoYXJ0LWNvZmZlZS1yYW5raW5nL3NhbXBsZS1wby1jaGFydC1jb2ZmZWUtcmFua2luZy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwby1jaGFydCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1jaGFydC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUG9DaGFydENvbXBvbmVudCBleHRlbmRzIFBvQ2hhcnRCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgRG9DaGVjaywgT25EZXN0cm95LCBPbkluaXQge1xuICBAVmlld0NoaWxkKCdjaGFydENvbnRhaW5lcicsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiwgc3RhdGljOiB0cnVlIH0pIGNoYXJ0Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmO1xuXG4gIEBWaWV3Q2hpbGQoJ2NoYXJ0SGVhZGVyJywgeyBzdGF0aWM6IHRydWUgfSkgY2hhcnRIZWFkZXI6IEVsZW1lbnRSZWY7XG5cbiAgQFZpZXdDaGlsZCgnY2hhcnRMZWdlbmQnLCB7IHJlYWQ6IEVsZW1lbnRSZWYgfSkgY2hhcnRMZWdlbmQ6IEVsZW1lbnRSZWY7XG5cbiAgQFZpZXdDaGlsZCgnY2hhcnRXcmFwcGVyJywgeyBzdGF0aWM6IHRydWUgfSkgY2hhcnRXcmFwcGVyOiBFbGVtZW50UmVmO1xuXG4gIHByaXZhdGUgY2FsY3VsYXRlZENvbXBvbmVudFJlZkVsZW1lbnQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBjYWxjdWxhdGVkU3ZnQ29udGFpbmVyRWxlbWVudDogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPHt9PjtcbiAgcHJpdmF0ZSBpbml0aWFsaXplZDogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIHdpbmRvd1Jlc2l6ZUxpc3RlbmVyOiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBwcml2YXRlIG1hcHBpbmdzID0ge1xuICAgIFtQb0NoYXJ0VHlwZS5HYXVnZV06IFBvQ2hhcnRHYXVnZUNvbXBvbmVudFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBjb2xvclNlcnZpY2U6IFBvQ29sb3JTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgY29udGFpbmVyU2VydmljZTogUG9DaGFydFN2Z0NvbnRhaW5lclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBtYXRoc1NlcnZpY2U6IFBvQ2hhcnRNYXRoc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyXG4gICkge1xuICAgIHN1cGVyKGNvbG9yU2VydmljZSk7XG4gIH1cblxuICBnZXQgaXNDaGFydEdhdWdlVHlwZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy50eXBlID09PSBQb0NoYXJ0VHlwZS5HYXVnZTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnKVxuICBvblJlc2l6ZSA9ICgpID0+IHtcbiAgICB0aGlzLmdldFN2Z0NvbnRhaW5lclNpemUoKTtcbiAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyLm5leHQoKTtcbiAgfTtcblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgdGhpcy5nZXRTdmdDb250YWluZXJTaXplKCk7XG4gIH1cblxuICBuZ0RvQ2hlY2soKSB7XG4gICAgY29uc3QgY2hhcldyYXBwZXJXaWR0aCA9IHRoaXMuY2hhcnRXcmFwcGVyLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XG4gICAgY29uc3QgaXNEeW5hbWljQ2hhcnQgPSB0aGlzLmdldENvbXBvbmVudFR5cGUodGhpcy50eXBlKTtcblxuICAgIC8vIFBlcm1pdGUgcXVlIG8gY2hhcnQgc2VqYSBjYWxjdWxhZG8gbmEgcHJpbWVpcmEgdmV6IHF1ZSBvIGNvbXBvbmVudGUgdG9ybmEtc2Ugdmlzw612ZWwsXG4gICAgLy8gZXZpdGFuZG8gY29tIGlzc28sIHByb2JsZW1hcyBjb20gVGFicyBvdSBEaXZzIHF1ZSBpbmljaWVtIGVzY29uZGlkYXMuXG4gICAgLy8gUXVhbmRvIG1vZGlmaWNhZGEgYSBlc3RydXR1cmEgZG9zIGdyw6FmaWNvcyBkbyB0aXBvIGNpcmN1bGFyIGlzdG8gc2Vyw6EgbWVsaG9yYWRvLlxuICAgIGlmIChjaGFyV3JhcHBlcldpZHRoICYmIHRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIGlmICghaXNEeW5hbWljQ2hhcnQgJiYgIXRoaXMuY2FsY3VsYXRlZFN2Z0NvbnRhaW5lckVsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5nZXRTdmdDb250YWluZXJTaXplKCk7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlZFN2Z0NvbnRhaW5lckVsZW1lbnQgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChpc0R5bmFtaWNDaGFydCAmJiAhdGhpcy5jYWxjdWxhdGVkQ29tcG9uZW50UmVmRWxlbWVudCkge1xuICAgICAgICB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXR0aW5nKCk7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlZENvbXBvbmVudFJlZkVsZW1lbnQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5yZW1vdmVXaW5kb3dSZXNpemVMaXN0ZW5lcigpO1xuICB9XG5cbiAgcmVzaXplQWN0aW9uKCkge1xuICAgIHRoaXMuZ2V0U3ZnQ29udGFpbmVyU2l6ZSgpO1xuICAgIHRoaXMud2luZG93UmVzaXplTGlzdGVuZXIubmV4dCgpO1xuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5nZXRTdmdDb250YWluZXJTaXplKCk7XG4gIH1cblxuICByZWJ1aWxkQ29tcG9uZW50UmVmKCkge1xuICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgdGhpcy5jb21wb25lbnRSZWYuZGVzdHJveSgpO1xuXG4gICAgICBpZiAodGhpcy5pc0NoYXJ0R2F1Z2VUeXBlKSB7XG4gICAgICAgIHRoaXMuZHluYW1pY0NvbXBvbmVudFNldHRpbmcoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgY2FsY3VsYXRlQXhpc1hMYWJlbEFyZWEoKSB7XG4gICAgY29uc3QgYXhpc1hMYWJlbHMgPSB0aGlzLmNoYXJ0VHlwZSA9PT0gUG9DaGFydFR5cGUuQmFyID8gdGhpcy5jYXRlZ29yaWVzIDogdGhpcy5jaGFydFNlcmllcztcblxuICAgIHJldHVybiB0aGlzLmdldEF4aXNYTGFiZWxBcmVhKHRoaXMubWF0aHNTZXJ2aWNlLmdldExvbmdlc3REYXRhVmFsdWUoYXhpc1hMYWJlbHMsIHRoaXMuY2hhcnRUeXBlLCB0aGlzLm9wdGlvbnMpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRTdmdDb250YWluZXJTaXplKCkge1xuICAgIGxldCBheGlzWExhYmVsV2lkdGg7XG4gICAgY29uc3QgeyBjaGFydEhlYWRlckhlaWdodCwgY2hhcnRMZWdlbmRIZWlnaHQsIGNoYXJ0V3JhcHBlcldpZHRoIH0gPSB0aGlzLmdldENoYXJ0TWVhc3VyZW1lbnRzKCk7XG5cbiAgICBpZiAoIXRoaXMuaXNUeXBlQ2lyY3VsYXIpIHtcbiAgICAgIGF4aXNYTGFiZWxXaWR0aCA9IHRoaXMuY2FsY3VsYXRlQXhpc1hMYWJlbEFyZWEoKTtcbiAgICB9XG5cbiAgICB0aGlzLnN2Z0NvbnRhaW5lclNpemUgPSB7XG4gICAgICAuLi50aGlzLmNvbnRhaW5lclNlcnZpY2UuY2FsY3VsYXRlU1ZHQ29udGFpbmVyTWVhc3VyZW1lbnRzKFxuICAgICAgICB0aGlzLmhlaWdodCxcbiAgICAgICAgY2hhcnRXcmFwcGVyV2lkdGgsXG4gICAgICAgIGNoYXJ0SGVhZGVySGVpZ2h0LFxuICAgICAgICBjaGFydExlZ2VuZEhlaWdodFxuICAgICAgKSxcbiAgICAgIGF4aXNYTGFiZWxXaWR0aFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNoYXJ0TGVnZW5kSGVpZ2h0KGNoYXJ0TGVnZW5kOiBFbGVtZW50UmVmKSB7XG4gICAgcmV0dXJuIGNoYXJ0TGVnZW5kID8gY2hhcnRMZWdlbmQubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQgOiAwO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDb21wb25lbnQoKSB7XG4gICAgY29uc3QgY29tcG9uZW50VHlwZSA9IHRoaXMuZ2V0Q29tcG9uZW50VHlwZSh0aGlzLnR5cGUpO1xuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnRUeXBlKTtcblxuICAgIHRoaXMuY29tcG9uZW50UmVmID0gdGhpcy5jaGFydENvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZmFjdG9yeSk7XG5cbiAgICBjb25zdCBpbnN0YW5jZSA9IDxQb0NoYXJ0RHluYW1pY1R5cGVDb21wb25lbnQ+dGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XG5cbiAgICB0aGlzLnNldENvbXBvbmVudFJlZlByb3BlcnRpZXMoaW5zdGFuY2UpO1xuXG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBkeW5hbWljQ29tcG9uZW50U2V0dGluZygpIHtcbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuY3JlYXRlQ29tcG9uZW50KCk7XG5cbiAgICB0aGlzLnNldFJlc2l6ZUxpc3RlbmVyU3Vic2NyaWJlKGluc3RhbmNlKTtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB0aGlzLnNldENsaWNrU3Vic2NyaWJlKGluc3RhbmNlKTtcbiAgICB0aGlzLnNldEhvdmVyU3Vic2NyaWJlKGluc3RhbmNlKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QXhpc1hMYWJlbEFyZWEoYXhpc1hMYWJlbDogYW55KSB7XG4gICAgY29uc3QgbGFiZWxQb0NoYXJ0UGFkZGluZyA9IFBvQ2hhcnRQYWRkaW5nIC8gMztcbiAgICBjb25zdCBzcGFuRWxlbWVudCA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuXG4gICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhzcGFuRWxlbWVudCwgJ3BvLWNoYXJ0LWF4aXMteC1sYWJlbCcpO1xuICAgIHNwYW5FbGVtZW50LmlubmVySFRNTCA9IGF4aXNYTGFiZWw7XG5cbiAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBzcGFuRWxlbWVudCk7XG4gICAgY29uc3QgYXhpc1hMYWJlbFdpZHRoID0gTWF0aC5jZWlsKHNwYW5FbGVtZW50Lm9mZnNldFdpZHRoKSArIGxhYmVsUG9DaGFydFBhZGRpbmc7XG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgc3BhbkVsZW1lbnQpO1xuXG4gICAgcmV0dXJuIGF4aXNYTGFiZWxXaWR0aCA+IFBvQ2hhcnRBeGlzWExhYmVsQXJlYSA/IGF4aXNYTGFiZWxXaWR0aCA6IFBvQ2hhcnRBeGlzWExhYmVsQXJlYTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50VHlwZSh0eXBlTmFtZSkge1xuICAgIHJldHVybiB0aGlzLm1hcHBpbmdzW3R5cGVOYW1lXTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hhcnRNZWFzdXJlbWVudHMoKSB7XG4gICAgY29uc3QgY2hhcnRXcmFwcGVyV2lkdGggPSB0aGlzLmNoYXJ0V3JhcHBlci5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuICAgIGNvbnN0IGNoYXJ0SGVhZGVySGVpZ2h0ID0gdGhpcy5jaGFydEhlYWRlci5uYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodDtcbiAgICBjb25zdCBjaGFydExlZ2VuZEhlaWdodCA9IHRoaXMuY2hhcnRMZWdlbmRIZWlnaHQodGhpcy5jaGFydExlZ2VuZCk7XG5cbiAgICByZXR1cm4geyBjaGFydFdyYXBwZXJXaWR0aCwgY2hhcnRIZWFkZXJIZWlnaHQsIGNoYXJ0TGVnZW5kSGVpZ2h0IH07XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZVdpbmRvd1Jlc2l6ZUxpc3RlbmVyKCkge1xuICAgIGlmICh0aGlzLm9uUmVzaXplKSB7XG4gICAgICB0aGlzLm9uUmVzaXplID0gKCkgPT4ge307XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb21wb25lbnRSZWZQcm9wZXJ0aWVzKGluc3RhbmNlOiBQb0NoYXJ0RHluYW1pY1R5cGVDb21wb25lbnQpIHtcbiAgICBjb25zdCB7IGNoYXJ0SGVhZGVySGVpZ2h0LCBjaGFydExlZ2VuZEhlaWdodCwgY2hhcnRXcmFwcGVyV2lkdGggfSA9IHRoaXMuZ2V0Q2hhcnRNZWFzdXJlbWVudHMoKTtcblxuICAgIGluc3RhbmNlLmNoYXJ0SGVhZGVyID0gY2hhcnRIZWFkZXJIZWlnaHQ7XG4gICAgaW5zdGFuY2UuY2hhcnRMZWdlbmQgPSBjaGFydExlZ2VuZEhlaWdodDtcbiAgICBpbnN0YW5jZS5jaGFydFdyYXBwZXIgPSBjaGFydFdyYXBwZXJXaWR0aDtcbiAgICBpbnN0YW5jZS5jb2xvcnMgPSBQb0RlZmF1bHRDb2xvcnNbMF07XG4gICAgaW5zdGFuY2UuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7XG4gICAgaW5zdGFuY2UudHlwZSA9IHRoaXMudHlwZTtcbiAgICBpbnN0YW5jZS5zZXJpZXMgPSB0aGlzLmNoYXJ0U2VyaWVzIHx8IFtdO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRDbGlja1N1YnNjcmliZShpbnN0YW5jZTogUG9DaGFydER5bmFtaWNUeXBlQ29tcG9uZW50KSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxuICAgICAgaW5zdGFuY2Uub25TZXJpZUNsaWNrLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgIHRoaXMub25TZXJpZXNDbGljayhldmVudCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNldEhvdmVyU3Vic2NyaWJlKGluc3RhbmNlOiBQb0NoYXJ0RHluYW1pY1R5cGVDb21wb25lbnQpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICBpbnN0YW5jZS5vblNlcmllSG92ZXIuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgICAgdGhpcy5vblNlcmllc0hvdmVyKGV2ZW50KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0UmVzaXplTGlzdGVuZXJTdWJzY3JpYmUoaW5zdGFuY2U6IFBvQ2hhcnREeW5hbWljVHlwZUNvbXBvbmVudCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgIHRoaXMud2luZG93UmVzaXplTGlzdGVuZXIuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgY29uc3QgbWVhc3VyZXNGb3JDb21wb25lbnRSZWYgPSB0aGlzLmdldENoYXJ0TWVhc3VyZW1lbnRzKCk7XG5cbiAgICAgICAgaW5zdGFuY2UuY2hhcnRXcmFwcGVyID0gbWVhc3VyZXNGb3JDb21wb25lbnRSZWYuY2hhcnRXcmFwcGVyV2lkdGg7XG4gICAgICAgIGluc3RhbmNlLmNoYXJ0SGVhZGVyID0gbWVhc3VyZXNGb3JDb21wb25lbnRSZWYuY2hhcnRIZWFkZXJIZWlnaHQ7XG4gICAgICAgIGluc3RhbmNlLmNoYXJ0TGVnZW5kID0gbWVhc3VyZXNGb3JDb21wb25lbnRSZWYuY2hhcnRMZWdlbmRIZWlnaHQ7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==