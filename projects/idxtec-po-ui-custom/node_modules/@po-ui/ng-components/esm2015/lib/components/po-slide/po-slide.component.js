import { Component, ContentChild, HostListener, ViewChild, ViewChildren } from '@angular/core';
import { animate, AnimationBuilder, keyframes, style } from '@angular/animations';
import { Subject } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { PoSlideBaseComponent } from './po-slide-base.component';
import { PoSlideContentTemplateDirective } from './directives/po-slide-content-template.directive';
import { PoSlideItemComponent } from './po-slide-item/po-slide-item.component';
const poSlideDefaultHeight = 336;
const poSlideIntervalMin = 1000;
const poSlideMinHeight = 192;
const poSlideTiming = '250ms ease';
/**
 * @docsExtends PoSlideBaseComponent
 *
 * @example
 * <example name="po-slide-basic" title="PO Slide Basic">
 *   <file name="sample-po-slide-basic/sample-po-slide-basic.component.html"> </file>
 *   <file name="sample-po-slide-basic/sample-po-slide-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-labs" title="PO Slide Labs">
 *   <file name="sample-po-slide-labs/sample-po-slide-labs.component.html"> </file>
 *   <file name="sample-po-slide-labs/sample-po-slide-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-useful-articles" title="PO Slide - Useful articles">
 *   <file name="sample-po-slide-useful-articles/sample-po-slide-useful-articles.component.html"> </file>
 *   <file name="sample-po-slide-useful-articles/sample-po-slide-useful-articles.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-landscapes" title="PO Slide - Landscapes">
 *   <file name="sample-po-slide-landscapes/sample-po-slide-landscapes.component.html"> </file>
 *   <file name="sample-po-slide-landscapes/sample-po-slide-landscapes.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-external-controls" title="PO Slide - External Controls">
 *  <file name="sample-po-slide-external-controls/sample-po-slide-external-controls.component.html"> </file>
 *  <file name="sample-po-slide-external-controls/sample-po-slide-external-controls.component.ts"> </file>
 * </example>
 */
export class PoSlideComponent extends PoSlideBaseComponent {
    constructor(builder) {
        super();
        this.builder = builder;
        this.currentSlideIndex = 0;
        this.slideItems = [];
        this.isLoaded = false;
        this.resize$ = new Subject();
    }
    get hasElements() {
        return !!this.slide.nativeElement.offsetWidth && !!this.itemsElements && !!this.itemsElements.length;
    }
    get isImageSlide() {
        return !this.slideContentTemplate;
    }
    get offset() {
        return this.currentSlideIndex * this.slideItemWidth;
    }
    get hasSlides() {
        return !!this.slides && !!this.slides.length;
    }
    onResize() {
        this.resize$.next();
    }
    ngOnInit() {
        this.resizeSubscription = this.resize$.pipe(debounceTime(150)).subscribe(() => {
            this.setSlideItemWidth();
            this.goToItem(this.currentSlideIndex);
        });
    }
    ngDoCheck() {
        if (!this.isLoaded && this.hasElements) {
            this.setSlideItemWidth();
            this.isLoaded = true;
            if (this.hasSlides) {
                this.startSlide();
            }
        }
    }
    ngOnChanges(changes) {
        if (changes.height) {
            this.setSlideHeight(this.height);
        }
    }
    ngOnDestroy() {
        var _a;
        (_a = this.resizeSubscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
    }
    /**
     * Método que retorna o index do slide atual
     *
     * ```
     * @ViewChild('slideComponent', { static: true }) slideComponent: PoSlideComponent;
     *  myFunction() {
     *    let currentIndex = this.slideComponent.getCurrentSlideIndex();
     * }
     *
     * ```
     */
    getCurrentSlideIndex() {
        return this.currentSlideIndex;
    }
    goToItem(index) {
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.currentSlideIndex = index;
        this.animate(this.offset);
    }
    nextControl() {
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.next();
    }
    /**
     * Método para chamar o próximo slide.
     *
     * ```
     * @ViewChild('slideComponent', { static: true }) slideComponent: PoSlideComponent;
     *
     * myFunction() {
     *  this.slideComponent.next();
     * }
     * ```
     */
    next() {
        if (this.currentSlideIndex + 1 === this.slideItems.length) {
            this.currentSlideIndex = 0;
            this.animate(0);
            return;
        }
        this.currentSlideIndex = (this.currentSlideIndex + 1) % this.slideItems.length;
        this.animate(this.offset);
    }
    /**
     * Método para chamar o slide anterior.
     *
     * ```
     * @ViewChild('slideComponent', { static: true }) slideComponent: PoSlideComponent;
     *
     * myFunction() {
     *  this.slideComponent.previous();
     * }
     * ```
     */
    previous() {
        if (this.currentSlideIndex === 0) {
            this.currentSlideIndex = this.slideItems.length - 1;
            this.animate(this.offset);
            return;
        }
        this.currentSlideIndex = (this.currentSlideIndex - 1 + this.slideItems.length) % this.slideItems.length;
        this.animate(this.offset);
    }
    previousControl() {
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.previous();
    }
    setSlideHeight(height) {
        this.setHeight(height);
    }
    cancelInterval() {
        clearInterval(this.setInterval);
    }
    setSlideItems(slides) {
        if (this.hasSlides) {
            this.slideContentTemplate ? this.createArrayForTemplate(slides) : this.createArrayFromSlides(slides);
        }
        else {
            this.slideItems = [];
            this.cancelInterval();
        }
    }
    startSlide() {
        this.setSlideHeight(this.height);
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.currentSlideIndex = 0;
    }
    startInterval() {
        if (this.setInterval) {
            this.cancelInterval();
        }
        this.setInterval =
            this.hasSlides && this.hasElements
                ? setInterval(() => {
                    this.next();
                }, this.interval)
                : undefined;
    }
    animate(offset) {
        if (this.hasElements) {
            const animation = this.buildTransitionAnimation(offset);
            this.player = animation.create(this.slide.nativeElement);
            this.player.play();
        }
    }
    buildTransitionAnimation(offset) {
        return this.builder.build([animate(poSlideTiming, keyframes([style({ transform: `translateX(-${offset}px)` })]))]);
    }
    createArrayForTemplate(slides) {
        this.slideItems = [...slides];
    }
    createArrayFromSlides(slides) {
        const isStringArray = slides.every(item => typeof item === 'string');
        if (isStringArray) {
            slides.forEach(element => this.slideItems.push({ image: `${element}` }));
        }
        else {
            this.slideItems = [...slides];
        }
    }
    setDefaultHeight(height) {
        if ((height && height <= poSlideMinHeight) || (!height && this.isImageSlide)) {
            this.slide.nativeElement.style.height = `${poSlideDefaultHeight}px`;
            this.imageHeight = poSlideDefaultHeight;
        }
        else {
            this.imageHeight = undefined;
        }
    }
    setHeight(height) {
        if (height && height > poSlideMinHeight) {
            this.slide.nativeElement.style.height = `${height}px`;
            this.imageHeight = height;
        }
        else {
            this.setDefaultHeight(height);
        }
    }
    setSlideItemWidth() {
        if (this.hasElements) {
            this.slideItemWidth = this.itemsElements.first.itemElement.nativeElement.getBoundingClientRect().width;
        }
    }
}
PoSlideComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-slide',
                template: "<div class=\"po-slide-wrapper\">\n  <div class=\"po-slide-outer\">\n    <div class=\"po-slide-inner\" #slide>\n      <ng-container *ngFor=\"let item of slideItems; let index = index\">\n        <po-slide-item\n          [p-action]=\"item.action\"\n          [p-data]=\"item\"\n          [p-image]=\"item.image\"\n          [p-image-height]=\"imageHeight\"\n          [p-template]=\"slideContentTemplate\"\n          [p-alt]=\"item.alt\"\n          [p-link]=\"item.link\"\n        >\n        </po-slide-item>\n      </ng-container>\n    </div>\n\n    <po-slide-control\n      *ngIf=\"!hideArrows && hasSlides && slides.length > 1\"\n      p-control=\"previous\"\n      (p-click)=\"previousControl()\"\n    >\n    </po-slide-control>\n\n    <po-slide-control *ngIf=\"!hideArrows && hasSlides && slides.length > 1\" p-control=\"next\" (p-click)=\"nextControl()\">\n    </po-slide-control>\n  </div>\n\n  <po-slide-circles\n    *ngIf=\"hasSlides && slides.length > 1\"\n    [p-current-slide-index]=\"currentSlideIndex\"\n    [p-items]=\"slideItems\"\n    (p-click)=\"goToItem($event)\"\n  >\n  </po-slide-circles>\n</div>\n"
            },] }
];
PoSlideComponent.ctorParameters = () => [
    { type: AnimationBuilder }
];
PoSlideComponent.propDecorators = {
    slideContentTemplate: [{ type: ContentChild, args: [PoSlideContentTemplateDirective, { static: true },] }],
    slide: [{ type: ViewChild, args: ['slide', { static: true },] }],
    itemsElements: [{ type: ViewChildren, args: [PoSlideItemComponent,] }],
    onResize: [{ type: HostListener, args: ['window:resize',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tc2xpZGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLXNsaWRlL3BvLXNsaWRlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFlBQVksRUFHWixZQUFZLEVBRVosU0FBUyxFQUNULFlBQVksRUFLYixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFxQyxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckgsT0FBTyxFQUFnQixPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBRW5HLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBRS9FLE1BQU0sb0JBQW9CLEdBQUcsR0FBRyxDQUFDO0FBQ2pDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0FBQ2hDLE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxDQUFDO0FBQzdCLE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQztBQUVuQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQTRCRztBQUtILE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxvQkFBb0I7SUFtQ3hELFlBQW9CLE9BQXlCO1FBQzNDLEtBQUssRUFBRSxDQUFDO1FBRFUsWUFBTyxHQUFQLE9BQU8sQ0FBa0I7UUEzQjdDLHNCQUFpQixHQUFHLENBQUMsQ0FBQztRQUV0QixlQUFVLEdBQTZCLEVBQUUsQ0FBQztRQUdsQyxhQUFRLEdBQVksS0FBSyxD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QUFjO1FBQzlCLElBQUksTUFBTSxJQUFJLE1BQU0sR0FBRyxnQkFBZ0IsRUFBRTtZQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUM7WUFDdEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7U0FDM0I7YUFBTTtZQUNMLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLEtBQUssQ0FBQztTQUN4RztJQUNILENBQUM7OztZQXJQRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLDJtQ0FBd0M7YUFDekM7OztZQS9DaUIsZ0JBQWdCOzs7bUNBaUQvQixZQUFZLFNBQUMsK0JBQStCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO29CQUc5RCxTQUFTLFNBQUMsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTs0QkFFbkMsWUFBWSxTQUFDLG9CQUFvQjt1QkFpQ2pDLFlBQVksU0FBQyxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGQsXG4gIERvQ2hlY2ssXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RMaXN0ZW5lcixcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q2hpbGQsXG4gIFZpZXdDaGlsZHJlbixcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgYW5pbWF0ZSwgQW5pbWF0aW9uQnVpbGRlciwgQW5pbWF0aW9uRmFjdG9yeSwgQW5pbWF0aW9uUGxheWVyLCBrZXlmcmFtZXMsIHN0eWxlIH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5cbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQb1NsaWRlQmFzZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tc2xpZGUtYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9TbGlkZUNvbnRlbnRUZW1wbGF0ZURpcmVjdGl2ZSB9IGZyb20gJy4vZGlyZWN0aXZlcy9wby1zbGlkZS1jb250ZW50LXRlbXBsYXRlLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBQb1NsaWRlSXRlbSB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1zbGlkZS1pdGVtLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb1NsaWRlSXRlbUNvbXBvbmVudCB9IGZyb20gJy4vcG8tc2xpZGUtaXRlbS9wby1zbGlkZS1pdGVtLmNvbXBvbmVudCc7XG5cbmNvbnN0IHBvU2xpZGVEZWZhdWx0SGVpZ2h0ID0gMzM2O1xuY29uc3QgcG9TbGlkZUludGVydmFsTWluID0gMTAwMDtcbmNvbnN0IHBvU2xpZGVNaW5IZWlnaHQgPSAxOTI7XG5jb25zdCBwb1NsaWRlVGltaW5nID0gJzI1MG1zIGVhc2UnO1xuXG4vKipcbiAqIEBkb2NzRXh0ZW5kcyBQb1NsaWRlQmFzZUNvbXBvbmVudFxuICpcbiAqIEBleGFtcGxlXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc2xpZGUtYmFzaWNcIiB0aXRsZT1cIlBPIFNsaWRlIEJhc2ljXCI+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc2xpZGUtYmFzaWMvc2FtcGxlLXBvLXNsaWRlLWJhc2ljLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zbGlkZS1iYXNpYy9zYW1wbGUtcG8tc2xpZGUtYmFzaWMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc2xpZGUtbGFic1wiIHRpdGxlPVwiUE8gU2xpZGUgTGFic1wiPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLWxhYnMvc2FtcGxlLXBvLXNsaWRlLWxhYnMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLWxhYnMvc2FtcGxlLXBvLXNsaWRlLWxhYnMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc2xpZGUtdXNlZnVsLWFydGljbGVzXCIgdGl0bGU9XCJQTyBTbGlkZSAtIFVzZWZ1bCBhcnRpY2xlc1wiPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLXVzZWZ1bC1hcnRpY2xlcy9zYW1wbGUtcG8tc2xpZGUtdXNlZnVsLWFydGljbGVzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zbGlkZS11c2VmdWwtYXJ0aWNsZXMvc2FtcGxlLXBvLXNsaWRlLXVzZWZ1bC1hcnRpY2xlcy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zbGlkZS1sYW5kc2NhcGVzXCIgdGl0bGU9XCJQTyBTbGlkZSAtIExhbmRzY2FwZXNcIj5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zbGlkZS1sYW5kc2NhcGVzL3NhbXBsZS1wby1zbGlkZS1sYW5kc2NhcGVzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zbGlkZS1sYW5kc2NhcGVzL3NhbXBsZS1wby1zbGlkZS1sYW5kc2NhcGVzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXNsaWRlLWV4dGVybmFsLWNvbnRyb2xzXCIgdGl0bGU9XCJQTyBTbGlkZSAtIEV4dGVybmFsIENvbnRyb2xzXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zbGlkZS1leHRlcm5hbC1jb250cm9scy9zYW1wbGUtcG8tc2xpZGUtZXh0ZXJuYWwtY29udHJvbHMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc2xpZGUtZXh0ZXJuYWwtY29udHJvbHMvc2FtcGxlLXBvLXNsaWRlLWV4dGVybmFsLWNvbnRyb2xzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLXNsaWRlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXNsaWRlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb1NsaWRlQ29tcG9uZW50IGV4dGVuZHMgUG9TbGlkZUJhc2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIERvQ2hlY2ssIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgQENvbnRlbnRDaGlsZChQb1NsaWRlQ29udGVudFRlbXBsYXRlRGlyZWN0aXZlLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICBzbGlkZUNvbnRlbnRUZW1wbGF0ZTogUG9TbGlkZUNvbnRlbnRUZW1wbGF0ZURpcmVjdGl2ZTtcblxuICBAVmlld0NoaWxkKCdzbGlkZScsIHsgc3RhdGljOiB0cnVlIH0pIHByaXZhdGUgc2xpZGU6IEVsZW1lbnRSZWY7XG5cbiAgQFZpZXdDaGlsZHJlbihQb1NsaWRlSXRlbUNvbXBvbmVudCkgcHJpdmF0ZSBpdGVtc0VsZW1lbnRzOiBRdWVyeUxpc3Q8UG9TbGlkZUl0ZW1Db21wb25lbnQ+O1xuXG4gIGN1cnJlbnRTbGlkZUluZGV4ID0gMDtcbiAgaW1hZ2VIZWlnaHQ6IG51bWJlcjtcbiAgc2xpZGVJdGVtczogQXJyYXk8UG9TbGlkZUl0ZW0gfCBhbnk+ID0gW107XG4gIHNsaWRlSXRlbVdpZHRoOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBpc0xvYWRlZDogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIHBsYXllcjogQW5pbWF0aW9uUGxheWVyO1xuICBwcml2YXRlIHNldEludGVydmFsOiBhbnk7XG4gIHByaXZhdGUgcmVzaXplJCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgcHJpdmF0ZSByZXNpemVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBwcml2YXRlIGdldCBoYXNFbGVtZW50cygpIHtcbiAgICByZXR1cm4gISF0aGlzLnNsaWRlLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGggJiYgISF0aGlzLml0ZW1zRWxlbWVudHMgJiYgISF0aGlzLml0ZW1zRWxlbWVudHMubGVuZ3RoO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaXNJbWFnZVNsaWRlKCkge1xuICAgIHJldHVybiAhdGhpcy5zbGlkZUNvbnRlbnRUZW1wbGF0ZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IG9mZnNldCgpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50U2xpZGVJbmRleCAqIHRoaXMuc2xpZGVJdGVtV2lkdGg7XG4gIH1cblxuICBnZXQgaGFzU2xpZGVzKCkge1xuICAgIHJldHVybiAhIXRoaXMuc2xpZGVzICYmICEhdGhpcy5zbGlkZXMubGVuZ3RoO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBidWlsZGVyOiBBbmltYXRpb25CdWlsZGVyKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnKSBvblJlc2l6ZSgpIHtcbiAgICB0aGlzLnJlc2l6ZSQubmV4dCgpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5yZXNpemVTdWJzY3JpcHRpb24gPSB0aGlzLnJlc2l6ZSQucGlwZShkZWJvdW5jZVRpbWUoMTUwKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuc2V0U2xpZGVJdGVtV2lkdGgoKTtcbiAgICAgIHRoaXMuZ29Ub0l0ZW0odGhpcy5jdXJyZW50U2xpZGVJbmRleCk7XG4gICAgfSk7XG4gIH1cblxuICBuZ0RvQ2hlY2soKSB7XG4gICAgaWYgKCF0aGlzLmlzTG9hZGVkICYmIHRoaXMuaGFzRWxlbWVudHMpIHtcbiAgICAgIHRoaXMuc2V0U2xpZGVJdGVtV2lkdGgoKTtcbiAgICAgIHRoaXMuaXNMb2FkZWQgPSB0cnVlO1xuXG4gICAgICBpZiAodGhpcy5oYXNTbGlkZXMpIHtcbiAgICAgICAgdGhpcy5zdGFydFNsaWRlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzLmhlaWdodCkge1xuICAgICAgdGhpcy5zZXRTbGlkZUhlaWdodCh0aGlzLmhlaWdodCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZXNpemVTdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICAvKipcbiAgICogTcOpdG9kbyBxdWUgcmV0b3JuYSBvIGluZGV4IGRvIHNsaWRlIGF0dWFsXG4gICAqXG4gICAqIGBgYFxuICAgKiBAVmlld0NoaWxkKCdzbGlkZUNvbXBvbmVudCcsIHsgc3RhdGljOiB0cnVlIH0pIHNsaWRlQ29tcG9uZW50OiBQb1NsaWRlQ29tcG9uZW50O1xuICAgKiAgbXlGdW5jdGlvbigpIHtcbiAgICogICAgbGV0IGN1cnJlbnRJbmRleCA9IHRoaXMuc2xpZGVDb21wb25lbnQuZ2V0Q3VycmVudFNsaWRlSW5kZXgoKTtcbiAgICogfVxuICAgKlxuICAgKiBgYGBcbiAgICovXG4gIGdldEN1cnJlbnRTbGlkZUluZGV4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFNsaWRlSW5kZXg7XG4gIH1cblxuICBnb1RvSXRlbShpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKHRoaXMuaW50ZXJ2YWwgPiBwb1NsaWRlSW50ZXJ2YWxNaW4pIHtcbiAgICAgIHRoaXMuc3RhcnRJbnRlcnZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudFNsaWRlSW5kZXggPSBpbmRleDtcbiAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICB9XG5cbiAgbmV4dENvbnRyb2woKSB7XG4gICAgaWYgKHRoaXMuaW50ZXJ2YWwgPiBwb1NsaWRlSW50ZXJ2YWxNaW4pIHtcbiAgICAgIHRoaXMuc3RhcnRJbnRlcnZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMubmV4dCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIE3DqXRvZG8gcGFyYSBjaGFtYXIgbyBwcsOzeGltbyBzbGlkZS5cbiAgICpcbiAgICogYGBgXG4gICAqIEBWaWV3Q2hpbGQoJ3NsaWRlQ29tcG9uZW50JywgeyBzdGF0aWM6IHRydWUgfSkgc2xpZGVDb21wb25lbnQ6IFBvU2xpZGVDb21wb25lbnQ7XG4gICAqXG4gICAqIG15RnVuY3Rpb24oKSB7XG4gICAqICB0aGlzLnNsaWRlQ29tcG9uZW50Lm5leHQoKTtcbiAgICogfVxuICAgKiBgYGBcbiAgICovXG4gIG5leHQoKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudFNsaWRlSW5kZXggKyAxID09PSB0aGlzLnNsaWRlSXRlbXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmN1cnJlbnRTbGlkZUluZGV4ID0gMDtcbiAgICAgIHRoaXMuYW5pbWF0ZSgwKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5jdXJyZW50U2xpZGVJbmRleCA9ICh0aGlzLmN1cnJlbnRTbGlkZUluZGV4ICsgMSkgJSB0aGlzLnNsaWRlSXRlbXMubGVuZ3RoO1xuICAgIHRoaXMuYW5pbWF0ZSh0aGlzLm9mZnNldCk7XG4gIH1cbiAgLyoqXG4gICAqIE3DqXRvZG8gcGFyYSBjaGFtYXIgbyBzbGlkZSBhbnRlcmlvci5cbiAgICpcbiAgICogYGBgXG4gICAqIEBWaWV3Q2hpbGQoJ3NsaWRlQ29tcG9uZW50JywgeyBzdGF0aWM6IHRydWUgfSkgc2xpZGVDb21wb25lbnQ6IFBvU2xpZGVDb21wb25lbnQ7XG4gICAqXG4gICAqIG15RnVuY3Rpb24oKSB7XG4gICAqICB0aGlzLnNsaWRlQ29tcG9uZW50LnByZXZpb3VzKCk7XG4gICAqIH1cbiAgICogYGBgXG4gICAqL1xuICBwcmV2aW91cygpIHtcbiAgICBpZiAodGhpcy5jdXJyZW50U2xpZGVJbmRleCA9PT0gMCkge1xuICAgICAgdGhpcy5jdXJyZW50U2xpZGVJbmRleCA9IHRoaXMuc2xpZGVJdGVtcy5sZW5ndGggLSAxO1xuICAgICAgdGhpcy5hbmltYXRlKHRoaXMub2Zmc2V0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5jdXJyZW50U2xpZGVJbmRleCA9ICh0aGlzLmN1cnJlbnRTbGlkZUluZGV4IC0gMSArIHRoaXMuc2xpZGVJdGVtcy5sZW5ndGgpICUgdGhpcy5zbGlkZUl0ZW1zLmxlbmd0aDtcbiAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICB9XG5cbiAgcHJldmlvdXNDb250cm9sKCkge1xuICAgIGlmICh0aGlzLmludGVydmFsID4gcG9TbGlkZUludGVydmFsTWluKSB7XG4gICAgICB0aGlzLnN0YXJ0SW50ZXJ2YWwoKTtcbiAgICB9XG5cbiAgICB0aGlzLnByZXZpb3VzKCk7XG4gIH1cblxuICBzZXRTbGlkZUhlaWdodChoZWlnaHQ6IG51bWJlcikge1xuICAgIHRoaXMuc2V0SGVpZ2h0KGhlaWdodCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY2FuY2VsSW50ZXJ2YWwoKSB7XG4gICAgY2xlYXJJbnRlcnZhbCh0aGlzLnNldEludGVydmFsKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXRTbGlkZUl0ZW1zKHNsaWRlczogQXJyYXk8UG9TbGlkZUl0ZW0gfCBzdHJpbmcgfCBhbnk+KSB7XG4gICAgaWYgKHRoaXMuaGFzU2xpZGVzKSB7XG4gICAgICB0aGlzLnNsaWRlQ29udGVudFRlbXBsYXRlID8gdGhpcy5jcmVhdGVBcnJheUZvclRlbXBsYXRlKHNsaWRlcykgOiB0aGlzLmNyZWF0ZUFycmF5RnJvbVNsaWRlcyhzbGlkZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNsaWRlSXRlbXMgPSBbXTtcbiAgICAgIHRoaXMuY2FuY2VsSW50ZXJ2YWwoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgc3RhcnRTbGlkZSgpIHtcbiAgICB0aGlzLnNldFNsaWRlSGVpZ2h0KHRoaXMuaGVpZ2h0KTtcblxuICAgIGlmICh0aGlzLmludGVydmFsID4gcG9TbGlkZUludGVydmFsTWluKSB7XG4gICAgICB0aGlzLnN0YXJ0SW50ZXJ2YWwoKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRTbGlkZUluZGV4ID0gMDtcbiAgfVxuXG4gIHByb3RlY3RlZCBzdGFydEludGVydmFsKCkge1xuICAgIGlmICh0aGlzLnNldEludGVydmFsKSB7XG4gICAgICB0aGlzLmNhbmNlbEludGVydmFsKCk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRJbnRlcnZhbCA9XG4gICAgICB0aGlzLmhhc1NsaWRlcyAmJiB0aGlzLmhhc0VsZW1lbnRzXG4gICAgICAgID8gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5uZXh0KCk7XG4gICAgICAgICAgfSwgdGhpcy5pbnRlcnZhbClcbiAgICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGFuaW1hdGUob2Zmc2V0OiBudW1iZXIpIHtcbiAgICBpZiAodGhpcy5oYXNFbGVtZW50cykge1xuICAgICAgY29uc3QgYW5pbWF0aW9uOiBBbmltYXRpb25GYWN0b3J5ID0gdGhpcy5idWlsZFRyYW5zaXRpb25BbmltYXRpb24ob2Zmc2V0KTtcblxuICAgICAgdGhpcy5wbGF5ZXIgPSBhbmltYXRpb24uY3JlYXRlKHRoaXMuc2xpZGUubmF0aXZlRWxlbWVudCk7XG4gICAgICB0aGlzLnBsYXllci5wbGF5KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFRyYW5zaXRpb25BbmltYXRpb24ob2Zmc2V0OiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5idWlsZGVyLmJ1aWxkKFthbmltYXRlKHBvU2xpZGVUaW1pbmcsIGtleWZyYW1lcyhbc3R5bGUoeyB0cmFuc2Zvcm06IGB0cmFuc2xhdGVYKC0ke29mZnNldH1weClgIH0pXSkpXSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUFycmF5Rm9yVGVtcGxhdGUoc2xpZGVzOiBBcnJheTxhbnk+KSB7XG4gICAgdGhpcy5zbGlkZUl0ZW1zID0gWy4uLnNsaWRlc107XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUFycmF5RnJvbVNsaWRlcyhzbGlkZXM6IEFycmF5PFBvU2xpZGVJdGVtIHwgc3RyaW5nIHwgYW55Pikge1xuICAgIGNvbnN0IGlzU3RyaW5nQXJyYXkgPSBzbGlkZXMuZXZlcnkoaXRlbSA9PiB0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpO1xuXG4gICAgaWYgKGlzU3RyaW5nQXJyYXkpIHtcbiAgICAgIHNsaWRlcy5mb3JFYWNoKGVsZW1lbnQgPT4gdGhpcy5zbGlkZUl0ZW1zLnB1c2goeyBpbWFnZTogYCR7ZWxlbWVudH1gIH0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zbGlkZUl0ZW1zID0gWy4uLig8QXJyYXk8UG9TbGlkZUl0ZW0+PnNsaWRlcyldO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0RGVmYXVsdEhlaWdodChoZWlnaHQ6IG51bWJlcikge1xuICAgIGlmICgoaGVpZ2h0ICYmIGhlaWdodCA8PSBwb1NsaWRlTWluSGVpZ2h0KSB8fCAoIWhlaWdodCAmJiB0aGlzLmlzSW1hZ2VTbGlkZSkpIHtcbiAgICAgIHRoaXMuc2xpZGUubmF0aXZlRWxlbWVudC5zdHlsZS5oZWlnaHQgPSBgJHtwb1NsaWRlRGVmYXVsdEhlaWdodH1weGA7XG4gICAgICB0aGlzLmltYWdlSGVpZ2h0ID0gcG9TbGlkZURlZmF1bHRIZWlnaHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaW1hZ2VIZWlnaHQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRIZWlnaHQoaGVpZ2h0OiBudW1iZXIpIHtcbiAgICBpZiAoaGVpZ2h0ICYmIGhlaWdodCA+IHBvU2xpZGVNaW5IZWlnaHQpIHtcbiAgICAgIHRoaXMuc2xpZGUubmF0aXZlRWxlbWVudC5zdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xuICAgICAgdGhpcy5pbWFnZUhlaWdodCA9IGhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXREZWZhdWx0SGVpZ2h0KGhlaWdodCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRTbGlkZUl0ZW1XaWR0aCgpIHtcbiAgICBpZiAodGhpcy5oYXNFbGVtZW50cykge1xuICAgICAgdGhpcy5zbGlkZUl0ZW1XaWR0aCA9IHRoaXMuaXRlbXNFbGVtZW50cy5maXJzdC5pdGVtRWxlbWVudC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoO1xuICAgIH1cbiAgfVxufVxuIl19