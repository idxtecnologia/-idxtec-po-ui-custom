import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild } from '@angular/core';
import { animate, AnimationBuilder, keyframes, style } from '@angular/animations';
import { delay } from 'rxjs/operators';
import { uuid } from '../../utils/util';
import { PoLanguageService } from '../../services/po-language/po-language.service';
import { PoMenuGlobalService } from '../po-menu/services/po-menu-global.service';
import { PoMenuComponent } from '../po-menu/po-menu.component';
import { PoNavbarBaseComponent } from './po-navbar-base.component';
import { PoNavbarItemsComponent } from './po-navbar-items/po-navbar-items.component';
const poNavbarNavigationWidth = 88;
const poNavbarMenuMedia = 768;
const poNavbarMatchMedia = `(max-width: ${poNavbarMenuMedia}px)`;
const poNavbarTiming = '250ms ease';
/**
 * @docsExtends PoNavbarBaseComponent
 */
export class PoNavbarComponent extends PoNavbarBaseComponent {
    constructor(poLanguageService, renderer, builder, changeDetector, menuGlobalService) {
        super(poLanguageService);
        this.renderer = renderer;
        this.builder = builder;
        this.changeDetector = changeDetector;
        this.menuGlobalService = menuGlobalService;
        this.showItemsNavigation = false;
        this.isNavbarUpdateMenu = false;
        this.id = uuid();
        this.offset = 0;
        this.previousMenusItems = [];
        this.onMediaQueryChange = changed => {
            this.changeNavbarMenuItems(changed.matches, this.items, this.literals.navbarLinks);
        };
        this.windowResizeListener = this.renderer.listen(window, 'resize', this.displayItemsNavigation.bind(this));
    }
    get navbarItemNavigationDisableLeft() {
        return this.offset === 0;
    }
    get navbarItemNavigationDisableRight() {
        return this.disableRight && this.offset !== 0;
    }
    set menuComponent(menu) {
        this._menuComponent = menu;
        this.previousMenuComponentId = (menu === null || menu === void 0 ? void 0 : menu.id) || this.previousMenuComponentId;
    }
    get isCollapsedMedia() {
        return window.innerWidth < poNavbarMenuMedia;
    }
    ngOnInit() {
        // necessário para quando o menu da aplicação carregar os itens lazy e navbar estiver colapsado,
        // quando isso acontece, o navbar inclui 1 item de menu "Navbar links", portanto é removido quando
        // os novos itens de menu é carregado, a partir disso este tratamento é necessario para incluir
        // o navbar links apos a adição dos itens de menu da aplicação.
        this.menusSubscription = this.menuGlobalService.receiveMenus$.subscribe(newMenus => {
            var _a;
            const previousMenusiIsNavbarLinks = ((_a = this.previousMenusItems) === null || _a === void 0 ? void 0 : _a.length) === 1 && this.previousMenusItems[0].id === this.id;
            if (this.applicationMenu && this.isCollapsedMedia && this.isNavbarUpdateMenu && previousMenusiIsNavbarLinks) {
                this.isNavbarUpdateMenu = false;
                this.applicationMenu.menus = [
                    { label: this.literals.navbarLinks, subItems: this.items, id: this.id },
                    ...newMenus
                ];
            }
            this.isNavbarUpdateMenu = false;
            this.previousMenusItems = newMenus;
        });
        this.removedMenuSubscription = this.menuGlobalService.receiveRemovedApplicationMenu$.subscribe(removedMenuId => {
            // verifica se o menu removido foi o presente no navbar, caso sim, ele mantem o applictionMenu.
            // é preciso para tratar a sequencia do ngDestroy, quando o menu do navbar era removido do DOM
            // disparava esse evento, sendo necessario tratar, para não tornar indefinido o applicationMenu
            this.applicationMenu =
                this.applicationMenu && this.previousMenuComponentId === removedMenuId ? this.applicationMenu : undefined;
            this.changeDetector.detectChanges();
            if (!this.applicationMenu && this.mediaQuery) {
                this.mediaQuery.removeListener(this.onMediaQueryChange);
            }
        });
        this.applicationMenuSubscription = this.menuGlobalService.receiveApplicationMenu$
            .pipe(delay(100))
            .subscribe(newMenu => {
            this.applicationMenu = this.previousMenuComponentId === newMenu.id ? undefined : newMenu;
            this.changeDetector.detectChanges();
            if (this.applicationMenu) {
                this.initNavbarMenu();
            }
        });
    }
    ngAfterViewInit() {
        this.displayItemsNavigation();
    }
    ngOnDestroy() {
        var _a, _b, _c;
        if (this.mediaQuery) {
            this.mediaQuery.removeListener(this.onMediaQueryChange);
        }
        (_a = this.removedMenuSubscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
        (_b = this.applicationMenuSubscription) === null || _b === void 0 ? void 0 : _b.unsubscribe();
        (_c = this.menusSubscription) === null || _c === void 0 ? void 0 : _c.unsubscribe();
    }
    navigateItems(orientation) {
        orientation === 'left' ? this.navigateLeft() : this.navigateRight();
        this.animate(this.offset);
    }
    validateMenuLogo() {
        if (this.applicationMenu.logo && this.logo) {
            this.applicationMenu.logo = undefined;
            this.changeDetector.detectChanges();
        }
    }
    allNavbarItemsWidth() {
        return this.navbarItems.allNavbarItems.reduce((previous, current) => previous + current.nativeElement.offsetWidth, 0);
    }
    animate(offset) {
        const animation = this.buildTransitionAnimation(offset);
        this.player = animation.create(this.navbarItems.navbarItemsContainer.nativeElement);
        this.player.play();
    }
    buildTransitionAnimation(offset) {
        return this.builder.build([animate(poNavbarTiming, keyframes([style({ transform: `translateX(${-offset}px)` })]))]);
    }
    changeNavbarMenuItems(isCollapsedMedia, navbarItems, label) {
        if (isCollapsedMedia) {
            this.applicationMenu.menus = [{ label, subItems: navbarItems, id: this.id }, ...this.applicationMenu.menus];
        }
        else {
            this.applicationMenu.menus = this.applicationMenu.menus.filter(m => m.id !== this.id);
        }
        this.isNavbarUpdateMenu = true;
        this.changeDetector.detectChanges();
    }
    calculateLeftNavigation() {
        let calculatedOffset;
        this.navbarItems.allNavbarItems.some(navbarItem => {
            const navbarItemOffset = navbarItem.nativeElement.offsetLeft;
            const navbarItemWidth = navbarItem.nativeElement.offsetWidth;
            if (navbarItemOffset >= this.offset) {
                calculatedOffset = navbarItemOffset - (this.navbarItemsWidth() - navbarItemWidth);
                return true;
            }
        });
        return calculatedOffset;
    }
    calculateRightNavigation(itemBreakPoint) {
        let calculatedOffset;
        this.navbarItems.allNavbarItems.some(navbarItem => {
            const offsetLeft = navbarItem.nativeElement.offsetLeft;
            const finalPosition = navbarItem.nativeElement.offsetWidth + offsetLeft;
            if (itemBreakPoint < finalPosition) {
                calculatedOffset = offsetLeft;
                return true;
            }
        });
        return calculatedOffset;
    }
    displayItemsNavigation() {
        this.showItemsNavigation = this.navbarItemsWidth() < this.allNavbarItemsWidth() + poNavbarNavigationWidth;
        this.changeDetector.detectChanges();
        if (this.offset !== 0) {
            this.setOffsetToZero();
            this.animate(this.offset);
        }
    }
    initNavbarMenu() {
        this.mediaQuery = window.matchMedia(poNavbarMatchMedia);
        if (this.isCollapsedMedia) {
            this.changeNavbarMenuItems(true, this.items, this.literals.navbarLinks);
        }
        this.validateMenuLogo();
        this.mediaQuery.addListener(this.onMediaQueryChange);
    }
    navbarItemsWidth() {
        return this.navbarItemsElement.nativeElement.offsetWidth;
    }
    navigateLeft() {
        this.disableRight = false;
        this.offset = this.calculateLeftNavigation();
        if (this.offset < 0) {
            this.setOffsetToZero();
        }
    }
    navigateRight() {
        const maxAllowedOffset = this.allNavbarItemsWidth() - this.navbarItemsWidth();
        const itemBreakPoint = this.offset + this.navbarItemsWidth();
        this.offset = this.calculateRightNavigation(itemBreakPoint);
        this.validateMaxOffset(maxAllowedOffset);
    }
    setOffsetToZero() {
        this.offset = 0;
    }
    validateMaxOffset(maxAllowedOffset) {
        if (this.offset >= maxAllowedOffset) {
            this.offset = maxAllowedOffset;
            this.disableRight = true;
        }
    }
}
PoNavbarComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-navbar',
                template: "<header class=\"po-navbar\" [ngClass]=\"{ 'po-navbar-shadow': shadow }\">\n  <po-navbar-logo\n    class=\"po-navbar-logo\"\n    [ngClass]=\"{ 'po-navbar-logo-menu': !!applicationMenu, 'po-navbar-no-logo': !logo }\"\n    [p-logo]=\"logo\"\n  >\n  </po-navbar-logo>\n\n  <po-navbar-items class=\"po-navbar-items\" [p-items]=\"items\"> </po-navbar-items>\n\n  <po-navbar-item-navigation\n    *ngIf=\"showItemsNavigation\"\n    class=\"po-navbar-item-navigation\"\n    [p-disable-left]=\"navbarItemNavigationDisableLeft\"\n    [p-disable-right]=\"navbarItemNavigationDisableRight\"\n    (p-click)=\"navigateItems($event)\"\n  >\n  </po-navbar-item-navigation>\n\n  <po-navbar-actions class=\"po-navbar-actions\" [p-icon-actions]=\"iconActions\"> </po-navbar-actions>\n</header>\n\n<po-menu *ngIf=\"!applicationMenu\" [p-menus]=\"items\"> </po-menu>\n"
            },] }
];
PoNavbarComponent.ctorParameters = () => [
    { type: PoLanguageService },
    { type: Renderer2 },
    { type: AnimationBuilder },
    { type: ChangeDetectorRef },
    { type: PoMenuGlobalService }
];
PoNavbarComponent.propDecorators = {
    navbarItemsElement: [{ type: ViewChild, args: [PoNavbarItemsComponent, { read: ElementRef, static: true },] }],
    navbarItems: [{ type: ViewChild, args: [PoNavbarItemsComponent, { static: true },] }],
    menuComponent: [{ type: ViewChild, args: [PoMenuComponent,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbmF2YmFyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1uYXZiYXIvcG8tbmF2YmFyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxVQUFVLEVBR1YsU0FBUyxFQUNULFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFxQyxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckgsT0FBTyxFQUFFLEtBQUssRUFBb0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUd6RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDbkYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFFakYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRS9ELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRW5FLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBRXJGLE1BQU0sdUJBQXVCLEdBQUcsRUFBRSxDQUFDO0FBQ25DLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxDQUFDO0FBQzlCLE1BQU0sa0JBQWtCLEdBQUcsZUFBZSxpQkFBaUIsS0FBSyxDQUFDO0FBQ2pFLE1BQU0sY0FBYyxHQUFHLFlBQVksQ0FBQztBQUVwQzs7R0FFRztBQUtILE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxxQkFBcUI7SUEyQzFELFlBQ0UsaUJBQW9DLEVBQzVCLFFBQW1CLEVBQ25CLE9BQXlCLEVBQ3pCLGNBQWlDLEVBQ2pDLGlCQUFzQztRQUU5QyxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUxqQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLFlBQU8sR0FBUCxPQUFPLENBQWtCO1FBQ3pCLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtRQUNqQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBMUNoRCx3QkFBbUIsR0FBWSxLQUFLLENBQUM7UUFNN0IsdUJBQWtCLEdBQVksS0FBSyxDQUFDO1FBQ3BDLE9BQUUsR0FBRyxJQUFJLEVBQUUsQ0FBQztRQUVaLFdBQU0sR0FBVyxDQUFDLENBQUM7UUFJbkIsdUJBQWtCLEdBQUcsRUFBRSxDQUFDO1FBeU54Qix1QkFBa0IsR0FBRyxPQUFPLENBQUMsRUFBRTtZQUNyQyxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDckYsQ0FBQyxDQUFDO1FBM0xBLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM3RyxDQUFDO0lBM0JELElBQUksK0JBQStCO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQUksZ0NBQWdDO1FBQ2xDLE9BQU8sSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsSUFBZ0MsYUFBYSxDQUFDLElBQXFCO1FBQ2pFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1FBRTNCLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxDQUFBLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxFQUFFLEtBQUksSUFBSSxDQUFDLHVCQUF1QixDQUFDO0lBQzFFLENBQUM7SUFFRCxJQUFZLGdCQUFnQjtRQUMxQixPQUFPLE1BQU0sQ0FBQyxVQUFVLEdBQUcsaUJBQWlCLENBQUM7SUFDL0MsQ0FBQztJQWFELFFBQVE7UUFDTixnR0FBZ0c7UUFDaEcsa0dBQWtHO1FBQ2xHLCtGQUErRjtRQUMvRiwrREFBK0Q7UUFDL0QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFOztZQUNqRixNQUFNLDJCQUEyQixHQUMvQixDQUFBLE1BQUEsSUFBSSxDQUFDLGtCQUFrQiwwQ0FBRSxNQUFNLE1BQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUVyRixJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxrQkFBa0IsSUFBSSwyQkFBMkIsRUFBRTtnQkFDM0csSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQztnQkFFaEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEdBQUc7b0JBQzNCLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO29CQUN2RSxHQUFHLFFBQVE7aUJBQ1osQ0FBQzthQUNIO1lBRUQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQztZQUNoQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsUUFBUSxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyw4QkFBOEIsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDN0csK0ZBQStGO1lBQy9GLDhGQUE4RjtZQUM5RiwrRkFBK0Y7WUFDL0YsSUFBSSxDQUFDLGVBQWU7Z0JBQ2xCLElBQUksQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLHVCQUF1QixLQUFLLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBRTVHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7WUFFcEMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDNUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7YUFDekQ7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQywyQkFBMkIsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsdUJBQXVCO2FBQzlFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDaEIsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ25CLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixLQUFLLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBRXpGLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7WUFFcEMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN4QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7YUFDdkI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxlQUFlO1FBQ2IsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUVELFdBQVc7O1FBQ1QsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3pEO1FBRUQsTUFBQSxJQUFJLENBQUMsdUJBQXVCLDBDQUFFLFdBQVcsRUFBRSxDQUFDO1FBQzVDLE1BQUEsSUFBSSxDQUFDLDJCQUEyQiwwQ0FBRSxXQUFXLEVBQUUsQ0FBQztRQUNoRCxNQUFBLElBQUksQ0FBQyxpQkFBaUIsMENBQUUsV0FBVyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVELGFBQWEsQ0FBQyxXQUFtQjtRQUMvQixXQUFXLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUVwRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRVMsZ0JBQWdCO1FBQ3hCLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUMxQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUM7WUFDdEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUNyQztJQUNILENBQUM7SUFFTyxtQkFBbUI7UUFDekIsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQzNDLENBQUMsUUFBYSxFQUFFLE9BQVksRUFBRSxFQUFFLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUM3RSxDQUFDLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyxPQUFPLENBQUMsTUFBYztRQUM1QixNQUFNLFNBQVMsR0FBcUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTFFLElBQUksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVPLHdCQUF3QixDQUFDLE1BQWM7UUFDN0MsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsU0FBUyxFQUFFLGNBQWMsQ0FBQyxNQUFNLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RILENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxnQkFBcUIsRUFBRSxXQUFnQyxFQUFFLEtBQWE7UUFDbEcsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDN0c7YUFBTTtZQUNMLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZGO1FBRUQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUUvQixJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3RDLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsSUFBSSxnQkFBd0IsQ0FBQztRQUU3QixJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDaEQsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQztZQUM3RCxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQztZQUU3RCxJQUFJLGdCQUFnQixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ25DLGdCQUFnQixHQUFHLGdCQUFnQixHQUFHLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsZUFBZSxDQUFDLENBQUM7Z0JBQ2xGLE9BQU8sSUFBSSxDQUFDO2FBQ2I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUVPLHdCQUF3QixDQUFDLGNBQXNCO1FBQ3JELElBQUksZ0JBQXdCLENBQUM7UUFFN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ2hELE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDO1lBQ3ZELE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQztZQUV4RSxJQUFJLGNBQWMsR0FBRyxhQUFhLEVBQUU7Z0JBQ2xDLGdCQUFnQixHQUFHLFVBQVUsQ0FBQztnQkFDOUIsT0FBTyxJQUFJLENBQUM7YUFDYjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxnQkFBZ0IsQ0FBQztJQUMxQixDQUFDO0lBRU8sc0JBQXNCO1FBQzVCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsR0FBRyx1QkFBdUIsQ0FBQztRQUUxRyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXBDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztJQUVPLGNBQWM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFFeEQsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDekU7UUFFRCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUV4QixJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRU8sZ0JBQWdCO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUM7SUFDM0QsQ0FBQztJQUVPLFlBQVk7UUFDbEIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFFMUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUU3QyxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ25CLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUN4QjtJQUNILENBQUM7SUFFTyxhQUFhO1FBQ25CLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDOUUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUU3RCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBTU8sZUFBZTtRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRU8saUJBQWlCLENBQUMsZ0JBQXdCO1FBQ2hELElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxnQkFBZ0IsRUFBRTtZQUNuQyxJQUFJLENBQUMsTUFBTSxHQUFHLGdCQUFnQixDQUFDO1lBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1NBQzFCO0lBQ0gsQ0FBQzs7O1lBN1BGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsV0FBVztnQkFDckIsMDFCQUF5QzthQUMxQzs7O1lBcEJRLGlCQUFpQjtZQVR4QixTQUFTO1lBR08sZ0JBQWdCO1lBUmhDLGlCQUFpQjtZQWVWLG1CQUFtQjs7O2lDQXFCekIsU0FBUyxTQUFDLHNCQUFzQixFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzBCQUVwRSxTQUFTLFNBQUMsc0JBQXNCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzRCQThCbEQsU0FBUyxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgUmVuZGVyZXIyLFxuICBWaWV3Q2hpbGRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBhbmltYXRlLCBBbmltYXRpb25CdWlsZGVyLCBBbmltYXRpb25GYWN0b3J5LCBBbmltYXRpb25QbGF5ZXIsIGtleWZyYW1lcywgc3R5bGUgfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcblxuaW1wb3J0IHsgZGVsYXksIGZpbHRlciwgZmluYWxpemUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgdXVpZCB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IFBvTWVudUdsb2JhbFNlcnZpY2UgfSBmcm9tICcuLi9wby1tZW51L3NlcnZpY2VzL3BvLW1lbnUtZ2xvYmFsLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9NZW51SXRlbSB9IGZyb20gJy4uL3BvLW1lbnUvcG8tbWVudS1pdGVtLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb01lbnVDb21wb25lbnQgfSBmcm9tICcuLi9wby1tZW51L3BvLW1lbnUuY29tcG9uZW50JztcblxuaW1wb3J0IHsgUG9OYXZiYXJCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1uYXZiYXItYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9OYXZiYXJJdGVtIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLW5hdmJhci1pdGVtLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb05hdmJhckl0ZW1zQ29tcG9uZW50IH0gZnJvbSAnLi9wby1uYXZiYXItaXRlbXMvcG8tbmF2YmFyLWl0ZW1zLmNvbXBvbmVudCc7XG5cbmNvbnN0IHBvTmF2YmFyTmF2aWdhdGlvbldpZHRoID0gODg7XG5jb25zdCBwb05hdmJhck1lbnVNZWRpYSA9IDc2ODtcbmNvbnN0IHBvTmF2YmFyTWF0Y2hNZWRpYSA9IGAobWF4LXdpZHRoOiAke3BvTmF2YmFyTWVudU1lZGlhfXB4KWA7XG5jb25zdCBwb05hdmJhclRpbWluZyA9ICcyNTBtcyBlYXNlJztcblxuLyoqXG4gKiBAZG9jc0V4dGVuZHMgUG9OYXZiYXJCYXNlQ29tcG9uZW50XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLW5hdmJhcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1uYXZiYXIuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvTmF2YmFyQ29tcG9uZW50IGV4dGVuZHMgUG9OYXZiYXJCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPbkluaXQge1xuICBAVmlld0NoaWxkKFBvTmF2YmFySXRlbXNDb21wb25lbnQsIHsgcmVhZDogRWxlbWVudFJlZiwgc3RhdGljOiB0cnVlIH0pIG5hdmJhckl0ZW1zRWxlbWVudDogRWxlbWVudFJlZjtcblxuICBAVmlld0NoaWxkKFBvTmF2YmFySXRlbXNDb21wb25lbnQsIHsgc3RhdGljOiB0cnVlIH0pIG5hdmJhckl0ZW1zOiBQb05hdmJhckl0ZW1zQ29tcG9uZW50O1xuXG4gIGRpc2FibGVSaWdodDogYm9vbGVhbjtcbiAgc2hvd0l0ZW1zTmF2aWdhdGlvbjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByb3RlY3RlZCB3aW5kb3dSZXNpemVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcblxuICBwcml2YXRlIF9tZW51Q29tcG9uZW50O1xuXG4gIHByaXZhdGUgaXNOYXZiYXJVcGRhdGVNZW51OiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgaWQgPSB1dWlkKCk7XG4gIHByaXZhdGUgbWVkaWFRdWVyeTogYW55O1xuICBwcml2YXRlIG9mZnNldDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBwbGF5ZXI6IEFuaW1hdGlvblBsYXllcjtcbiAgcHJpdmF0ZSBtZW51SXRlbXM6IEFycmF5PFBvTWVudUl0ZW0+O1xuICBwcml2YXRlIHByZXZpb3VzTWVudUNvbXBvbmVudElkO1xuICBwcml2YXRlIHByZXZpb3VzTWVudXNJdGVtcyA9IFtdO1xuXG4gIHByaXZhdGUgYXBwbGljYXRpb25NZW51U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgbWVudXNTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSByZW1vdmVkTWVudVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGdldCBuYXZiYXJJdGVtTmF2aWdhdGlvbkRpc2FibGVMZWZ0KCkge1xuICAgIHJldHVybiB0aGlzLm9mZnNldCA9PT0gMDtcbiAgfVxuXG4gIGdldCBuYXZiYXJJdGVtTmF2aWdhdGlvbkRpc2FibGVSaWdodCgpIHtcbiAgICByZXR1cm4gdGhpcy5kaXNhYmxlUmlnaHQgJiYgdGhpcy5vZmZzZXQgIT09IDA7XG4gIH1cblxuICBAVmlld0NoaWxkKFBvTWVudUNvbXBvbmVudCkgc2V0IG1lbnVDb21wb25lbnQobWVudTogUG9NZW51Q29tcG9uZW50KSB7XG4gICAgdGhpcy5fbWVudUNvbXBvbmVudCA9IG1lbnU7XG5cbiAgICB0aGlzLnByZXZpb3VzTWVudUNvbXBvbmVudElkID0gbWVudT8uaWQgfHwgdGhpcy5wcmV2aW91c01lbnVDb21wb25lbnRJZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGlzQ29sbGFwc2VkTWVkaWEoKSB7XG4gICAgcmV0dXJuIHdpbmRvdy5pbm5lcldpZHRoIDwgcG9OYXZiYXJNZW51TWVkaWE7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwb0xhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgYnVpbGRlcjogQW5pbWF0aW9uQnVpbGRlcixcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIG1lbnVHbG9iYWxTZXJ2aWNlOiBQb01lbnVHbG9iYWxTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKHBvTGFuZ3VhZ2VTZXJ2aWNlKTtcbiAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyID0gdGhpcy5yZW5kZXJlci5saXN0ZW4od2luZG93LCAncmVzaXplJywgdGhpcy5kaXNwbGF5SXRlbXNOYXZpZ2F0aW9uLmJpbmQodGhpcykpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgLy8gbmVjZXNzw6FyaW8gcGFyYSBxdWFuZG8gbyBtZW51IGRhIGFwbGljYcOnw6NvIGNhcnJlZ2FyIG9zIGl0ZW5zIGxhenkgZSBuYXZiYXIgZXN0aXZlciBjb2xhcHNhZG8sXG4gICAgLy8gcXVhbmRvIGlzc28gYWNvbnRlY2UsIG8gbmF2YmFyIGluY2x1aSAxIGl0ZW0gZGUgbWVudSBcIk5hdmJhciBsaW5rc1wiLCBwb3J0YW50byDDqSByZW1vdmlkbyBxdWFuZG9cbiAgICAvLyBvcyBub3ZvcyBpdGVucyBkZSBtZW51IMOpIGNhcnJlZ2FkbywgYSBwYXJ0aXIgZGlzc28gZXN0ZSB0cmF0YW1lbnRvIMOpIG5lY2Vzc2FyaW8gcGFyYSBpbmNsdWlyXG4gICAgLy8gbyBuYXZiYXIgbGlua3MgYXBvcyBhIGFkacOnw6NvIGRvcyBpdGVucyBkZSBtZW51IGRhIGFwbGljYcOnw6NvLlxuICAgIHRoaXMubWVudXNTdWJzY3JpcHRpb24gPSB0aGlzLm1lbnVHbG9iYWxTZXJ2aWNlLnJlY2VpdmVNZW51cyQuc3Vic2NyaWJlKG5ld01lbnVzID0+IHtcbiAgICAgIGNvbnN0IHByZXZpb3VzTWVudXNpSXNOYXZiYXJMaW5rcyA9XG4gICAgICAgIHRoaXMucHJldmlvdXNNZW51c0l0ZW1zPy5sZW5ndGggPT09IDEgJiYgdGhpcy5wcmV2aW91c01lbnVzSXRlbXNbMF0uaWQgPT09IHRoaXMuaWQ7XG5cbiAgICAgIGlmICh0aGlzLmFwcGxpY2F0aW9uTWVudSAmJiB0aGlzLmlzQ29sbGFwc2VkTWVkaWEgJiYgdGhpcy5pc05hdmJhclVwZGF0ZU1lbnUgJiYgcHJldmlvdXNNZW51c2lJc05hdmJhckxpbmtzKSB7XG4gICAgICAgIHRoaXMuaXNOYXZiYXJVcGRhdGVNZW51ID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbk1lbnUubWVudXMgPSBbXG4gICAgICAgICAgeyBsYWJlbDogdGhpcy5saXRlcmFscy5uYXZiYXJMaW5rcywgc3ViSXRlbXM6IHRoaXMuaXRlbXMsIGlkOiB0aGlzLmlkIH0sXG4gICAgICAgICAgLi4ubmV3TWVudXNcbiAgICAgICAgXTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5pc05hdmJhclVwZGF0ZU1lbnUgPSBmYWxzZTtcbiAgICAgIHRoaXMucHJldmlvdXNNZW51c0l0ZW1zID0gbmV3TWVudXM7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlbW92ZWRNZW51U3Vic2NyaXB0aW9uID0gdGhpcy5tZW51R2xvYmFsU2VydmljZS5yZWNlaXZlUmVtb3ZlZEFwcGxpY2F0aW9uTWVudSQuc3Vic2NyaWJlKHJlbW92ZWRNZW51SWQgPT4ge1xuICAgICAgLy8gdmVyaWZpY2Egc2UgbyBtZW51IHJlbW92aWRvIGZvaSBvIHByZXNlbnRlIG5vIG5hdmJhciwgY2FzbyBzaW0sIGVsZSBtYW50ZW0gbyBhcHBsaWN0aW9uTWVudS5cbiAgICAgIC8vIMOpIHByZWNpc28gcGFyYSB0cmF0YXIgYSBzZXF1ZW5jaWEgZG8gbmdEZXN0cm95LCBxdWFuZG8gbyBtZW51IGRvIG5hdmJhciBlcmEgcmVtb3ZpZG8gZG8gRE9NXG4gICAgICAvLyBkaXNwYXJhdmEgZXNzZSBldmVudG8sIHNlbmRvIG5lY2Vzc2FyaW8gdHJhdGFyLCBwYXJhIG7Do28gdG9ybmFyIGluZGVmaW5pZG8gbyBhcHBsaWNhdGlvbk1lbnVcbiAgICAgIHRoaXMuYXBwbGljYXRpb25NZW51ID1cbiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbk1lbnUgJiYgdGhpcy5wcmV2aW91c01lbnVDb21wb25lbnRJZCA9PT0gcmVtb3ZlZE1lbnVJZCA/IHRoaXMuYXBwbGljYXRpb25NZW51IDogdW5kZWZpbmVkO1xuXG4gICAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcblxuICAgICAgaWYgKCF0aGlzLmFwcGxpY2F0aW9uTWVudSAmJiB0aGlzLm1lZGlhUXVlcnkpIHtcbiAgICAgICAgdGhpcy5tZWRpYVF1ZXJ5LnJlbW92ZUxpc3RlbmVyKHRoaXMub25NZWRpYVF1ZXJ5Q2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuYXBwbGljYXRpb25NZW51U3Vic2NyaXB0aW9uID0gdGhpcy5tZW51R2xvYmFsU2VydmljZS5yZWNlaXZlQXBwbGljYXRpb25NZW51JFxuICAgICAgLnBpcGUoZGVsYXkoMTAwKSlcbiAgICAgIC5zdWJzY3JpYmUobmV3TWVudSA9PiB7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb25NZW51ID0gdGhpcy5wcmV2aW91c01lbnVDb21wb25lbnRJZCA9PT0gbmV3TWVudS5pZCA/IHVuZGVmaW5lZCA6IG5ld01lbnU7XG5cbiAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuYXBwbGljYXRpb25NZW51KSB7XG4gICAgICAgICAgdGhpcy5pbml0TmF2YmFyTWVudSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmRpc3BsYXlJdGVtc05hdmlnYXRpb24oKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLm1lZGlhUXVlcnkpIHtcbiAgICAgIHRoaXMubWVkaWFRdWVyeS5yZW1vdmVMaXN0ZW5lcih0aGlzLm9uTWVkaWFRdWVyeUNoYW5nZSk7XG4gICAgfVxuXG4gICAgdGhpcy5yZW1vdmVkTWVudVN1YnNjcmlwdGlvbj8udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLmFwcGxpY2F0aW9uTWVudVN1YnNjcmlwdGlvbj8udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLm1lbnVzU3Vic2NyaXB0aW9uPy51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgbmF2aWdhdGVJdGVtcyhvcmllbnRhdGlvbjogc3RyaW5nKSB7XG4gICAgb3JpZW50YXRpb24gPT09ICdsZWZ0JyA/IHRoaXMubmF2aWdhdGVMZWZ0KCkgOiB0aGlzLm5hdmlnYXRlUmlnaHQoKTtcblxuICAgIHRoaXMuYW5pbWF0ZSh0aGlzLm9mZnNldCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdmFsaWRhdGVNZW51TG9nbygpIHtcbiAgICBpZiAodGhpcy5hcHBsaWNhdGlvbk1lbnUubG9nbyAmJiB0aGlzLmxvZ28pIHtcbiAgICAgIHRoaXMuYXBwbGljYXRpb25NZW51LmxvZ28gPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFsbE5hdmJhckl0ZW1zV2lkdGgoKSB7XG4gICAgcmV0dXJuIHRoaXMubmF2YmFySXRlbXMuYWxsTmF2YmFySXRlbXMucmVkdWNlKFxuICAgICAgKHByZXZpb3VzOiBhbnksIGN1cnJlbnQ6IGFueSkgPT4gcHJldmlvdXMgKyBjdXJyZW50Lm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGgsXG4gICAgICAwXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYW5pbWF0ZShvZmZzZXQ6IG51bWJlcikge1xuICAgIGNvbnN0IGFuaW1hdGlvbjogQW5pbWF0aW9uRmFjdG9yeSA9IHRoaXMuYnVpbGRUcmFuc2l0aW9uQW5pbWF0aW9uKG9mZnNldCk7XG5cbiAgICB0aGlzLnBsYXllciA9IGFuaW1hdGlvbi5jcmVhdGUodGhpcy5uYXZiYXJJdGVtcy5uYXZiYXJJdGVtc0NvbnRhaW5lci5uYXRpdmVFbGVtZW50KTtcbiAgICB0aGlzLnBsYXllci5wbGF5KCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkVHJhbnNpdGlvbkFuaW1hdGlvbihvZmZzZXQ6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmJ1aWxkZXIuYnVpbGQoW2FuaW1hdGUocG9OYXZiYXJUaW1pbmcsIGtleWZyYW1lcyhbc3R5bGUoeyB0cmFuc2Zvcm06IGB0cmFuc2xhdGVYKCR7LW9mZnNldH1weClgIH0pXSkpXSk7XG4gIH1cblxuICBwcml2YXRlIGNoYW5nZU5hdmJhck1lbnVJdGVtcyhpc0NvbGxhcHNlZE1lZGlhOiBhbnksIG5hdmJhckl0ZW1zOiBBcnJheTxQb05hdmJhckl0ZW0+LCBsYWJlbDogc3RyaW5nKSB7XG4gICAgaWYgKGlzQ29sbGFwc2VkTWVkaWEpIHtcbiAgICAgIHRoaXMuYXBwbGljYXRpb25NZW51Lm1lbnVzID0gW3sgbGFiZWwsIHN1Ykl0ZW1zOiBuYXZiYXJJdGVtcywgaWQ6IHRoaXMuaWQgfSwgLi4udGhpcy5hcHBsaWNhdGlvbk1lbnUubWVudXNdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFwcGxpY2F0aW9uTWVudS5tZW51cyA9IHRoaXMuYXBwbGljYXRpb25NZW51Lm1lbnVzLmZpbHRlcihtID0+IG0uaWQgIT09IHRoaXMuaWQpO1xuICAgIH1cblxuICAgIHRoaXMuaXNOYXZiYXJVcGRhdGVNZW51ID0gdHJ1ZTtcblxuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVMZWZ0TmF2aWdhdGlvbigpIHtcbiAgICBsZXQgY2FsY3VsYXRlZE9mZnNldDogbnVtYmVyO1xuXG4gICAgdGhpcy5uYXZiYXJJdGVtcy5hbGxOYXZiYXJJdGVtcy5zb21lKG5hdmJhckl0ZW0gPT4ge1xuICAgICAgY29uc3QgbmF2YmFySXRlbU9mZnNldCA9IG5hdmJhckl0ZW0ubmF0aXZlRWxlbWVudC5vZmZzZXRMZWZ0O1xuICAgICAgY29uc3QgbmF2YmFySXRlbVdpZHRoID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuXG4gICAgICBpZiAobmF2YmFySXRlbU9mZnNldCA+PSB0aGlzLm9mZnNldCkge1xuICAgICAgICBjYWxjdWxhdGVkT2Zmc2V0ID0gbmF2YmFySXRlbU9mZnNldCAtICh0aGlzLm5hdmJhckl0ZW1zV2lkdGgoKSAtIG5hdmJhckl0ZW1XaWR0aCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjYWxjdWxhdGVkT2Zmc2V0O1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVSaWdodE5hdmlnYXRpb24oaXRlbUJyZWFrUG9pbnQ6IG51bWJlcikge1xuICAgIGxldCBjYWxjdWxhdGVkT2Zmc2V0OiBudW1iZXI7XG5cbiAgICB0aGlzLm5hdmJhckl0ZW1zLmFsbE5hdmJhckl0ZW1zLnNvbWUobmF2YmFySXRlbSA9PiB7XG4gICAgICBjb25zdCBvZmZzZXRMZWZ0ID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldExlZnQ7XG4gICAgICBjb25zdCBmaW5hbFBvc2l0aW9uID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoICsgb2Zmc2V0TGVmdDtcblxuICAgICAgaWYgKGl0ZW1CcmVha1BvaW50IDwgZmluYWxQb3NpdGlvbikge1xuICAgICAgICBjYWxjdWxhdGVkT2Zmc2V0ID0gb2Zmc2V0TGVmdDtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNhbGN1bGF0ZWRPZmZzZXQ7XG4gIH1cblxuICBwcml2YXRlIGRpc3BsYXlJdGVtc05hdmlnYXRpb24oKSB7XG4gICAgdGhpcy5zaG93SXRlbXNOYXZpZ2F0aW9uID0gdGhpcy5uYXZiYXJJdGVtc1dpZHRoKCkgPCB0aGlzLmFsbE5hdmJhckl0ZW1zV2lkdGgoKSArIHBvTmF2YmFyTmF2aWdhdGlvbldpZHRoO1xuXG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICBpZiAodGhpcy5vZmZzZXQgIT09IDApIHtcbiAgICAgIHRoaXMuc2V0T2Zmc2V0VG9aZXJvKCk7XG4gICAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdE5hdmJhck1lbnUoKSB7XG4gICAgdGhpcy5tZWRpYVF1ZXJ5ID0gd2luZG93Lm1hdGNoTWVkaWEocG9OYXZiYXJNYXRjaE1lZGlhKTtcblxuICAgIGlmICh0aGlzLmlzQ29sbGFwc2VkTWVkaWEpIHtcbiAgICAgIHRoaXMuY2hhbmdlTmF2YmFyTWVudUl0ZW1zKHRydWUsIHRoaXMuaXRlbXMsIHRoaXMubGl0ZXJhbHMubmF2YmFyTGlua3MpO1xuICAgIH1cblxuICAgIHRoaXMudmFsaWRhdGVNZW51TG9nbygpO1xuXG4gICAgdGhpcy5tZWRpYVF1ZXJ5LmFkZExpc3RlbmVyKHRoaXMub25NZWRpYVF1ZXJ5Q2hhbmdlKTtcbiAgfVxuXG4gIHByaXZhdGUgbmF2YmFySXRlbXNXaWR0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5uYXZiYXJJdGVtc0VsZW1lbnQubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aDtcbiAgfVxuXG4gIHByaXZhdGUgbmF2aWdhdGVMZWZ0KCkge1xuICAgIHRoaXMuZGlzYWJsZVJpZ2h0ID0gZmFsc2U7XG5cbiAgICB0aGlzLm9mZnNldCA9IHRoaXMuY2FsY3VsYXRlTGVmdE5hdmlnYXRpb24oKTtcblxuICAgIGlmICh0aGlzLm9mZnNldCA8IDApIHtcbiAgICAgIHRoaXMuc2V0T2Zmc2V0VG9aZXJvKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBuYXZpZ2F0ZVJpZ2h0KCkge1xuICAgIGNvbnN0IG1heEFsbG93ZWRPZmZzZXQgPSB0aGlzLmFsbE5hdmJhckl0ZW1zV2lkdGgoKSAtIHRoaXMubmF2YmFySXRlbXNXaWR0aCgpO1xuICAgIGNvbnN0IGl0ZW1CcmVha1BvaW50ID0gdGhpcy5vZmZzZXQgKyB0aGlzLm5hdmJhckl0ZW1zV2lkdGgoKTtcblxuICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5jYWxjdWxhdGVSaWdodE5hdmlnYXRpb24oaXRlbUJyZWFrUG9pbnQpO1xuXG4gICAgdGhpcy52YWxpZGF0ZU1heE9mZnNldChtYXhBbGxvd2VkT2Zmc2V0KTtcbiAgfVxuXG4gIHByaXZhdGUgb25NZWRpYVF1ZXJ5Q2hhbmdlID0gY2hhbmdlZCA9PiB7XG4gICAgdGhpcy5jaGFuZ2VOYXZiYXJNZW51SXRlbXMoY2hhbmdlZC5tYXRjaGVzLCB0aGlzLml0ZW1zLCB0aGlzLmxpdGVyYWxzLm5hdmJhckxpbmtzKTtcbiAgfTtcblxuICBwcml2YXRlIHNldE9mZnNldFRvWmVybygpIHtcbiAgICB0aGlzLm9mZnNldCA9IDA7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlTWF4T2Zmc2V0KG1heEFsbG93ZWRPZmZzZXQ6IG51bWJlcikge1xuICAgIGlmICh0aGlzLm9mZnNldCA+PSBtYXhBbGxvd2VkT2Zmc2V0KSB7XG4gICAgICB0aGlzLm9mZnNldCA9IG1heEFsbG93ZWRPZmZzZXQ7XG4gICAgICB0aGlzLmRpc2FibGVSaWdodCA9IHRydWU7XG4gICAgfVxuICB9XG59XG4iXX0=