import { ChangeDetectorRef, Directive, EventEmitter, Input, NgZone, Output, ViewChildren } from '@angular/core';
import { PoChartStartAngle, PoChartCompleteCircle, PoChartAngleStepInterval } from '../../helpers/po-chart-default-values.constant';
export class PoChartCircularComponent {
    constructor(ngZone, changeDetector) {
        this.ngZone = ngZone;
        this.changeDetector = changeDetector;
        this.circularClick = new EventEmitter();
        this.circularHover = new EventEmitter();
        this.canDisplayLabels = false;
        this.seriesLabels = [];
        this.showLabels = false;
    }
    set options(value) {
        if (!isNaN(value === null || value === void 0 ? void 0 : value.innerRadius)) {
            this._options = value;
            this.innerRadius = Math.min(Math.max(this._options.innerRadius, 0), 100);
        }
    }
    get options() {
        return this._options;
    }
    set series(value) {
        this._series = value;
        this.animate = true;
    }
    get series() {
        return this._series;
    }
    onSerieClick(selectedItem) {
        this.circularClick.emit(selectedItem);
    }
    onSerieHover(selectedItem) {
        this.circularHover.emit(selectedItem);
    }
    calculateAngle(data, totalValue) {
        return (data / totalValue) * (Math.PI * 2);
    }
    drawSeries(series = [], height) {
        this.seriesList = [];
        this.showLabels = false;
        this.totalValue = this.calculateTotalValue(series);
        if (this.totalValue && this.totalValue > 0) {
            this.seriesList = this.validateSeries(series);
            this.changeDetector.detectChanges();
            if (this.seriesList.length && this.svgPaths) {
                this.initDrawPaths(this.seriesList, this.totalValue, height);
            }
        }
    }
    calculateTotalValue(series) {
        return series.reduce((previousValue, serie) => {
            const data = serie.data ? serie.data : serie.value;
            return previousValue + (data > 0 ? data : 0);
        }, 0);
    }
    calculateSerieCoordinates(series, totalValue, height) {
        let startRadianAngle;
        let endRadianAngle = PoChartStartAngle;
        series.forEach((serie, index) => {
            startRadianAngle = endRadianAngle;
            endRadianAngle = startRadianAngle + this.calculateAngle(serie.data, totalValue) - PoChartCompleteCircle;
            const coordinates = this.calculateCoordinates(height, startRadianAngle, endRadianAngle);
            this.svgPaths.toArray()[index].applyCoordinates(coordinates);
            this.showLabels = this.canDisplayLabels;
        });
    }
    calculateCoordinatesWithAnimation(series, totalValue, height, startRadianAngle, endRadianAngle, currentRadianAngle = 0, seriesIndex = 0) {
        const finishedCurrentSerie = currentRadianAngle > endRadianAngle;
        const finishedAllSeries = seriesIndex === series.length;
        if (finishedAllSeries) {
            this.animate = false;
            return;
        }
        if (finishedCurrentSerie) {
            this.setSerieLabelCoordinates(seriesIndex);
            currentRadianAngle = 0;
            seriesIndex++;
            startRadianAngle = startRadianAngle + endRadianAngle;
            endRadianAngle =
                seriesIndex < series.length ? this.calculateAngle(series[seriesIndex].data, totalValue) : undefined;
        }
        else {
            currentRadianAngle += PoChartAngleStepInterval;
            const currentEndRadianAngle = this.calculateCurrentEndAngle(currentRadianAngle, startRadianAngle, endRadianAngle);
            const coordinates = this.calculateCoordinates(height, startRadianAngle, currentEndRadianAngle);
            this.svgPaths.toArray()[seriesIndex].applyCoordinates(coordinates);
        }
        window.requestAnimationFrame(this.calculateCoordinatesWithAnimation.bind(this, series, totalValue, height, startRadianAngle, endRadianAngle, currentRadianAngle, seriesIndex));
    }
    calculateCurrentEndAngle(currentRadianAngle, startRadianAngle, endRadianAngle) {
        const isSerieDrawCompleted = startRadianAngle + currentRadianAngle > startRadianAngle + endRadianAngle;
        return isSerieDrawCompleted
            ? startRadianAngle + endRadianAngle - PoChartCompleteCircle
            : startRadianAngle + currentRadianAngle;
    }
    initDrawPaths(seriesList, totalValue, height) {
        if (!this.animate) {
            this.calculateSerieCoordinates(seriesList, totalValue, height);
        }
        else {
            const startRadianAngle = PoChartStartAngle;
            const endRadianAngle = this.calculateAngle(seriesList[0].data, totalValue);
            this.ngZone.runOutsideAngular(() => this.calculateCoordinatesWithAnimation(seriesList, totalValue, height, startRadianAngle, endRadianAngle));
        }
    }
    setSerieLabelCoordinates(index) {
        if (this.svgLabels.toArray().length) {
            this.svgLabels.toArray()[index].applyCoordinates(this.seriesLabels[index]);
        }
    }
    validateSeries(series) {
        return series.reduce((seriesList, serie) => {
            var _a;
            const data = (_a = serie.data) !== null && _a !== void 0 ? _a : serie.value;
            if (data && data > 0) {
                const color = serie.color;
                const label = serie.label;
                const tooltip = serie.tooltip;
                const tooltipLabel = this.getTooltipLabel(data, label, tooltip);
                seriesList = [...seriesList, { data, color, label, tooltipLabel }];
            }
            return seriesList;
        }, []);
    }
}
PoChartCircularComponent.decorators = [
    { type: Directive }
];
PoChartCircularComponent.ctorParameters = () => [
    { type: NgZone },
    { type: ChangeDetectorRef }
];
PoChartCircularComponent.propDecorators = {
    containerSize: [{ type: Input, args: ['p-container-size',] }],
    circularClick: [{ type: Output, args: ['p-circular-click',] }],
    circularHover: [{ type: Output, args: ['p-circular-hover',] }],
    svgPaths: [{ type: ViewChildren, args: ['svgPaths',] }],
    svgLabels: [{ type: ViewChildren, args: ['svgLabels',] }],
    options: [{ type: Input, args: ['p-options',] }],
    series: [{ type: Input, args: ['p-series',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQtY2lyY3VsYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWNoYXJ0L3BvLWNoYXJ0LWNvbnRhaW5lci9wby1jaGFydC1jaXJjdWxhci9wby1jaGFydC1jaXJjdWxhci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUVOLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLHFCQUFxQixFQUNyQix3QkFBd0IsRUFDekIsTUFBTSxnREFBZ0QsQ0FBQztBQVd4RCxNQUFNLE9BQWdCLHdCQUF3QjtJQTZDNUMsWUFBb0IsTUFBYyxFQUFVLGNBQWlDO1FBQXpELFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUExQ2pELGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV4QyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFNcEUscUJBQWdCLEdBQVksS0FBSyxDQUFDO1FBQ2xDLGlCQUFZLEdBQW1DLEVBQUUsQ0FBQztRQUVsRCxlQUFVLEdBQVksS0FBSyxDQUFDO0lBK0JvRCxDQUFDO0lBckJqRixJQUF3QixPQUFPLENBQUMsS0FBcUI7UUFDbkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsV0FBVyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7WUFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFD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LFVBQVU7d0JBRXZCLFlBQVksU0FBQyxXQUFXO3NCQWV4QixLQUFLLFNBQUMsV0FBVztxQkFXakIsS0FBSyxTQUFDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgRGlyZWN0aXZlLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBOZ1pvbmUsXG4gIE91dHB1dCxcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q2hpbGRyZW5cbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7XG4gIFBvQ2hhcnRTdGFydEFuZ2xlLFxuICBQb0NoYXJ0Q29tcGxldGVDaXJjbGUsXG4gIFBvQ2hhcnRBbmdsZVN0ZXBJbnRlcnZhbFxufSBmcm9tICcuLi8uLi9oZWxwZXJzL3BvLWNoYXJ0LWRlZmF1bHQtdmFsdWVzLmNvbnN0YW50JztcblxuaW1wb3J0IHsgUG9DaGFydENpcmN1bGFyTGFiZWxDb21wb25lbnQgfSBmcm9tICcuL3BvLWNoYXJ0LWNpcmN1bGFyLWxhYmVsL3BvLWNoYXJ0LWNpcmN1bGFyLWxhYmVsLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0NoYXJ0Q2lyY3VsYXJQYXRoQ29tcG9uZW50IH0gZnJvbSAnLi9wby1jaGFydC1jaXJjdWxhci1wYXRoL3BvLWNoYXJ0LWNpcmN1bGFyLXBhdGguY29tcG9uZW50JztcbmltcG9ydCB7IFBvQ2hhcnRDb250YWluZXJTaXplIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1jb250YWluZXItc2l6ZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9DaGFydExhYmVsQ29vcmRpbmF0ZXMgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LWxhYmVsLWNvb3JkaW5hdGVzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0NoYXJ0T3B0aW9ucyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvcG8tY2hhcnQtb3B0aW9ucy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9DaGFydFBhdGhDb29yZGluYXRlcyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvcG8tY2hhcnQtcGF0aC1jb29yZGluYXRlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9DaGFydFNlcmllIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1zZXJpZS5pbnRlcmZhY2UnO1xuXG5ARGlyZWN0aXZlKClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBQb0NoYXJ0Q2lyY3VsYXJDb21wb25lbnQge1xuICBASW5wdXQoJ3AtY29udGFpbmVyLXNpemUnKSBjb250YWluZXJTaXplOiBQb0NoYXJ0Q29udGFpbmVyU2l6ZTtcblxuICBAT3V0cHV0KCdwLWNpcmN1bGFyLWNsaWNrJykgY2lyY3VsYXJDbGljayA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3AtY2lyY3VsYXItaG92ZXInKSBjaXJjdWxhckhvdmVyID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQFZpZXdDaGlsZHJlbignc3ZnUGF0aHMnKSBwcml2YXRlIHN2Z1BhdGhzOiBRdWVyeUxpc3Q8UG9DaGFydENpcmN1bGFyUGF0aENvbXBvbmVudD47XG5cbiAgQFZpZXdDaGlsZHJlbignc3ZnTGFiZWxzJykgcHJpdmF0ZSBzdmdMYWJlbHM6IFF1ZXJ5TGlzdDxQb0NoYXJ0Q2lyY3VsYXJMYWJlbENvbXBvbmVudD47XG5cbiAgY2FuRGlzcGxheUxhYmVsczogYm9vbGVhbiA9IGZhbHNlO1xuICBzZXJpZXNMYWJlbHM6IEFycmF5PFBvQ2hhcnRMYWJlbENvb3JkaW5hdGVzPiA9IFtdO1xuICBzZXJpZXNMaXN0OiBBcnJheTxQb0NoYXJ0UGF0aENvb3JkaW5hdGVzPjtcbiAgc2hvd0xhYmVsczogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByb3RlY3RlZCBpbm5lclJhZGl1czogbnVtYmVyO1xuICBwcm90ZWN0ZWQgdG90YWxWYWx1ZTogbnVtYmVyO1xuXG4gIHByaXZhdGUgX29wdGlvbnM6IFBvQ2hhcnRPcHRpb25zO1xuICBwcml2YXRlIF9zZXJpZXM6IEFycmF5PFBvQ2hhcnRTZXJpZT47XG5cbiAgcHJpdmF0ZSBhbmltYXRlOiBib29sZWFuO1xuXG4gIEBJbnB1dCgncC1vcHRpb25zJykgc2V0IG9wdGlvbnModmFsdWU6IFBvQ2hhcnRPcHRpb25zKSB7XG4gICAgaWYgKCFpc05hTih2YWx1ZT8uaW5uZXJSYWRpdXMpKSB7XG4gICAgICB0aGlzLl9vcHRpb25zID0gdmFsdWU7XG4gICAgICB0aGlzLmlubmVyUmFkaXVzID0gTWF0aC5taW4oTWF0aC5tYXgodGhpcy5fb3B0aW9ucy5pbm5lclJhZGl1cywgMCksIDEwMCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IG9wdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX29wdGlvbnM7XG4gIH1cblxuICBASW5wdXQoJ3Atc2VyaWVzJykgc2V0IHNlcmllcyh2YWx1ZTogQXJyYXk8UG9DaGFydFNlcmllPikge1xuICAgIHRoaXMuX3NlcmllcyA9IHZhbHVlO1xuXG4gICAgdGhpcy5hbmltYXRlID0gdHJ1ZTtcbiAgfVxuXG4gIGdldCBzZXJpZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NlcmllcztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUsIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmKSB7fVxuXG4gIG9uU2VyaWVDbGljayhzZWxlY3RlZEl0ZW06IGFueSkge1xuICAgIHRoaXMuY2lyY3VsYXJDbGljay5lbWl0KHNlbGVjdGVkSXRlbSk7XG4gIH1cblxuICBvblNlcmllSG92ZXIoc2VsZWN0ZWRJdGVtOiBhbnkpIHtcbiAgICB0aGlzLmNpcmN1bGFySG92ZXIuZW1pdChzZWxlY3RlZEl0ZW0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNhbGN1bGF0ZUFuZ2xlKGRhdGE6IG51bWJlciwgdG90YWxWYWx1ZTogbnVtYmVyKSB7XG4gICAgcmV0dXJuIChkYXRhIC8gdG90YWxWYWx1ZSkgKiAoTWF0aC5QSSAqIDIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRyYXdTZXJpZXMoc2VyaWVzOiBBcnJheTxQb0NoYXJ0U2VyaWU+ID0gW10sIGhlaWdodDogbnVtYmVyKSB7XG4gICAgdGhpcy5zZXJpZXNMaXN0ID0gW107XG4gICAgdGhpcy5zaG93TGFiZWxzID0gZmFsc2U7XG4gICAgdGhpcy50b3RhbFZhbHVlID0gdGhpcy5jYWxjdWxhdGVUb3RhbFZhbHVlKHNlcmllcyk7XG4gICAgaWYgKHRoaXMudG90YWxWYWx1ZSAmJiB0aGlzLnRvdGFsVmFsdWUgPiAwKSB7XG4gICAgICB0aGlzLnNlcmllc0xpc3QgPSB0aGlzLnZhbGlkYXRlU2VyaWVzKHNlcmllcyk7XG4gICAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcblxuICAgICAgaWYgKHRoaXMuc2VyaWVzTGlzdC5sZW5ndGggJiYgdGhpcy5zdmdQYXRocykge1xuICAgICAgICB0aGlzLmluaXREcmF3UGF0aHModGhpcy5zZXJpZXNMaXN0LCB0aGlzLnRvdGFsVmFsdWUsIGhlaWdodCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVUb3RhbFZhbHVlKHNlcmllczogQXJyYXk8UG9DaGFydFNlcmllPikge1xuICAgIHJldHVybiBzZXJpZXMucmVkdWNlKChwcmV2aW91c1ZhbHVlLCBzZXJpZTogYW55KSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gc2VyaWUuZGF0YSA/IHNlcmllLmRhdGEgOiBzZXJpZS52YWx1ZTtcblxuICAgICAgcmV0dXJuIHByZXZpb3VzVmFsdWUgKyAoZGF0YSA+IDAgPyBkYXRhIDogMCk7XG4gICAgfSwgMCk7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZVNlcmllQ29vcmRpbmF0ZXMoc2VyaWVzOiBBcnJheTxQb0NoYXJ0UGF0aENvb3JkaW5hdGVzPiwgdG90YWxWYWx1ZTogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xuICAgIGxldCBzdGFydFJhZGlhbkFuZ2xlO1xuICAgIGxldCBlbmRSYWRpYW5BbmdsZSA9IFBvQ2hhcnRTdGFydEFuZ2xlO1xuXG4gICAgc2VyaWVzLmZvckVhY2goKHNlcmllOiBhbnksIGluZGV4KSA9PiB7XG4gICAgICBzdGFydFJhZGlhbkFuZ2xlID0gZW5kUmFkaWFuQW5nbGU7XG4gICAgICBlbmRSYWRpYW5BbmdsZSA9IHN0YXJ0UmFkaWFuQW5nbGUgKyB0aGlzLmNhbGN1bGF0ZUFuZ2xlKHNlcmllLmRhdGEsIHRvdGFsVmFsdWUpIC0gUG9DaGFydENvbXBsZXRlQ2lyY2xlO1xuXG4gICAgICBjb25zdCBjb29yZGluYXRlcyA9IHRoaXMuY2FsY3VsYXRlQ29vcmRpbmF0ZXMoaGVpZ2h0LCBzdGFydFJhZGlhbkFuZ2xlLCBlbmRSYWRpYW5BbmdsZSk7XG5cbiAgICAgIHRoaXMuc3ZnUGF0aHMudG9BcnJheSgpW2luZGV4XS5hcHBseUNvb3JkaW5hdGVzKGNvb3JkaW5hdGVzKTtcbiAgICAgIHRoaXMuc2hvd0xhYmVscyA9IHRoaXMuY2FuRGlzcGxheUxhYmVscztcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlQ29vcmRpbmF0ZXNXaXRoQW5pbWF0aW9uKFxuICAgIHNlcmllczogQXJyYXk8UG9DaGFydFBhdGhDb29yZGluYXRlcz4sXG4gICAgdG90YWxWYWx1ZTogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyLFxuICAgIHN0YXJ0UmFkaWFuQW5nbGU6IG51bWJlcixcbiAgICBlbmRSYWRpYW5BbmdsZTogbnVtYmVyLFxuICAgIGN1cnJlbnRSYWRpYW5BbmdsZTogbnVtYmVyID0gMCxcbiAgICBzZXJpZXNJbmRleDogbnVtYmVyID0gMFxuICApIHtcbiAgICBjb25zdCBmaW5pc2hlZEN1cnJlbnRTZXJpZSA9IGN1cnJlbnRSYWRpYW5BbmdsZSA+IGVuZFJhZGlhbkFuZ2xlO1xuICAgIGNvbnN0IGZpbmlzaGVkQWxsU2VyaWVzID0gc2VyaWVzSW5kZXggPT09IHNlcmllcy5sZW5ndGg7XG5cbiAgICBpZiAoZmluaXNoZWRBbGxTZXJpZXMpIHtcbiAgICAgIHRoaXMuYW5pbWF0ZSA9IGZhbHNlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChmaW5pc2hlZEN1cnJlbnRTZXJpZSkge1xuICAgICAgdGhpcy5zZXRTZXJpZUxhYmVsQ29vcmRpbmF0ZXMoc2VyaWVzSW5kZXgpO1xuICAgICAgY3VycmVudFJhZGlhbkFuZ2xlID0gMDtcbiAgICAgIHNlcmllc0luZGV4Kys7XG4gICAgICBzdGFydFJhZGlhbkFuZ2xlID0gc3RhcnRSYWRpYW5BbmdsZSArIGVuZFJhZGlhbkFuZ2xlO1xuICAgICAgZW5kUmFkaWFuQW5nbGUgPVxuICAgICAgICBzZXJpZXNJbmRleCA8IHNlcmllcy5sZW5ndGggPyB0aGlzLmNhbGN1bGF0ZUFuZ2xlKHNlcmllc1tzZXJpZXNJbmRleF0uZGF0YSwgdG90YWxWYWx1ZSkgOiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJlbnRSYWRpYW5BbmdsZSArPSBQb0NoYXJ0QW5nbGVTdGVwSW50ZXJ2YWw7XG5cbiAgICAgIGNvbnN0IGN1cnJlbnRFbmRSYWRpYW5BbmdsZSA9IHRoaXMuY2FsY3VsYXRlQ3VycmVudEVuZEFuZ2xlKGN1cnJlbnRSYWRpYW5BbmdsZSwgc3RhcnRSYWRpYW5BbmdsZSwgZW5kUmFkaWFuQW5nbGUpO1xuICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSB0aGlzLmNhbGN1bGF0ZUNvb3JkaW5hdGVzKGhlaWdodCwgc3RhcnRSYWRpYW5BbmdsZSwgY3VycmVudEVuZFJhZGlhbkFuZ2xlKTtcblxuICAgICAgdGhpcy5zdmdQYXRocy50b0FycmF5KClbc2VyaWVzSW5kZXhdLmFwcGx5Q29vcmRpbmF0ZXMoY29vcmRpbmF0ZXMpO1xuICAgIH1cblxuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoXG4gICAgICB0aGlzLmNhbGN1bGF0ZUNvb3JkaW5hdGVzV2l0aEFuaW1hdGlvbi5iaW5kKFxuICAgICAgICB0aGlzLFxuICAgICAgICBzZXJpZXMsXG4gICAgICAgIHRvdGFsVmFsdWUsXG4gICAgICAgIGhlaWdodCxcbiAgICAgICAgc3RhcnRSYWRpYW5BbmdsZSxcbiAgICAgICAgZW5kUmFkaWFuQW5nbGUsXG4gICAgICAgIGN1cnJlbnRSYWRpYW5BbmdsZSxcbiAgICAgICAgc2VyaWVzSW5kZXhcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVDdXJyZW50RW5kQW5nbGUoY3VycmVudFJhZGlhbkFuZ2xlOiBudW1iZXIsIHN0YXJ0UmFkaWFuQW5nbGU6IG51bWJlciwgZW5kUmFkaWFuQW5nbGU6IG51bWJlcikge1xuICAgIGNvbnN0IGlzU2VyaWVEcmF3Q29tcGxldGVkID0gc3RhcnRSYWRpYW5BbmdsZSArIGN1cnJlbnRSYWRpYW5BbmdsZSA+IHN0YXJ0UmFkaWFuQW5nbGUgKyBlbmRSYWRpYW5BbmdsZTtcblxuICAgIHJldHVybiBpc1NlcmllRHJhd0NvbXBsZXRlZFxuICAgICAgPyBzdGFydFJhZGlhbkFuZ2xlICsgZW5kUmFkaWFuQW5nbGUgLSBQb0NoYXJ0Q29tcGxldGVDaXJjbGVcbiAgICAgIDogc3RhcnRSYWRpYW5BbmdsZSArIGN1cnJlbnRSYWRpYW5BbmdsZTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdERyYXdQYXRocyhzZXJpZXNMaXN0OiBBcnJheTxQb0NoYXJ0UGF0aENvb3JkaW5hdGVzPiwgdG90YWxWYWx1ZTogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xuICAgIGlmICghdGhpcy5hbmltYXRlKSB7XG4gICAgICB0aGlzLmNhbGN1bGF0ZVNlcmllQ29vcmRpbmF0ZXMoc2VyaWVzTGlzdCwgdG90YWxWYWx1ZSwgaGVpZ2h0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc3RhcnRSYWRpYW5BbmdsZSA9IFBvQ2hhcnRTdGFydEFuZ2xlO1xuICAgICAgY29uc3QgZW5kUmFkaWFuQW5nbGUgPSB0aGlzLmNhbGN1bGF0ZUFuZ2xlKHNlcmllc0xpc3RbMF0uZGF0YSwgdG90YWxWYWx1ZSk7XG5cbiAgICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlQ29vcmRpbmF0ZXNXaXRoQW5pbWF0aW9uKHNlcmllc0xpc3QsIHRvdGFsVmFsdWUsIGhlaWdodCwgc3RhcnRSYWRpYW5BbmdsZSwgZW5kUmFkaWFuQW5nbGUpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0U2VyaWVMYWJlbENvb3JkaW5hdGVzKGluZGV4OiBudW1iZXIpIHtcbiAgICBpZiAodGhpcy5zdmdMYWJlbHMudG9BcnJheSgpLmxlbmd0aCkge1xuICAgICAgdGhpcy5zdmdMYWJlbHMudG9BcnJheSgpW2luZGV4XS5hcHBseUNvb3JkaW5hdGVzKHRoaXMuc2VyaWVzTGFiZWxzW2luZGV4XSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVNlcmllcyhzZXJpZXM6IEFycmF5PFBvQ2hhcnRTZXJpZT4pIHtcbiAgICByZXR1cm4gc2VyaWVzLnJlZHVjZSgoc2VyaWVzTGlzdCwgc2VyaWU6IGFueSkgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IHNlcmllLmRhdGEgPz8gc2VyaWUudmFsdWU7XG4gICAgICBpZiAoZGF0YSAmJiBkYXRhID4gMCkge1xuICAgICAgICBjb25zdCBjb2xvciA9IHNlcmllLmNvbG9yO1xuICAgICAgICBjb25zdCBsYWJlbCA9IHNlcmllLmxhYmVsO1xuICAgICAgICBjb25zdCB0b29sdGlwID0gc2VyaWUudG9vbHRpcDtcbiAgICAgICAgY29uc3QgdG9vbHRpcExhYmVsID0gdGhpcy5nZXRUb29sdGlwTGFiZWwoZGF0YSwgbGFiZWwsIHRvb2x0aXApO1xuXG4gICAgICAgIHNlcmllc0xpc3QgPSBbLi4uc2VyaWVzTGlzdCwgeyBkYXRhLCBjb2xvciwgbGFiZWwsIHRvb2x0aXBMYWJlbCB9XTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNlcmllc0xpc3Q7XG4gICAgfSwgW10pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGNhbGN1bGF0ZUNvb3JkaW5hdGVzKGhlaWdodCwgc3RhcnRSYWRpYW5BbmdsZSwgY3VycmVudEVuZFJhZGlhbkFuZ2xlKTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldFRvb2x0aXBMYWJlbChkYXRhLCBsYWJlbCwgdG9vbHRpcCk7XG59XG4iXX0=