import { EventEmitter, Input, IterableDiffers, Output, Directive } from '@angular/core';
import { convertToBoolean, isKeyCodeEnter, uuid } from '../../utils/util';
import { PoLanguageService } from '../../services/po-language/po-language.service';
import { poLocaleDefault } from '../../services/po-language/po-language.constant';
export const poDisclaimerGroupLiteralsDefault = {
    en: { removeAll: 'Remove all' },
    es: { removeAll: 'Eliminar todos' },
    pt: { removeAll: 'Remover todos' },
    ru: { removeAll: 'Удалить все' }
};
/**
 * @description
 *
 * O componente `po-disclaimer-group` é recomendado para manipular palavras-chave de filtros aplicados em uma pesquisa.
 *
 * À partir de dois *disclaimers* com o botão **fechar** habilitado, o componente renderiza de forma automática um novo e destacado
 * *disclaimer* que possibilita **remover todos**, mas que também pode ser desabilitado.
 *
 * Também é possível navegar entre os *disclaimers* através do teclado utilizando a tecla *tab* e, para remoção do *disclaimer* selecionado,
 * basta pressionar a tecla *enter*. Esta funcionalidade não se aplica caso a propriedade `hideClose` estiver habilitada.
 *
 * > Veja a integração destas funcionalidade no componente [po-page-list](/documentation/po-page-list).
 */
export class PoDisclaimerGroupBaseComponent {
    constructor(differs, languageService) {
        /**
         * @optional
         *
         * @description
         *
         * Função que será disparada quando a lista de *disclaimers* for modificada.
         */
        this.change = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Função que será disparada quando um *disclaimer* for removido da lista de *disclaimers* pelo usuário.
         *
         * Recebe como parâmetro um objeto conforme a interface `PoDisclaimerGroupRemoveAction`.
         */
        this.remove = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Função que será disparada quando todos os *disclaimers* forem removidos da lista de *disclaimers* pelo usuário,
         * utilizando o botão "remover todos".
         *
         * Recebe como parâmetro uma lista contendo todos os `disclaimers` removidos.
         */
        this.removeAll = new EventEmitter();
        this._disclaimers = [];
        this._hideRemoveAll = false;
        this.previousDisclaimers = [];
        const language = languageService.getShortLanguage();
        this.differ = differs.find([]).create(null);
        this.literals = Object.assign(Object.assign({}, poDisclaimerGroupLiteralsDefault[poLocaleDefault]), poDisclaimerGroupLiteralsDefault[language]);
    }
    /** Lista de *disclaimers*. */
    /**
     * @description
     *
     * Lista de *disclaimers*.
     *
     * Para que a lista de *disclaimers* seja atualizada dinamicamente deve-se passar uma nova referência do array de `PoDisclaimer`.
     *
     * Exemplo adicionando um *disclaimer* no array:
     *
     * ```
     * this.disclaimers = [...this.disclaimers, disclaimer];
     * ```
     *
     * ou
     *
     * ```
     * this.disclaimers = this.disclaimers.concat(disclaimer);
     * ```
     */
    set disclaimers(value) {
        this.previousDisclaimers = [...this.disclaimers];
        this._disclaimers = this.checkDisclaimers(value);
    }
    get disclaimers() {
        return this._disclaimers;
    }
    /**
     * @optional
     *
     * @description
     *
     * Oculta o botão para remover todos os *disclaimers* do grupo.
     *
     * > Por padrão, o mesmo é exibido à partir de dois ou mais *disclaimers* com a opção `hideClose` habilitada.
     *
     * @default `false`
     */
    set hideRemoveAll(value) {
        this._hideRemoveAll = value === '' ? true : convertToBoolean(value);
    }
    get hideRemoveAll() {
        return this._hideRemoveAll;
    }
    ngDoCheck() {
        this.checkChanges();
    }
    onCloseAction(disclaimer) {
        this.removeDisclaimer(disclaimer);
        this.emitChangeDisclaimers();
        this.remove.emit({
            removedDisclaimer: Object.assign({}, disclaimer),
            currentDisclaimers: [...this.disclaimers]
        });
    }
    isRemoveAll() {
        return !this.hideRemoveAll && this.disclaimers.filter(c => !c.hideClose).length > 1;
    }
    onKeyPress(event) {
        if (isKeyCodeEnter(event)) {
            this.removeAllItems();
        }
    }
    removeAllItems() {
        const removeItems = [];
        this.disclaimers.forEach(disclaimer => {
            if (!disclaimer.hideClose) {
                removeItems.push(disclaimer);
            }
        });
        removeItems.forEach(disclaimer => this.removeDisclaimer(disclaimer));
        this.emitChangeDisclaimers();
        this.removeAll.emit([...removeItems]);
    }
    removeDisclaimer(disclaimer) {
        const itemIndex = this.disclaimers.findIndex(d => d['$id'] === disclaimer['$id']);
        this.disclaimers.splice(itemIndex, 1);
    }
    checkChanges() {
        if (this.differ) {
            const changes = this.differ.diff(this.disclaimers);
            if (changes && this.disclaimersAreChanged(this.disclaimers)) {
                this.emitChangeDisclaimers();
            }
        }
    }
    checkDisclaimers(disclaimers) {
        if (Array.isArray(disclaimers)) {
            for (let i = 0; i < disclaimers.length; i++) {
                const disclaimer = disclaimers[i];
                if (disclaimer.value || disclaimer.value === 0 || disclaimer.value === false) {
                    disclaimer['$id'] = uuid();
                }
                else {
                    disclaimers.splice(i, 1);
                    i--;
                }
            }
            return disclaimers;
        }
        return [];
    }
    disclaimersAreChanged(disclaimers) {
        const currentValues = disclaimers;
        if (currentValues.length !== this.previousDisclaimers.length) {
            return true;
        }
        return currentValues.some((disclaimer, index) => disclaimer.value !== this.previousDisclaimers[index].value ||
            disclaimer.property !== this.previousDisclaimers[index].property);
    }
    emitChangeDisclaimers() {
        setTimeout(() => {
            this.change.emit(this.disclaimers);
        });
        this.previousDisclaimers = [...this._disclaimers];
    }
}
PoDisclaimerGroupBaseComponent.decorators = [
    { type: Directive }
];
PoDisclaimerGroupBaseComponent.ctorParameters = () => [
    { type: IterableDiffers },
    { type: PoLanguageService }
];
PoDisclaimerGroupBaseComponent.propDecorators = {
    title: [{ type: Input, args: ['p-title',] }],
    change: [{ type: Output, args: ['p-change',] }],
    remove: [{ type: Output, args: ['p-remove',] }],
    removeAll: [{ type: Output, args: ['p-remove-all',] }],
    disclaimers: [{ type: Input, args: ['p-disclaimers',] }],
    hideRemoveAll: [{ type: Input, args: ['p-hide-remove-all',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZGlzY2xhaW1lci1ncm91cC1iYXNlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1kaXNjbGFpbWVyLWdyb3VwL3BvLWRpc2NsYWltZXItZ3JvdXAtYmFzZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFXLFlBQVksRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFakcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUMxRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUNuRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0saURBQWlELENBQUM7QUFJbEYsTUFBTSxDQUFDLE1BQU0sZ0NBQWdDLEdBQUc7SUFDOUMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRTtJQUMvQixFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7SUFDbkMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRTtJQUNsQyxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFO0NBQ2pDLENBQUM7QUFFRjs7Ozs7Ozs7Ozs7O0dBWUc7QUFFSCxNQUFNLE9BQU8sOEJBQThCO0lBOEZ6QyxZQUFZLE9BQXdCLEVBQUUsZUFBa0M7UUExRnhFOzs7Ozs7V0FNRztRQUNpQixXQUFNLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFeEU7Ozs7Ozs7O1dBUUc7UUFDaUIsV0FBTSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXhFOzs7Ozs7Ozs7V0FTRztRQUNxQixjQUFTLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7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UUFDNUQsTUFBTSxhQUFhLEdBQXdCLFdBQVcsQ0FBQztRQUV2RCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sRUFBRTtZQUM1RCxPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsT0FBTyxhQUFhLENBQUMsSUFBSSxDQUN2QixDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUNwQixVQUFVLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLO1lBQzFELFVBQVUsQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FDbkUsQ0FBQztJQUNKLENBQUM7SUFFTyxxQkFBcUI7UUFDM0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3BELENBQUM7OztZQXRNRixTQUFTOzs7WUE1QjZCLGVBQWU7WUFHN0MsaUJBQWlCOzs7b0JBNEJ2QixLQUFLLFNBQUMsU0FBUztxQkFTZixNQUFNLFNBQUMsVUFBVTtxQkFXakIsTUFBTSxTQUFDLFVBQVU7d0JBWWpCLE1BQU0sU0FBQyxjQUFjOzBCQStCckIsS0FBSyxTQUFDLGVBQWU7NEJBb0JyQixLQUFLLFNBQUMsbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRG9DaGVjaywgRXZlbnRFbWl0dGVyLCBJbnB1dCwgSXRlcmFibGVEaWZmZXJzLCBPdXRwdXQsIERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBjb252ZXJ0VG9Cb29sZWFuLCBpc0tleUNvZGVFbnRlciwgdXVpZCB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IHBvTG9jYWxlRGVmYXVsdCB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWxhbmd1YWdlL3BvLWxhbmd1YWdlLmNvbnN0YW50JztcblxuaW1wb3J0IHsgUG9EaXNjbGFpbWVyIH0gZnJvbSAnLi4vcG8tZGlzY2xhaW1lci9wby1kaXNjbGFpbWVyLmludGVyZmFjZSc7XG5cbmV4cG9ydCBjb25zdCBwb0Rpc2NsYWltZXJHcm91cExpdGVyYWxzRGVmYXVsdCA9IHtcbiAgZW46IHsgcmVtb3ZlQWxsOiAnUmVtb3ZlIGFsbCcgfSxcbiAgZXM6IHsgcmVtb3ZlQWxsOiAnRWxpbWluYXIgdG9kb3MnIH0sXG4gIHB0OiB7IHJlbW92ZUFsbDogJ1JlbW92ZXIgdG9kb3MnIH0sXG4gIHJ1OiB7IHJlbW92ZUFsbDogJ9Cj0LTQsNC70LjRgtGMINCy0YHQtScgfVxufTtcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBPIGNvbXBvbmVudGUgYHBvLWRpc2NsYWltZXItZ3JvdXBgIMOpIHJlY29tZW5kYWRvIHBhcmEgbWFuaXB1bGFyIHBhbGF2cmFzLWNoYXZlIGRlIGZpbHRyb3MgYXBsaWNhZG9zIGVtIHVtYSBwZXNxdWlzYS5cbiAqXG4gKiDDgCBwYXJ0aXIgZGUgZG9pcyAqZGlzY2xhaW1lcnMqIGNvbSBvIGJvdMOjbyAqKmZlY2hhcioqIGhhYmlsaXRhZG8sIG8gY29tcG9uZW50ZSByZW5kZXJpemEgZGUgZm9ybWEgYXV0b23DoXRpY2EgdW0gbm92byBlIGRlc3RhY2Fkb1xuICogKmRpc2NsYWltZXIqIHF1ZSBwb3NzaWJpbGl0YSAqKnJlbW92ZXIgdG9kb3MqKiwgbWFzIHF1ZSB0YW1iw6ltIHBvZGUgc2VyIGRlc2FiaWxpdGFkby5cbiAqXG4gKiBUYW1iw6ltIMOpIHBvc3PDrXZlbCBuYXZlZ2FyIGVudHJlIG9zICpkaXNjbGFpbWVycyogYXRyYXbDqXMgZG8gdGVjbGFkbyB1dGlsaXphbmRvIGEgdGVjbGEgKnRhYiogZSwgcGFyYSByZW1vw6fDo28gZG8gKmRpc2NsYWltZXIqIHNlbGVjaW9uYWRvLFxuICogYmFzdGEgcHJlc3Npb25hciBhIHRlY2xhICplbnRlciouIEVzdGEgZnVuY2lvbmFsaWRhZGUgbsOjbyBzZSBhcGxpY2EgY2FzbyBhIHByb3ByaWVkYWRlIGBoaWRlQ2xvc2VgIGVzdGl2ZXIgaGFiaWxpdGFkYS5cbiAqXG4gKiA+IFZlamEgYSBpbnRlZ3Jhw6fDo28gZGVzdGFzIGZ1bmNpb25hbGlkYWRlIG5vIGNvbXBvbmVudGUgW3BvLXBhZ2UtbGlzdF0oL2RvY3VtZW50YXRpb24vcG8tcGFnZS1saXN0KS5cbiAqL1xuQERpcmVjdGl2ZSgpXG5leHBvcnQgY2xhc3MgUG9EaXNjbGFpbWVyR3JvdXBCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgRG9DaGVjayB7XG4gIC8qKiBUw610dWxvIGRvIGdydXBvIGRlICpkaXNjbGFpbWVycyouICovXG4gIEBJbnB1dCgncC10aXRsZScpIHRpdGxlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEZ1bsOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgcXVhbmRvIGEgbGlzdGEgZGUgKmRpc2NsYWltZXJzKiBmb3IgbW9kaWZpY2FkYS5cbiAgICovXG4gIEBPdXRwdXQoJ3AtY2hhbmdlJykgY2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEZ1bsOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgcXVhbmRvIHVtICpkaXNjbGFpbWVyKiBmb3IgcmVtb3ZpZG8gZGEgbGlzdGEgZGUgKmRpc2NsYWltZXJzKiBwZWxvIHVzdcOhcmlvLlxuICAgKlxuICAgKiBSZWNlYmUgY29tbyBwYXLDom1ldHJvIHVtIG9iamV0byBjb25mb3JtZSBhIGludGVyZmFjZSBgUG9EaXNjbGFpbWVyR3JvdXBSZW1vdmVBY3Rpb25gLlxuICAgKi9cbiAgQE91dHB1dCgncC1yZW1vdmUnKSByZW1vdmU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogRnVuw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBxdWFuZG8gdG9kb3Mgb3MgKmRpc2NsYWltZXJzKiBmb3JlbSByZW1vdmlkb3MgZGEgbGlzdGEgZGUgKmRpc2NsYWltZXJzKiBwZWxvIHVzdcOhcmlvLFxuICAgKiB1dGlsaXphbmRvIG8gYm90w6NvIFwicmVtb3ZlciB0b2Rvc1wiLlxuICAgKlxuICAgKiBSZWNlYmUgY29tbyBwYXLDom1ldHJvIHVtYSBsaXN0YSBjb250ZW5kbyB0b2RvcyBvcyBgZGlzY2xhaW1lcnNgIHJlbW92aWRvcy5cbiAgICovXG4gIEBPdXRwdXQoJ3AtcmVtb3ZlLWFsbCcpIHJlbW92ZUFsbDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBsaXRlcmFscztcblxuICBwcml2YXRlIF9kaXNjbGFpbWVyczogQXJyYXk8UG9EaXNjbGFpbWVyPiA9IFtdO1xuICBwcml2YXRlIF9oaWRlUmVtb3ZlQWxsOiBib29sZWFuID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBkaWZmZXI7XG4gIHByaXZhdGUgcHJldmlvdXNEaXNjbGFpbWVyczogQXJyYXk8UG9EaXNjbGFpbWVyPiA9IFtdO1xuXG4gIC8qKiBMaXN0YSBkZSAqZGlzY2xhaW1lcnMqLiAqL1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogTGlzdGEgZGUgKmRpc2NsYWltZXJzKi5cbiAgICpcbiAgICogUGFyYSBxdWUgYSBsaXN0YSBkZSAqZGlzY2xhaW1lcnMqIHNlamEgYXR1YWxpemFkYSBkaW5hbWljYW1lbnRlIGRldmUtc2UgcGFzc2FyIHVtYSBub3ZhIHJlZmVyw6puY2lhIGRvIGFycmF5IGRlIGBQb0Rpc2NsYWltZXJgLlxuICAgKlxuICAgKiBFeGVtcGxvIGFkaWNpb25hbmRvIHVtICpkaXNjbGFpbWVyKiBubyBhcnJheTpcbiAgICpcbiAgICogYGBgXG4gICAqIHRoaXMuZGlzY2xhaW1lcnMgPSBbLi4udGhpcy5kaXNjbGFpbWVycywgZGlzY2xhaW1lcl07XG4gICAqIGBgYFxuICAgKlxuICAgKiBvdVxuICAgKlxuICAgKiBgYGBcbiAgICogdGhpcy5kaXNjbGFpbWVycyA9IHRoaXMuZGlzY2xhaW1lcnMuY29uY2F0KGRpc2NsYWltZXIpO1xuICAgKiBgYGBcbiAgICovXG4gIEBJbnB1dCgncC1kaXNjbGFpbWVycycpIHNldCBkaXNjbGFpbWVycyh2YWx1ZTogQXJyYXk8UG9EaXNjbGFpbWVyPikge1xuICAgIHRoaXMucHJldmlvdXNEaXNjbGFpbWVycyA9IFsuLi50aGlzLmRpc2NsYWltZXJzXTtcbiAgICB0aGlzLl9kaXNjbGFpbWVycyA9IHRoaXMuY2hlY2tEaXNjbGFpbWVycyh2YWx1ZSk7XG4gIH1cblxuICBnZXQgZGlzY2xhaW1lcnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Rpc2NsYWltZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogT2N1bHRhIG8gYm90w6NvIHBhcmEgcmVtb3ZlciB0b2RvcyBvcyAqZGlzY2xhaW1lcnMqIGRvIGdydXBvLlxuICAgKlxuICAgKiA+IFBvciBwYWRyw6NvLCBvIG1lc21vIMOpIGV4aWJpZG8gw6AgcGFydGlyIGRlIGRvaXMgb3UgbWFpcyAqZGlzY2xhaW1lcnMqIGNvbSBhIG9ww6fDo28gYGhpZGVDbG9zZWAgaGFiaWxpdGFkYS5cbiAgICpcbiAgICogQGRlZmF1bHQgYGZhbHNlYFxuICAgKi9cbiAgQElucHV0KCdwLWhpZGUtcmVtb3ZlLWFsbCcpXG4gIHNldCBoaWRlUmVtb3ZlQWxsKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5faGlkZVJlbW92ZUFsbCA9IDxhbnk+dmFsdWUgPT09ICcnID8gdHJ1ZSA6IGNvbnZlcnRUb0Jvb2xlYW4odmFsdWUpO1xuICB9XG5cbiAgZ2V0IGhpZGVSZW1vdmVBbGwoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2hpZGVSZW1vdmVBbGw7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihkaWZmZXJzOiBJdGVyYWJsZURpZmZlcnMsIGxhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2UpIHtcbiAgICBjb25zdCBsYW5ndWFnZSA9IGxhbmd1YWdlU2VydmljZS5nZXRTaG9ydExhbmd1YWdlKCk7XG5cbiAgICB0aGlzLmRpZmZlciA9IGRpZmZlcnMuZmluZChbXSkuY3JlYXRlKG51bGwpO1xuXG4gICAgdGhpcy5saXRlcmFscyA9IHtcbiAgICAgIC4uLnBvRGlzY2xhaW1lckdyb3VwTGl0ZXJhbHNEZWZhdWx0W3BvTG9jYWxlRGVmYXVsdF0sXG4gICAgICAuLi5wb0Rpc2NsYWltZXJHcm91cExpdGVyYWxzRGVmYXVsdFtsYW5ndWFnZV1cbiAgICB9O1xuICB9XG5cbiAgbmdEb0NoZWNrKCkge1xuICAgIHRoaXMuY2hlY2tDaGFuZ2VzKCk7XG4gIH1cblxuICBvbkNsb3NlQWN0aW9uKGRpc2NsYWltZXIpIHtcbiAgICB0aGlzLnJlbW92ZURpc2NsYWltZXIoZGlzY2xhaW1lcik7XG5cbiAgICB0aGlzLmVtaXRDaGFuZ2VEaXNjbGFpbWVycygpO1xuICAgIHRoaXMucmVtb3ZlLmVtaXQoe1xuICAgICAgcmVtb3ZlZERpc2NsYWltZXI6IHsgLi4uZGlzY2xhaW1lciB9LFxuICAgICAgY3VycmVudERpc2NsYWltZXJzOiBbLi4udGhpcy5kaXNjbGFpbWVyc11cbiAgICB9KTtcbiAgfVxuXG4gIGlzUmVtb3ZlQWxsKCkge1xuICAgIHJldHVybiAhdGhpcy5oaWRlUmVtb3ZlQWxsICYmIHRoaXMuZGlzY2xhaW1lcnMuZmlsdGVyKGMgPT4gIWMuaGlkZUNsb3NlKS5sZW5ndGggPiAxO1xuICB9XG5cbiAgb25LZXlQcmVzcyhldmVudDogYW55KSB7XG4gICAgaWYgKGlzS2V5Q29kZUVudGVyKGV2ZW50KSkge1xuICAgICAgdGhpcy5yZW1vdmVBbGxJdGVtcygpO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZUFsbEl0ZW1zKCkge1xuICAgIGNvbnN0IHJlbW92ZUl0ZW1zID0gW107XG5cbiAgICB0aGlzLmRpc2NsYWltZXJzLmZvckVhY2goZGlzY2xhaW1lciA9PiB7XG4gICAgICBpZiAoIWRpc2NsYWltZXIuaGlkZUNsb3NlKSB7XG4gICAgICAgIHJlbW92ZUl0ZW1zLnB1c2goZGlzY2xhaW1lcik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZW1vdmVJdGVtcy5mb3JFYWNoKGRpc2NsYWltZXIgPT4gdGhpcy5yZW1vdmVEaXNjbGFpbWVyKGRpc2NsYWltZXIpKTtcblxuICAgIHRoaXMuZW1pdENoYW5nZURpc2NsYWltZXJzKCk7XG4gICAgdGhpcy5yZW1vdmVBbGwuZW1pdChbLi4ucmVtb3ZlSXRlbXNdKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRGlzY2xhaW1lcihkaXNjbGFpbWVyOiBhbnkpIHtcbiAgICBjb25zdCBpdGVtSW5kZXggPSB0aGlzLmRpc2NsYWltZXJzLmZpbmRJbmRleChkID0+IGRbJyRpZCddID09PSBkaXNjbGFpbWVyWyckaWQnXSk7XG4gICAgdGhpcy5kaXNjbGFpbWVycy5zcGxpY2UoaXRlbUluZGV4LCAxKTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tDaGFuZ2VzKCkge1xuICAgIGlmICh0aGlzLmRpZmZlcikge1xuICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZmVyLmRpZmYodGhpcy5kaXNjbGFpbWVycyk7XG5cbiAgICAgIGlmIChjaGFuZ2VzICYmIHRoaXMuZGlzY2xhaW1lcnNBcmVDaGFuZ2VkKHRoaXMuZGlzY2xhaW1lcnMpKSB7XG4gICAgICAgIHRoaXMuZW1pdENoYW5nZURpc2NsYWltZXJzKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0Rpc2NsYWltZXJzKGRpc2NsYWltZXJzOiBBcnJheTxQb0Rpc2NsYWltZXI+KSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZGlzY2xhaW1lcnMpKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpc2NsYWltZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGRpc2NsYWltZXIgPSBkaXNjbGFpbWVyc1tpXTtcblxuICAgICAgICBpZiAoZGlzY2xhaW1lci52YWx1ZSB8fCBkaXNjbGFpbWVyLnZhbHVlID09PSAwIHx8IGRpc2NsYWltZXIudmFsdWUgPT09IGZhbHNlKSB7XG4gICAgICAgICAgZGlzY2xhaW1lclsnJGlkJ10gPSB1dWlkKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGlzY2xhaW1lcnMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgIGktLTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGlzY2xhaW1lcnM7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNjbGFpbWVyc0FyZUNoYW5nZWQoZGlzY2xhaW1lcnM6IEFycmF5PFBvRGlzY2xhaW1lcj4pOiBib29sZWFuIHtcbiAgICBjb25zdCBjdXJyZW50VmFsdWVzOiBBcnJheTxQb0Rpc2NsYWltZXI+ID0gZGlzY2xhaW1lcnM7XG5cbiAgICBpZiAoY3VycmVudFZhbHVlcy5sZW5ndGggIT09IHRoaXMucHJldmlvdXNEaXNjbGFpbWVycy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50VmFsdWVzLnNvbWUoXG4gICAgICAoZGlzY2xhaW1lciwgaW5kZXgpID0+XG4gICAgICAgIGRpc2NsYWltZXIudmFsdWUgIT09IHRoaXMucHJldmlvdXNEaXNjbGFpbWVyc1tpbmRleF0udmFsdWUgfHxcbiAgICAgICAgZGlzY2xhaW1lci5wcm9wZXJ0eSAhPT0gdGhpcy5wcmV2aW91c0Rpc2NsYWltZXJzW2luZGV4XS5wcm9wZXJ0eVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRDaGFuZ2VEaXNjbGFpbWVycygpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuY2hhbmdlLmVtaXQodGhpcy5kaXNjbGFpbWVycyk7XG4gICAgfSk7XG4gICAgdGhpcy5wcmV2aW91c0Rpc2NsYWltZXJzID0gWy4uLnRoaXMuX2Rpc2NsYWltZXJzXTtcbiAgfVxufVxuIl19