import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
import { poHttpInterceptorLiterals } from './po-http-interceptor-literals';
const NO_ERROR_HEADER_PARAM = 'X-PO-No-Error';
const NO_MESSAGE_HEADER_PARAM = 'X-PO-No-Message';
/**
 * @description
 *
 * O *interceptor* tem a finalidade de exibir notificações com mensagens na tela, baseado nas respostas das requisições HTTP.
 *
 * Pode ser utilizado para dar feedback das ações do usuário como, por exemplo: erro de autorização, mensagens de regras de negócio,
 * atualizações de registros, erro quando o servidor estiver indisponível e entre outros.
 *
 * ## Configuração
 *
 * Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o `BrowserAnimationsModule` no
 * módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@po-ui/ng-components';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * ## Como usar
 *
 * Para exibir as noticações é necessário informar a mensagem no retorno da requisição. A estrutura da mensagem
 * é feita com base no status da resposta, conforme será apresentado nos próximos tópicos.
 *
 * ### Estrutura das mensagens
 *
 * #### Mensagens de sucesso `2xx`
 *
 * Para exibir mensagens ao retornar uma lista ou um item, deve-se incluir a propriedade `_messages` no objeto de retorno.
 * Por exemplo:
 * ```
 * {
 *   "_messages": [
 *     {
 *       "type": "success" || "warning" || "error" || "information" (será exibido a `tag` apenas se esta propriedade possuir valor),
 *       "code": "título ou código da mensagem",
 *       "message": "texto da mensagem",
 *       "detailedMessage": "detalhamento da mensagem"
 *     }
 *   ]
 * }
 * ```
 *
 * #### Mensagens de erro `4xx` ou `5xx`
 *
 * Ao retornar erro, o objeto não necessita ter `_messages`, deve-se retornar o objeto diretamente:
 *
 * ```
 * {
 *    "code": "título ou código da mensagem",
 *    "message": "texto da mensagem",
 *    "detailedMessage": "detalhamento da mensagem"
 * }
 * ```
 *
 * Também é possível informar as seguintes propriedades:
 *
 * - `helpUrl`: link para a documentação do erro;
 *    - Caso for informado, será exibido uma ação de "Ajuda" na notificação, para isso não deverá ter a propriedade `detailedMessage`.
 * - `type`: É possível informar `error`, `warning` e `information`, sendo `error` o valor padrão.
 * - `details`: Uma lista de objetos de mensagem (recursiva) com mais detalhes sobre a mensagem principal.
 * - `detailTitle`: caso for informado, será apresentado como título dos detalhes substituindo o padrão `code - message`
 *
 * > Veja o [Guia de implementação de APIs](guides/api) para mais detalhes sobre a estrutura das mensagens.
 *
 * ### Cabeçalho
 *
 * É possível dispensar a notificação para o usuário utilizando no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-PO-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - `X-PO-No-Error`: Não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * > Após a validação no *interceptor*, os parâmetros serão removidos do cabeçalho da requisição.
 *
 */
export class PoHttpInterceptorBaseService {
    constructor(componentInjector, notification, languageService) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.languageService = languageService;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
        this.literals = poHttpInterceptorLiterals[this.languageService.getShortLanguage()];
        this.httpInterceptorDetailComponent = undefined;
    }
    intercept(request, next) {
        const cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response, cloneRequest);
            }
        }, (error) => {
            this.processErrorResponse(error, cloneRequest);
        }));
    }
    processResponse(response, request) {
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((message) => {
                    this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    processErrorResponse(response, request) {
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: this.literals.serverNotResponse, detailedMessage: response.message };
        const hasNoErrorParam = this.hasNoErrorParam(request);
        const hasNoMessageParam = this.hasNoMessageParam(request);
        const errorResponseValidTypes = this.notificationTypes.slice(1);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification(Object.assign(Object.assign({}, errorResponse), { type: errorResponseValidTypes.includes(errorResponse.type) ? errorResponse.type : 'error' }));
        }
    }
    cloneRequestWithoutParameters(request) {
        const headers = request.headers.delete(NO_ERROR_HEADER_PARAM).delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers });
    }
    createModal(responseMessage) {
        const details = responseMessage.details ? [responseMessage, ...responseMessage.details] : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(() => this.destroyModal());
        this.httpInterceptorDetailComponent.instance.open();
    }
    destroyModal() {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    }
    hasMessage(responseMessage) {
        const hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    }
    hasNoErrorParam(request) {
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    hasNoMessageParam(request) {
        const noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    }
    hasParameters(request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    }
    showNotification(response) {
        if (!this.hasMessage(response)) {
            return;
        }
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    generateDetailModal(responseMessage) {
        return () => {
            if (!this.httpInterceptorDetailComponent) {
                this.createModal(responseMessage);
            }
        };
    }
    generateNotificationAction(responseMessage) {
        let notificationAction;
        let notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = this.literals.help;
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = this.literals.details;
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    generateUrlHelpFunction(helpUrl) {
        return () => {
            window.open(helpUrl, '_blank');
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2ludGVyY2VwdG9ycy9wby1odHRwLWludGVyY2VwdG9yL3BvLWh0dHAtaW50ZXJjZXB0b3ItYmFzZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFJTCxZQUFZLEVBR2IsTUFBTSxzQkFBc0IsQ0FBQztBQUc5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sbUVBQW1FLENBQUM7QUFDckgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFHM0UsTUFBTSxxQkFBcUIsR0FBRyxlQUFlLENBQUM7QUFDOUMsTUFBTSx1QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztBQUVsRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBOEhHO0FBQ0gsTUFBTSxPQUFnQiw0QkFBNEI7SUFPaEQsWUFDVSxpQkFBNkMsRUFDN0MsWUFBaUIsRUFDakIsZUFBa0M7UUFGbEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE0QjtRQUM3QyxpQkFBWSxHQUFaLFlBQVksQ0FBSztRQUNqQixvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUFUNUMsc0JBQWlCLEdBQUcsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUVuRSxhQUFRLEdBQUcseUJBQXlCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFFdEUsbUNBQThC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LGVBQWUsQ0FBQyxDQUFDO2FBQ25DO1FBQ0gsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVPLDBCQUEwQixDQUFDLGVBQW9CO1FBQ3JELElBQUksa0JBQWtCLENBQUM7UUFDdkIsSUFBSSxpQkFBaUIsQ0FBQztRQUV0QixJQUFJLGVBQWUsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxlQUFlLElBQUksZUFBZSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzVGLGlCQUFpQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ3ZDLGtCQUFrQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUU7YUFBTSxJQUFJLGVBQWUsQ0FBQyxlQUFlLElBQUksZUFBZSxDQUFDLE9BQU8sRUFBRTtZQUNyRSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztZQUMxQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDaEU7UUFDRCxPQUFPLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxDQUFDO0lBQ2xFLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxPQUFlO1FBQzdDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIdHRwSW50ZXJjZXB0b3IsXG4gIEh0dHBIYW5kbGVyLFxuICBIdHRwUmVxdWVzdCxcbiAgSHR0cFJlc3BvbnNlLFxuICBIdHRwRXZlbnQsXG4gIEh0dHBFcnJvclJlc3BvbnNlXG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbXBvbmVudC1pbmplY3Rvci9wby1jb21wb25lbnQtaW5qZWN0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCB9IGZyb20gJy4vcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwvcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50IH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgcG9IdHRwSW50ZXJjZXB0b3JMaXRlcmFscyB9IGZyb20gJy4vcG8taHR0cC1pbnRlcmNlcHRvci1saXRlcmFscyc7XG5pbXBvcnQgeyBQb0xhbmd1YWdlU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWxhbmd1YWdlL3BvLWxhbmd1YWdlLnNlcnZpY2UnO1xuXG5jb25zdCBOT19FUlJPUl9IRUFERVJfUEFSQU0gPSAnWC1QTy1Oby1FcnJvcic7XG5jb25zdCBOT19NRVNTQUdFX0hFQURFUl9QQVJBTSA9ICdYLVBPLU5vLU1lc3NhZ2UnO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gKmludGVyY2VwdG9yKiB0ZW0gYSBmaW5hbGlkYWRlIGRlIGV4aWJpciBub3RpZmljYcOnw7VlcyBjb20gbWVuc2FnZW5zIG5hIHRlbGEsIGJhc2VhZG8gbmFzIHJlc3Bvc3RhcyBkYXMgcmVxdWlzacOnw7VlcyBIVFRQLlxuICpcbiAqIFBvZGUgc2VyIHV0aWxpemFkbyBwYXJhIGRhciBmZWVkYmFjayBkYXMgYcOnw7VlcyBkbyB1c3XDoXJpbyBjb21vLCBwb3IgZXhlbXBsbzogZXJybyBkZSBhdXRvcml6YcOnw6NvLCBtZW5zYWdlbnMgZGUgcmVncmFzIGRlIG5lZ8OzY2lvLFxuICogYXR1YWxpemHDp8O1ZXMgZGUgcmVnaXN0cm9zLCBlcnJvIHF1YW5kbyBvIHNlcnZpZG9yIGVzdGl2ZXIgaW5kaXNwb27DrXZlbCBlIGVudHJlIG91dHJvcy5cbiAqXG4gKiAjIyBDb25maWd1cmHDp8Ojb1xuICpcbiAqIFBhcmEgbyBjb3JyZXRvIGZ1bmNpb25hbWVudG8gZG8gaW50ZXJjZXB0b3IgYHBvLWh0dHAtaW50ZXJjZXB0b3JgLCBkZXZlIHNlciBpbXBvcnRhZG8gbyBgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGVgIG5vXG4gKiBtw7NkdWxvIHByaW5jaXBhbCBkYSBzdWEgYXBsaWNhw6fDo28uXG4gKlxuICogTcOzZHVsbyBkYSBhcGxpY2HDp8OjbzpcbiAqIGBgYFxuICogaW1wb3J0IHsgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyL2FuaW1hdGlvbnMnO1xuICogaW1wb3J0IHsgUG9Nb2R1bGUgfSBmcm9tICdAcG8tdWkvbmctY29tcG9uZW50cyc7XG4gKiAuLi5cbiAqXG4gKiBATmdNb2R1bGUoe1xuICogICBpbXBvcnRzOiBbXG4gKiAgICAgQnJvd3Nlck1vZHVsZSxcbiAqICAgICBCcm93c2VyQW5pbWF0aW9uc01vZHVsZSxcbiAqICAgICAuLi5cbiAqICAgICBQb01vZHVsZVxuICogICBdLFxuICogICBkZWNsYXJhdGlvbnM6IFtcbiAqICAgICBBcHBDb21wb25lbnQsXG4gKiAgICAgLi4uXG4gKiAgIF0sXG4gKiAgIHByb3ZpZGVyczogW10sXG4gKiAgIGJvb3RzdHJhcDogW0FwcENvbXBvbmVudF1cbiAqIH0pXG4gKiBleHBvcnQgY2xhc3MgQXBwTW9kdWxlIHsgfVxuICogYGBgXG4gKlxuICogQW8gaW1wb3J0YXIgbyBtw7NkdWxvIGBQb01vZHVsZWAgbmEgYXBsaWNhw6fDo28sIG8gYHBvLWh0dHAtaW50ZXJjZXB0b3JgIMOpIGF1dG9tYXRpY2FtZW50ZSBjb25maWd1cmFkbyBzZW0gYSBuZWNlc3NpZGFkZVxuICogZGUgcXVhbHF1ZXIgY29uZmlndXJhw6fDo28gZXh0cmEuXG4gKlxuICogQW8gcmVhbGl6YXIgcmVxdWlzacOnw7VlcyB1dGlsaXplIG8gYEh0dHBDbGllbnRgLCBjb25mb3JtZSBleGVtcGxvIGFiYWl4bzpcbiAqXG4gKiBgYGBcbiAqIGltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG4gKlxuICogLi4uXG4gKlxuICogQEluamVjdGFibGUoKVxuICogZXhwb3J0IGNsYXNzIFVzZXJTZXJ2aWNlIHtcbiAqXG4gKiAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkgeyB9XG4gKlxuICogICBnZXRVc2VycygpIHtcbiAqICAgICByZXR1cm4gdGhpcy5odHRwLmdldCgnL2FwaS91c2VycycpO1xuICogICB9XG4gKlxuICogICAuLi5cbiAqXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiAjIyBDb21vIHVzYXJcbiAqXG4gKiBQYXJhIGV4aWJpciBhcyBub3RpY2HDp8O1ZXMgw6kgbmVjZXNzw6FyaW8gaW5mb3JtYXIgYSBtZW5zYWdlbSBubyByZXRvcm5vIGRhIHJlcXVpc2nDp8Ojby4gQSBlc3RydXR1cmEgZGEgbWVuc2FnZW1cbiAqIMOpIGZlaXRhIGNvbSBiYXNlIG5vIHN0YXR1cyBkYSByZXNwb3N0YSwgY29uZm9ybWUgc2Vyw6EgYXByZXNlbnRhZG8gbm9zIHByw7N4aW1vcyB0w7NwaWNvcy5cbiAqXG4gKiAjIyMgRXN0cnV0dXJhIGRhcyBtZW5zYWdlbnNcbiAqXG4gKiAjIyMjIE1lbnNhZ2VucyBkZSBzdWNlc3NvIGAyeHhgXG4gKlxuICogUGFyYSBleGliaXIgbWVuc2FnZW5zIGFvIHJldG9ybmFyIHVtYSBsaXN0YSBvdSB1bSBpdGVtLCBkZXZlLXNlIGluY2x1aXIgYSBwcm9wcmllZGFkZSBgX21lc3NhZ2VzYCBubyBvYmpldG8gZGUgcmV0b3Juby5cbiAqIFBvciBleGVtcGxvOlxuICogYGBgXG4gKiB7XG4gKiAgIFwiX21lc3NhZ2VzXCI6IFtcbiAqICAgICB7XG4gKiAgICAgICBcInR5cGVcIjogXCJzdWNjZXNzXCIgfHwgXCJ3YXJuaW5nXCIgfHwgXCJlcnJvclwiIHx8IFwiaW5mb3JtYXRpb25cIiAoc2Vyw6EgZXhpYmlkbyBhIGB0YWdgIGFwZW5hcyBzZSBlc3RhIHByb3ByaWVkYWRlIHBvc3N1aXIgdmFsb3IpLFxuICogICAgICAgXCJjb2RlXCI6IFwidMOtdHVsbyBvdSBjw7NkaWdvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICAgICBcIm1lc3NhZ2VcIjogXCJ0ZXh0byBkYSBtZW5zYWdlbVwiLFxuICogICAgICAgXCJkZXRhaWxlZE1lc3NhZ2VcIjogXCJkZXRhbGhhbWVudG8gZGEgbWVuc2FnZW1cIlxuICogICAgIH1cbiAqICAgXVxuICogfVxuICogYGBgXG4gKlxuICogIyMjIyBNZW5zYWdlbnMgZGUgZXJybyBgNHh4YCBvdSBgNXh4YFxuICpcbiAqIEFvIHJldG9ybmFyIGVycm8sIG8gb2JqZXRvIG7Do28gbmVjZXNzaXRhIHRlciBgX21lc3NhZ2VzYCwgZGV2ZS1zZSByZXRvcm5hciBvIG9iamV0byBkaXJldGFtZW50ZTpcbiAqXG4gKiBgYGBcbiAqIHtcbiAqICAgIFwiY29kZVwiOiBcInTDrXR1bG8gb3UgY8OzZGlnbyBkYSBtZW5zYWdlbVwiLFxuICogICAgXCJtZXNzYWdlXCI6IFwidGV4dG8gZGEgbWVuc2FnZW1cIixcbiAqICAgIFwiZGV0YWlsZWRNZXNzYWdlXCI6IFwiZGV0YWxoYW1lbnRvIGRhIG1lbnNhZ2VtXCJcbiAqIH1cbiAqIGBgYFxuICpcbiAqIFRhbWLDqW0gw6kgcG9zc8OtdmVsIGluZm9ybWFyIGFzIHNlZ3VpbnRlcyBwcm9wcmllZGFkZXM6XG4gKlxuICogLSBgaGVscFVybGA6IGxpbmsgcGFyYSBhIGRvY3VtZW50YcOnw6NvIGRvIGVycm87XG4gKiAgICAtIENhc28gZm9yIGluZm9ybWFkbywgc2Vyw6EgZXhpYmlkbyB1bWEgYcOnw6NvIGRlIFwiQWp1ZGFcIiBuYSBub3RpZmljYcOnw6NvLCBwYXJhIGlzc28gbsOjbyBkZXZlcsOhIHRlciBhIHByb3ByaWVkYWRlIGBkZXRhaWxlZE1lc3NhZ2VgLlxuICogLSBgdHlwZWA6IMOJIHBvc3PDrXZlbCBpbmZvcm1hciBgZXJyb3JgLCBgd2FybmluZ2AgZSBgaW5mb3JtYXRpb25gLCBzZW5kbyBgZXJyb3JgIG8gdmFsb3IgcGFkcsOjby5cbiAqIC0gYGRldGFpbHNgOiBVbWEgbGlzdGEgZGUgb2JqZXRvcyBkZSBtZW5zYWdlbSAocmVjdXJzaXZhKSBjb20gbWFpcyBkZXRhbGhlcyBzb2JyZSBhIG1lbnNhZ2VtIHByaW5jaXBhbC5cbiAqIC0gYGRldGFpbFRpdGxlYDogY2FzbyBmb3IgaW5mb3JtYWRvLCBzZXLDoSBhcHJlc2VudGFkbyBjb21vIHTDrXR1bG8gZG9zIGRldGFsaGVzIHN1YnN0aXR1aW5kbyBvIHBhZHLDo28gYGNvZGUgLSBtZXNzYWdlYFxuICpcbiAqID4gVmVqYSBvIFtHdWlhIGRlIGltcGxlbWVudGHDp8OjbyBkZSBBUElzXShndWlkZXMvYXBpKSBwYXJhIG1haXMgZGV0YWxoZXMgc29icmUgYSBlc3RydXR1cmEgZGFzIG1lbnNhZ2Vucy5cbiAqXG4gKiAjIyMgQ2FiZcOnYWxob1xuICpcbiAqIMOJIHBvc3PDrXZlbCBkaXNwZW5zYXIgYSBub3RpZmljYcOnw6NvIHBhcmEgbyB1c3XDoXJpbyB1dGlsaXphbmRvIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIG9zIHBhcsOibWV0cm9zIGxpc3RhZG9zIGFiYWl4byBjb20gbyB2YWxvclxuICogaWd1YWwgYSBgdHJ1ZWA6XG4gKlxuICogLSBgWC1QTy1Oby1NZXNzYWdlYDogTsOjbyBleGliZSBub3RpZmljYcOnw7VlcyBkZSBlcnJvIGUvb3Ugc3VjZXNzby5cbiAqXG4gKiAtIGBYLVBPLU5vLUVycm9yYDogTsOjbyBtb3N0cmEgbm90aWZpY2HDp8O1ZXMgZGUgZXJybyBjb20gY8OzZGlnb3MgYDR4eGAgZSBgNXh4YC5cbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBPLU5vLU1lc3NhZ2UnOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKlxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vICppbnRlcmNlcHRvciosIG9zIHBhcsOibWV0cm9zIHNlcsOjbyByZW1vdmlkb3MgZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gKlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUG9IdHRwSW50ZXJjZXB0b3JCYXNlU2VydmljZSBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gIG5vdGlmaWNhdGlvblR5cGVzID0gWydzdWNjZXNzJywgJ3dhcm5pbmcnLCAnZXJyb3InLCAnaW5mb3JtYXRpb24nXTtcblxuICBsaXRlcmFscyA9IHBvSHR0cEludGVyY2VwdG9yTGl0ZXJhbHNbdGhpcy5sYW5ndWFnZVNlcnZpY2UuZ2V0U2hvcnRMYW5ndWFnZSgpXTtcblxuICBwcml2YXRlIGh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudDogQ29tcG9uZW50UmVmPFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50PiA9IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbXBvbmVudEluamVjdG9yOiBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSxcbiAgICBwcml2YXRlIG5vdGlmaWNhdGlvbjogYW55LFxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZVxuICApIHt9XG5cbiAgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGNvbnN0IGNsb25lUmVxdWVzdCA9IHJlcXVlc3QuY2xvbmUoKTtcblxuICAgIHJlcXVlc3QgPSByZXF1ZXN0ICYmIHRoaXMuaGFzUGFyYW1ldGVycyhyZXF1ZXN0KSA/IHRoaXMuY2xvbmVSZXF1ZXN0V2l0aG91dFBhcmFtZXRlcnMocmVxdWVzdCkgOiByZXF1ZXN0O1xuXG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKHJlcXVlc3QpLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgIChyZXNwb25zZTogSHR0cEV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlLCBjbG9uZVJlcXVlc3QpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHRoaXMucHJvY2Vzc0Vycm9yUmVzcG9uc2UoZXJyb3IsIGNsb25lUmVxdWVzdCk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJvY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlOiBIdHRwUmVzcG9uc2U8YW55PiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGNvbnN0IGhhc05vTWVzc2FnZVBhcmFtID0gdGhpcy5oYXNOb01lc3NhZ2VQYXJhbShyZXF1ZXN0KTtcblxuICAgIGlmICghaGFzTm9NZXNzYWdlUGFyYW0gJiYgcmVzcG9uc2UuYm9keSAmJiByZXNwb25zZS5ib2R5Ll9tZXNzYWdlcykge1xuICAgICAgY29uc3QgbWVzc2FnZXMgPSByZXNwb25zZS5ib2R5Ll9tZXNzYWdlcztcblxuICAgICAgaWYgKG1lc3NhZ2VzIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgbWVzc2FnZXMuZm9yRWFjaCgobWVzc2FnZTogUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwpID0+IHtcbiAgICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24obWVzc2FnZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm9jZXNzRXJyb3JSZXNwb25zZShyZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UsIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBlcnJvclJlc3BvbnNlID1cbiAgICAgIHJlc3BvbnNlLnN0YXR1cyAhPT0gMFxuICAgICAgICA/IHJlc3BvbnNlLmVycm9yXG4gICAgICAgIDogeyBjb2RlOiAwLCBtZXNzYWdlOiB0aGlzLmxpdGVyYWxzLnNlcnZlck5vdFJlc3BvbnNlLCBkZXRhaWxlZE1lc3NhZ2U6IHJlc3BvbnNlLm1lc3NhZ2UgfTtcblxuICAgIGNvbnN0IGhhc05vRXJyb3JQYXJhbSA9IHRoaXMuaGFzTm9FcnJvclBhcmFtKHJlcXVlc3QpO1xuICAgIGNvbnN0IGhhc05vTWVzc2FnZVBhcmFtID0gdGhpcy5oYXNOb01lc3NhZ2VQYXJhbShyZXF1ZXN0KTtcbiAgICBjb25zdCBlcnJvclJlc3BvbnNlVmFsaWRUeXBlcyA9IHRoaXMubm90aWZpY2F0aW9uVHlwZXMuc2xpY2UoMSk7XG5cbiAgICBpZiAoZXJyb3JSZXNwb25zZSAmJiBlcnJvclJlc3BvbnNlLm1lc3NhZ2UgJiYgIWhhc05vRXJyb3JQYXJhbSAmJiAhaGFzTm9NZXNzYWdlUGFyYW0pIHtcbiAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7XG4gICAgICAgIC4uLmVycm9yUmVzcG9uc2UsXG4gICAgICAgIHR5cGU6IGVycm9yUmVzcG9uc2VWYWxpZFR5cGVzLmluY2x1ZGVzKGVycm9yUmVzcG9uc2UudHlwZSkgPyBlcnJvclJlc3BvbnNlLnR5cGUgOiAnZXJyb3InXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNsb25lUmVxdWVzdFdpdGhvdXRQYXJhbWV0ZXJzKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBIdHRwUmVxdWVzdDxhbnk+IHtcbiAgICBjb25zdCBoZWFkZXJzID0gcmVxdWVzdC5oZWFkZXJzLmRlbGV0ZShOT19FUlJPUl9IRUFERVJfUEFSQU0pLmRlbGV0ZShOT19NRVNTQUdFX0hFQURFUl9QQVJBTSk7XG5cbiAgICByZXR1cm4gcmVxdWVzdC5jbG9uZSh7IGhlYWRlcnMgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU1vZGFsKHJlc3BvbnNlTWVzc2FnZTogUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwpIHtcbiAgICBjb25zdCBkZXRhaWxzID0gcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMgPyBbcmVzcG9uc2VNZXNzYWdlLCAuLi5yZXNwb25zZU1lc3NhZ2UuZGV0YWlsc10gOiBbcmVzcG9uc2VNZXNzYWdlXTtcblxuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50ID0gdGhpcy5jb21wb25lbnRJbmplY3Rvci5jcmVhdGVDb21wb25lbnRJbkFwcGxpY2F0aW9uKFxuICAgICAgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnRcbiAgICApO1xuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLmRldGFpbCA9IGRldGFpbHM7XG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2UuY2xvc2VkLnN1YnNjcmliZSgoKSA9PiB0aGlzLmRlc3Ryb3lNb2RhbCgpKTtcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5vcGVuKCk7XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lNb2RhbCgpIHtcbiAgICBpZiAodGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQpIHtcbiAgICAgIHRoaXMuY29tcG9uZW50SW5qZWN0b3IuZGVzdHJveUNvbXBvbmVudEluQXBwbGljYXRpb24odGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQpO1xuICAgICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNNZXNzYWdlKHJlc3BvbnNlTWVzc2FnZTogUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwpIHtcbiAgICBjb25zdCBoYXNNZXNzYWdlUHJvcGVydGllcyA9IHJlc3BvbnNlTWVzc2FnZS5tZXNzYWdlO1xuXG4gICAgcmV0dXJuIHJlc3BvbnNlTWVzc2FnZSAmJiBoYXNNZXNzYWdlUHJvcGVydGllcztcbiAgfVxuXG4gIHByaXZhdGUgaGFzTm9FcnJvclBhcmFtKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcbiAgICBjb25zdCBub0Vycm9yUGFyYW0gPSByZXF1ZXN0ICYmIHJlcXVlc3QuaGVhZGVycy5nZXQoTk9fRVJST1JfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiBub0Vycm9yUGFyYW0gJiYgbm9FcnJvclBhcmFtLnRvU3RyaW5nKCkudG9Mb2NhbGVMb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNOb01lc3NhZ2VQYXJhbShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgbm9NZXNzYWdlUGFyYW0gPSByZXF1ZXN0ICYmIHJlcXVlc3QuaGVhZGVycy5nZXQoTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0pO1xuXG4gICAgcmV0dXJuIG5vTWVzc2FnZVBhcmFtICYmIG5vTWVzc2FnZVBhcmFtLnRvU3RyaW5nKCkudG9Mb2NhbGVMb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNQYXJhbWV0ZXJzKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICByZXR1cm4gcmVxdWVzdC5oZWFkZXJzLmhhcyhOT19FUlJPUl9IRUFERVJfUEFSQU0pIHx8IHJlcXVlc3QuaGVhZGVycy5oYXMoTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93Tm90aWZpY2F0aW9uKHJlc3BvbnNlOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMuaGFzTWVzc2FnZShyZXNwb25zZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB0eXBlTm90aWZpY2F0aW9uID0gdGhpcy5ub3RpZmljYXRpb25UeXBlcy5pbmNsdWRlcyhyZXNwb25zZS50eXBlKSA/IHJlc3BvbnNlLnR5cGUgOiAnaW5mb3JtYXRpb24nO1xuXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZU5vdGlmaWNhdGlvbkFjdGlvbihyZXNwb25zZSk7XG5cbiAgICB0aGlzLm5vdGlmaWNhdGlvblt0eXBlTm90aWZpY2F0aW9uXSh7XG4gICAgICBtZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlLFxuICAgICAgYWN0aW9uTGFiZWw6IG5vdGlmaWNhdGlvbkFjdGlvbi5sYWJlbCxcbiAgICAgIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uLmFjdGlvblxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZURldGFpbE1vZGFsKHJlc3BvbnNlTWVzc2FnZTogYW55KSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmICghdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5jcmVhdGVNb2RhbChyZXNwb25zZU1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlTm90aWZpY2F0aW9uQWN0aW9uKHJlc3BvbnNlTWVzc2FnZTogYW55KSB7XG4gICAgbGV0IG5vdGlmaWNhdGlvbkFjdGlvbjtcbiAgICBsZXQgbm90aWZpY2F0aW9uTGFiZWw7XG5cbiAgICBpZiAocmVzcG9uc2VNZXNzYWdlLmhlbHBVcmwgJiYgIShyZXNwb25zZU1lc3NhZ2UuZGV0YWlsZWRNZXNzYWdlIHx8IHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxzKSkge1xuICAgICAgbm90aWZpY2F0aW9uTGFiZWwgPSB0aGlzLmxpdGVyYWxzLmhlbHA7XG4gICAgICBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKHJlc3BvbnNlTWVzc2FnZS5oZWxwVXJsKTtcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxlZE1lc3NhZ2UgfHwgcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gdGhpcy5saXRlcmFscy5kZXRhaWxzO1xuICAgICAgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZURldGFpbE1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XG4gICAgfVxuICAgIHJldHVybiB7IGxhYmVsOiBub3RpZmljYXRpb25MYWJlbCwgYWN0aW9uOiBub3RpZmljYXRpb25BY3Rpb24gfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24oaGVscFVybDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHdpbmRvdy5vcGVuKGhlbHBVcmwsICdfYmxhbmsnKTtcbiAgICB9O1xuICB9XG59XG4iXX0=